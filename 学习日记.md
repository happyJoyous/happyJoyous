## js学习网站

### (https://zh.javascript.info/)现代JavaScript教程

* 给后端传入数据时对象里是可以包裹boolean的数值

* ```vue
    //获取当前路由的协议与域名
    const targetUrl = computed(
      () => `${location.protocol}//${location.hostname}${import.meta.env.VITE_CHEMICAL_FORMULA_PORT}#${UID.value}`
    )
  ```

* VSCode前端编辑器中依然可以打红点进行监听，左边小虫三角标示有运行和调试，改一下本地端口地址就能调试

运行打包程序到远程

### 好玩的网站

通义万象官网：https://tongyi.aliyun.com/wanxiang (用于生成描述性网页或图片)

vscode 人工智能插件CodeGeeX帮助辅助开发

取色软件Snipastex

vite使用svg图标封装：https://blog.csdn.net/weixin_43288600/article/details/130586827



### linux服务器命令

```js
E:\systemFaqProject\computerized-system-faq-web>scp ./dist.zip root@192.168.0.4:/data/bmyeln/webapp/faqvue
<!------------------------------------推动到远端---------------------------->
E:\systemFaqProject\computerized-system-faq-web>scp ./dist.zip root@192.168.0.4:/data/bmyeln/webapp/faqvue
The authenticity of host '192.168.0.4 (192.168.0.4)' can't be established.
ECDSA key fingerprint is SHA256:lKMr/kp15Js12OE7/goNQhSAA+t/qcQO+JPWY31jbQo.
Are you sure you want to continue connecting (yes/no/[fingerprint])?
Please type 'yes', 'no' or the fingerprint:
Warning: Permanently added '192.168.0.4' (ECDSA) to the list of known hosts.
root@192.168.0.4's password:
Permission denied, please try again.
root@192.168.0.4's password:
dist.zip
```



### html不换行问题

1. 可能因为输入一个纯英文，这会引起html内部识别成为一个单词，单词是不会换行;（可以使用css属性设置换行）

# day01

* 配置环境

* 下载所需要的git

* 下载node

* 拉项目包

* 熟悉项目查看项目里面介绍须知

* 下载依赖，运行项目查看

* 有测试版，有本地版运行

* 各个部门交界流程分析：

* ```js
  发布工具：
  http://192.168.1.253:6688/view/ELabnote-Dev-254/
  254测试环境
  http://192.168.1.254:9999/login   
  00001   bmy123456
  253测试环境
  http://192.168.1.254:9999/login 
  
  发布工具密码：(提交给测试)：
  developer/developer
  原理：把写好的功能需求，分支上传给仓库，发布时会拉区对应分支的远程仓库，然后发送给测试人员
  
  ```

  ```js
  禅道地址：
  http://192.168.1.254:1949/company-browse.html
  密码
  liuyujie  / liuyujie123
  
  发送测试人员测试的bug，在禅道上项目里面指向你，改出bug 重新提交
  
  ```

  ```js
  https://www.figma.com/   用自己邮箱注册下
  
  介绍：查看所需的UI设计
  ```

* 学习课程

  ```
  Vue3 + TS + Pinia + vue-router4 + setup + arco
  
  Vue3:
  TS:
  Pinia: 用来代替vuex ，使用更为简便
  setup: 组合式api
  arco： 字节跳动新的开源组件库文件
  ```

  

## vscode

* koroFileHeade插件可以先禁止，然后选择工作区启动，这样只有当前项目可以是使用这个模式
* ![image-20220810092626127](实习总结\image\image-20220810092626127.png)

 git 本地文件中配置 config文件配置: EditorConfig for VS Code插件

```
[core]
	repositoryformatversion = 0
	filemode = false
	bare = false
	logallrefupdates = true
	symlinks = false
	ignorecase = true
	hooksPath = .husky
	autocrlf=false    //配置换行
[remote "origin"]
	url = http://192.168.1.254/elabnote_group/elabnote-front-main.git
	fetch = +refs/heads/*:refs/remotes/origin/*
[branch "master"]
	remote = origin
	merge = refs/heads/master
[branch "dev"]
	remote = origin
	merge = refs/heads/dev
[branch "feta-0823"]
	remote = origin
	merge = refs/heads/feta-0823

```

## CSS渲染

* 在块级中的文字，图片，行内块元素都是可以混在一起，拥有同类性质
* display属性会引起浏览器重绘或重排，在使用时会导致代码块迁移，因此可以用visibility属性控制显隐

## 组件库里表格

使用组件库里表格左侧复选框时，要注意在赋值的时候先要进行数据data的赋值，然后才能进行row-id：key 的赋值操作，不然会报错



## vue官网

https://cn.vuejs.org/guide/typescript/composition-api.html#typing-component-props

### vue模板引用

**函数模板引用**

除了使用字符串值作名字，`ref` attribute 还可以绑定为一个函数，会在每次组件更新时都被调用。该函数会收到元素引用作为其第一个参数：

```
<input :ref="(el) => { /* 将 el 赋值给一个数据属性或 ref 变量 */ }">
```

注意我们这里需要使用动态的 `:ref` 绑定才能够传入一个函数。当绑定的元素被卸载时，函数也会被调用一次，此时的 `el` 参数会是 `null`。你当然也可以绑定一个组件方法而不是内联函数。

* **Vue.js里模板中不能私用window对象**
* Vue的模板被设计成了一个独立的环境,为了更好地控制模板的生命周期和作用域,**Vue.js禁止直接在模板中访问window对象**

## git



```js
提交前拉取一遍仓库
git pull

观看代码文档须知 注意提交规范
git commit -m "提交解决问题和代码功能"

用分支提交到远程仓库
git push origin

把最近一次的提交记录转移到feta-0530分支上去
记得提前在qiankuan分支上pull拉一下
git cherry-pick feta-0530

再git push 一下

注意: 如果少了 pull 这一步报错，但cherry正确了，但push的时候报错，需要使用
git reset 去git上获取最近一次提交密钥
目的返回上一步

再重新pull一下，在cherry一下，再push

git reflog  查看提交信息钥匙可以接受回退
git reset 2158a0a  回退到钥匙为2158a0a的命令

如果同一时间在提交到本地仓库忘记拉代码，但没有提交到远程仓库中
先reset 到冲突之前一步，把自己的先贮藏，在返回操作，再重新提交

<!-----创建分支并push到远程分支建立连接----->
创建一个连接到本地仓库commit的分支并切换到该分支上
git checkout -b tag-230311
远程分支push到远程分支上
git push origin tag-230311:tag-230311
切换到远程与现有仓库本地分支上建立连接
git branch --set-upstream-to=origin/tag-230311 tag-230311
<!-------------重复建立远程分支-------------->
创建本地分支feat-instrument并切换到分支上
git checkout -b feat-instrument
创建push到远程分支
git push origin feat-instrument:feat-instrument
使远程与本地分支建立连接
git branch --set-upstream-to=origin/feat-instrument feat-instrument
<!-------------简单的从另一个分支创建分支-------------->
首先在一个分支上创建一个分支
git checkout -b release_bams_0823
切换到这个分支，再直接进行本地分支push到远程，直接建立连接
git push --set-upstream origin release_bams_0823


查看仓库分支
git branch -vv

<!-------------本地分支退回到上次提交-------------->
退回到上次提交
git reset HEAD~1

//vscode
只要checkout后只需要点击推送就把链接执行到远端了，一键操作，方便


```

**提交风格:**

![o](实习总结\image\image-20220810092155896.png)

**常用的提交风格规范** 



**cherry-pick批量**(从后往前,从旧往新 )

^..开区间没有后面的闭,第一个不会被纳入

```git
git cherry-pick  2710a15527ea1bdd1c2f55745e45c9848af7fb80^..7982a0ecf4f8cacb184fa93797a3c8835b29bcc0
```

**用过：**

1. ui:  修改ui样式
2. chore:  变更构建流程或者辅助工具，(如更改测试环境)

**遇到给git问题**

1. 在转交分支提交代码时忘了拉取一下代码，使用chery提交；解决返回到上一步命令，重新拉去代码，再提交
2. 遇到主分支拉取提交报黄错误，是引文本地主分支有问题，把本地分支删除，重新拉去一下远程分支，然后再提交

未知：

1. 如果遇到git pull拉去不成功时，可以先git stash贮存一下，再进行拉去 



## ts使用

```ts
<!-----Pick表示取类型IQueryApproveManageDetailResData中的businessData与referenceType作为重铸类型-------->
Ref<Pick<IQueryApproveManageDetailResData, 'businessData' | 'referenceType'>>
```

## 服务返回code的数据

* 500 :表示已经访问到后端资源,但是后端报错
* 200: 成功
* 404: 找不到资源
* 405: 表示服务器方法报错,可能是get或post传递方式错了



# 封装的组件库(arco+ts)

**下拉列表框(SimpleFieldInfo)：**

![image-20220826000058153](实习总结\image\image-20220826000058153.png)

```js
<!--
 * @Author: zhangy
 * @Date: 2022-07-14 14:15:50
 * @LastEditors: zhangy
 * @LastEditTime: 2022-07-28 17:39:21
 * @FilePath: \elabnote-front-main\src\components\SimpleFieldInfo\index.vue
 * Copyright (c) 2022 by BMY, All Rights Reserved.
-->
<template>
  <a-collapse :default-active-key="['1']" :expand-icon-position="position" class="main-collapse">
    <a-collapse-item key="1">
      <template #header>
        <div @click.stop>
          <slot name="header"></slot>
        </div>
      </template>
      <template #extra>
        <div @click.stop>
          <slot name="extra"></slot>
        </div>
      </template>
      <a-list :bordered="false" :data="innerList">
        <template #item="{ item }">
          <div class="main-collapse-list-item">
            <div class="div">
              <a-input
                :placeholder="$t('components.SimpleFieldInfo.nametipInfo')"
                v-if="Props.isEdit"
                size="small"
                v-model="item._paramName"
              />
              <span v-else :title="item[paramName]">{{ item[paramName] }}</span>
            </div>
            <div class="div">
              <a-input
                :placeholder="$t('components.SimpleFieldInfo.valueTipInfo')"
                v-if="Props.isEdit"
                size="small"
                v-model="item._paramValue"
              />
              <!-- <span v-else :title="item[paramValue]">{{ item[paramValue] }}</span> -->
              <span v-else :title="item[paramValue]">{{
                handleShowDynamicParam({ type: item[paramType], value: item[paramValue] })
              }}</span>
            </div>
            <icon-delete v-if="isShowDelete" style="flex: 1" class="show-icon" @click="handleDelete(item)" />
          </div>
        </template>
      </a-list>
    </a-collapse-item>
  </a-collapse>
</template>

<script setup lang="ts">
  import { computed, ref, watch } from 'vue'
  import Message from '../Message'
  import i18n from '@/locale'
  import { getFrontIdById, handleShowDynamicParam } from '@/util'

  type ListObjAlias = {
    id: string
    paramName: string
    paramValue: string
    paramType: string
    _paramName?: string
    _paramValue?: string
    [key: string]: any
  }
  interface IProp {
    list: Array<ListObjAlias>
    isEdit?: boolean
    isSimple?: boolean
    position?: 'right' | 'left' | undefined
    listObjAlias?: ListObjAlias
  }
  const innerList = ref<Array<ListObjAlias>>([])
  const deletingFieldIds = ref<Array<string>>([])

  const Props = withDefaults(defineProps<IProp>(), {
    list: () => [],
    isEdit: false,
    isSimple: false,
    position: 'right',
    listObjAlias: () => ({
      id: 'id',
      paramName: 'paramName',
      paramValue: 'paramValue',
      paramType: 'paramType'
    })
  })

  const isShowDelete = computed(() => {
    return !Props.isSimple
  })

  const { listObjAlias } = Props
  const { id = 'id', paramName = 'paramName', paramValue = 'paramValue', paramType = 'paramType' } = listObjAlias

  const Emits = defineEmits(['deleteItem'])

  const updateList = computed(() => {
    return innerList.value.map((item) => {
      const targetItem = {
        ...item,
        [paramName]: item._paramName,
        [paramValue]: item._paramValue
      }
      delete targetItem._paramName
      delete targetItem._paramValue
      return targetItem
    })
  })

  /**
   * List Item 删除操作
   */
  const handleDelete = (item) => {
    if (Props.isEdit) {
      innerList.value = innerList.value.filter((i) => i[id] !== item[id])
      if (Number(item[id]) > 0) {
        deletingFieldIds.value.push(item[id])
      }
    } else {
      Emits('deleteItem', item)
    }
  }

  defineExpose({
    getList: (): { isSuccess: boolean; targetList: Array<ListObjAlias>; deletingFieldIds: Array<string> } => {
      const isFailure = updateList.value.some((item) => item[paramName] == '')
      if (isFailure) {
        Message({
          content: i18n.global.t('components.SimpleFieldInfo.warning'),
          duration: 2 * 1000,
          type: 'warning'
        })
      }
      return {
        isSuccess: !isFailure,
        targetList: updateList.value,
        deletingFieldIds: deletingFieldIds.value
      }
    },

    increment: () => {
      innerList.value.push({
        [id]: getFrontIdById(innerList.value[innerList.value.length - 1]?.[id]),
        [paramName]: '',
        [paramValue]: '',
        _paramName: '',
        _paramValue: ''
      } as ListObjAlias)
    },

    clear: () => {
      resetInnerList(Props.list)
    }
  })

  const resetInnerList = (list: Array<ListObjAlias>) => {
    innerList.value = list.map((item) => ({
      ...item,
      _paramName: item[paramName],
      _paramValue: item[paramValue]
    }))
  }

  watch(
    () => Props.list,
    (newList) => {
      resetInnerList(newList)
    },
    {
      immediate: true
    }
  )

  watch(
    () => Props.isEdit,
    (isEdit) => {
      if (!isEdit) {
        resetInnerList(Props.list)
      }
    }
  )
</script>

<style scoped lang="scss">
  .main-collapse {
    :deep(.arco-collapse-item-active > .arco-collapse-item-header) {
      background-color: var(--color-fill-1);
    }
    :deep(.arco-collapse-item-content) {
      background-color: var(--color-bg-2);
      padding-left: 13px;
    }
    .main-collapse-list-item {
      padding: 8px;
      display: flex;
      align-items: center;
      .show-icon {
        display: none;
      }
      &:hover {
        background-color: $hoverColor;
        cursor: pointer;
        .show-icon {
          display: block;
        }
      }
      .div {
        width: 45%;
        padding: 0 8px;
        text-overflow: ellipsis;
        overflow: hidden;
      }
    }
  }
</style>

```

使用：getProductList是传入列表数据s

```js
<SimpleFieldInfo
      :isSimple="true"
      v-model:list="getProductList"
      :listObjAlias="{ paramValue: 'paramValues' }"
      v-if="productFlag"
    >
      <template #header>
        <a-space>
          <span>{{ `${nodeInfo.name}信息` }}</span>
        </a-space>
      </template>
    </SimpleFieldInfo>
```

# 导出报表接口展示

```js
/**
 * 导出报表接口
 */
export const reservationExport = () => {
  return materialRequest.post({
    url: `/material/equipment/reservation/export`,
    responseType: 'blob' //不添加文件就会解析失败
  })
}

```



# day02

在vue3中ref首先搜索一边组件内有无名字有就拿取，没有就创建一个新的ref对象赋值给变量



BasicTable这个封装的列表组件工具，封装可以根据列表的插槽名定位到列表数据

**练练手：**

**简单给查询视图 ——> 研发 ——>返库功能，返现注册&批次信息：**

**注：**并没有可以看到内在**

![image-20220808193030240](实习总结\image\image-20220808193030240.png)

```js
  import { handleShowDynamicParam } from '@/util'
//这个函数是改字体格式的函数，时间和文字的格式time-1====》time/1
handleShowDynamicParam({ type: ParameterType.MOMENT, value: item.record.expectRecallDate })
```



# day03

简单完成业务逻辑给 注册搜索 ——> 查询视图 个人 ——> 007模块

列表停留在库存信息的hover 上，需要hover停留

![image-20220809135845968](实习总结\image\image-20220809135845968.png)

 **debounce() 这个函数是防抖函数**

```

```

解决思路：找到所关联的变量，判断条件是否异步进行获得，变量可以自己进行判断，所以只需要设置方法定义一个flag改变变量的值，

**注意：**列表进行依次渲染时判断条件是循环判断的，所以要用判断条件来选择是否属于，不能用单纯的变量封装



**老项目解决小问题**

1. 提醒规则:每周提醒，需要可以全部清楚

![image-20220809165259259](C:\Users\Admin\Desktop\笔记管理\实习总结\image\image-20220809165259259.png)

```

```

添加一个allowClear = "true" 属性

改四处，因为代码没有复用



2. 提醒规则，提醒规则弹框，点击弹框外的部分，不要关闭

   

![image-20220809171009127](C:\Users\Admin\Desktop\笔记管理\实习总结\image\image-20220809171009127.png)

```

```

添加一个maskClosable 属性值设置为false



3. 提醒规则  返库超期允许天数为0，

   找到组件里的

   ```html
   <a-input-number v-model="detailFormInfo.rule.offsetDays" :min="0" />
   ```

   :min = "0"



4. 提醒规则  提醒对象，批次未完全隐藏

   找到提醒对象的下拉列表，找到渲染数据RemindObjectEnum的变量，删除最后一行不用的无用数据



5. 提醒规则 校期提醒、余量提醒中，天数不允许为负数

   ```html
   
   ```

   找到组件里的input-number 组件 把:min设置到0，最小为0





# day04

上午：

熟悉项目大致流程，虽然演示一遍，但还是不太清楚数据从哪里到哪里，需要在写代码的时候，重新熟悉一下只是大致了解



下午：

vue3的学习

由于组件是通过变量引用而不是基于字符串组件名注册的，在 `<script setup>` 中要使用动态组件的时候，应该使用动态的 `:is` 来绑定：

```js
<script setup>
import Foo from './Foo.vue'
import Bar from './Bar.vue'
</script>

<template>
  <component :is="Foo" />
  <component :is="someCondition ? Foo : Bar" />
</template>
```

请注意组件是如何在三元表达式中被当做变量使用的。

```js
import { FooBar as FooBarChild } from './components'
```





shiirt + alt + f 格式化





# day05

**防抖：**

可以用闭包的形式返回一个防抖的函数，这样就可以有

**as 再次添加类型，它的作用可以理解为第二次校验类型**

```js
 interface OwnerInfo {
    id: string
    name: string
    org: string
  }
  ***************************
const changeOwner = (data) => {
    let ownerObj = ownerList.value.find((item) => {
      return item.id === data.value
    }) as OwnerInfo
    return `${ownerObj.name}  (${ownerObj.org})`
  }
```

vue3中的router-view 可以以插槽的形式，获得所在的组件

```html
 <router-view v-slot="{ Component }">
              <keep-alive>
                <component :is="Component" />
              </keep-alive>
   </router-view>
```





**解决小bug：** 

1. 注册：新建 所输入，展示优化，组织加上()

```
* 以插槽的形式改变select组件里面的label 值
```

![image-20220811100125296](实习总结\image\image-20220811100125296.png)

![image-20220811100217490](C:\Users\Admin\Desktop\笔记管理\实习总结\image\image-20220811100217490.png)



今日完成任务:

1. 编写LockEmployees.vue 弹框页面

   完成任务代码，但还未获取后端数据，也未完成交互

   ```js
   <template>
     <div>
       <a-modal title="锁定用户" :visible="visible" @cancel="closeLock">
         <a-form-model
           :rules="rules"
           :model="form"
         >
           <a-form-model-item label="选定锁定方式" prop="lockSelect">
             <a-select
               style="width: 200px"
               v-model="form.lockSelect"
               placeholder="请锁定方式"
             >
               <a-select-option
                 v-for="item in lockList"
                 :key="item.id"
                 :value="item.id"
               >
                 {{ item.value }}
               </a-select-option>
             </a-select>
           </a-form-model-item>
           <a-form-model-item prop="propArea" class="textarea">
             <a-textarea
               placeholder="请填写锁定理由 (必填)"
               :rows="4"
               class="textarea"
               v-model="form.propArea"
             />
           </a-form-model-item>
         </a-form-model>
       </a-modal>
     </div>
   </template>
   <script>
   export default {
     data() {
       return {
         modelRcord:{},
         visible: false,
         form: {
           lockSelect: undefined,
           propArea: ''
         },
         rules: {
           lockSelect: [
             { required: true, message: '未选择锁定方式', trigger: 'blur' }
           ],
           propArea: [
             { required: true, message: '未填写锁定理由', trigger: 'blur' }
           ]
         },
         lockList: [
           {
             id: 1,
             value: '冻结'
           },
           {
             id: 2,
             value: '离职'
           }
         ]
       }
     },
     methods: {
       openLock(record) {
         this.modelRcord = record
         this.visible = true
         console.log(this.modelRcord);
       },
       closeLock() {
         this.visible = false
       }
     }
   }
   </script>
   <style lang="scss" scoped>
   .textarea {
     margin-top: 0px;
   }
   </style>
   ```

   ![image-20220811190744214](实习总结\image\image-20220811190744214.png)



2. 完成改写页面状态值
3. 未完成重置密码部分，密码生成部分，员工启用改账号部分







# day06 （粘贴复制密码模态框）

**开始画出账户安全页面，流程还待分析**  SystemAccount.vue





**1. 今日写出弹框回显复制重置的密码功能**

![image-20220812153949021](实习总结\image\image-20220812153949021.png)

```html
<template>
  <div>
    <a-modal
      :visible= "visible"
      :confirmLoading="false"
      :footer="null"
      :width="400"
      @cancel="closeModel"
    >
      <div class="model-title">
        <a-icon type="check-circle" style="font-size:20px; color: #16D984;" />
        <span>随机密码已生成，请及时保存 !</span>
      </div>
      <div class="model-content">
        <span>随机密码 :</span>
        <span>{{ resetPwd }}</span>
        <a-button size="small" @click="copyPwd" id="copy" :data-clipboard-text="resetPwd">复制</a-button>
      </div>
    </a-modal>
  </div>
</template>
<script>
import Clipboard from 'clipboard'
export default {
  data() {
    return {
      visible: false,
      resetPwd: '1231dsfsd'
    }
  },
  methods: {

    copyPwd() {
      let clipboard = new Clipboard('#copy')
        clipboard.on('success', e => {
          this.$message.success("复制成功")
          // 释放内存
          clipboard.destroy()
        })
        clipboard.on('error', e => {
          // 不支持复制
          this.$message.error('该浏览器不支持自动复制')
          // 释放内存
          clipboard.destroy()
        })
    },
    // 关闭模态框
    closeModel(){
       this.visible = false
    },
    // 开启模态框
    openModel(data){
        this.visible = true
        this.resetPwd = data
    }
  }
}
</script>
<style lang="scss" scoped>
.model-title {
  margin-top: 5px;
  padding: 0 10px;
  span {
    margin-left: 15px;
    font-weight: bold;
    font-size: 16px;
    vertical-align:1px;
    color: rgb(26, 36, 54);
  }
}
.model-content {
  margin-top: 20px;
  margin-bottom: 10px;
  span:nth-child(1) {
    color: gray;
    margin-left: 45px;
  }
  span:nth-child(2) {
    margin-left: 10px;
    font-size: 16px;
    color: rgb(26, 36, 54);
  }
  button {
    position: relative;
    top: -1px;
    margin-left: 13px;
  }
}
</style>

```

解决办法，利用传来的密码值，赋值给一个响应变量使用

npm install clipboard -g

import Clipboard from 'clipboard' 引入复制模块代码





# day07 

**设计系统设置的账户安全页面**
/api/banmayu/systemCenter/account/rule  get  put
![img](实习总结\image\企业微信截图_16602133413363.png)


![img](实习总结\image\企业微信截图_16602847754874.png)

开关 1-启用 2-关闭
![img](实习总结\image\企业微信截图_16602848319621.png)

**api层**

```js
/**
 * 获取账户系统安全设置信息
 */
 export function getLockERule() {
  return request({
    url: `/api/banmayu/systemCenter/account/rule`,
    method: 'get'
  })
}

// /**
//  * 设置账户系统安全信息
//  */
export function createLockRule(data) {
  return request({
    url: '/api/banmayu/systemCenter/account/rule',
    method: 'put',
    data
  })
}

```

**html层**

```html
<template>
  <div class="account-body">
    <h3>账户安全</h3>
    <a-form-model :model="form">
      <a-form-model-item class="control">
        <div>
          <a-switch @change="failTime" v-model="failSwitch"></a-switch>
          <span>输入错误密码，锁定账户</span>
        </div>
        <div class="account-error-num">
          <p>密码输错次数</p>
          <a-input-number
            :min="0"
            style="width: 200px;"
            v-model="form.failureTimes"
            :formatter="value => `${value}次`"
            :disabled="form.failureSwitcher == 2 ? true : false"
          ></a-input-number
          >
        </div>
        <div class="account-error-num">
          <p>账户被锁定时长</p>
          <a-input-number
            style="width: 200px;"
            :min="0"
            :disabled="form.failureSwitcher == 2 ? true : false"
            v-model="form.lockedTime"
          ></a-input-number>
          <a-select
            style="width: 88px; margin-left: 8px;"
            :disabled="form.failureSwitcher == 2 ? true : false"
            v-model="form.lockedTimeUnit"
          >
            <a-select-option :value="5">
              分钟
            </a-select-option>
            <a-select-option :value="4">
              小时
            </a-select-option>
            <a-select-option :value="3">
              天
            </a-select-option>
          </a-select>
        </div>
      </a-form-model-item>
      <a-form-model-item class="control">
        <div>
          <a-switch @change="passwordCycleTime"  v-model="passwordSwitch"></a-switch>
          <span>定期更换密码</span>
        </div>
        <div class="account-error-num">
          <p>设置更换周期</p>
          <a-input-number
            type="number"
            style="width: 200px;"
            :min="0"
            v-model="form.passwordCycleTime"
            :disabled="form.passwordSwitcher == 2 ? true : false"
          ></a-input-number
          ><span style="margin-left: 8px;">天</span>
        </div>
      </a-form-model-item>
      <a-form-model-item class="control">
        <div>
          <a-switch @change="accountIdleTime" v-model="accountSwitch"></a-switch>
          <span>规定时间五操作，用户账号自动登出</span>
        </div>
        <div class="account-error-num">
          <p>设置无操作时长</p>
          <a-select
            style="width: 200px;"
            v-model="form.accountIdleTime"
            :disabled="form.accountSwitcher == 2 ? true : false"
          >
            <a-select-option :value="1">
              15 分钟
            </a-select-option>
            <a-select-option :value="2">
              30 分钟
            </a-select-option>
            <a-select-option :value="3">
              1 小时
            </a-select-option>
            <a-select-option :value="4">
              2 小时
            </a-select-option> </a-select
          >
        </div>
      </a-form-model-item>
      <a-button type="primary" @click="accountSubmit">
        确定
      </a-button>
      <a-form-model-item> </a-form-model-item>
    </a-form-model>
  </div>
</template>
<script>
import { getLockERule, createLockRule } from '@/api/settings'
export default {
  data() {
    return {
      form: {
        failureSwitcher: 2, // 失败次数限制开关
        failureTimes: 0, // 失败次数
        lockedTime: 0, // 锁定时间
        lockedTimeUnit: 5, // 时间单位
        passwordSwitcher: 2, // 密码定时修改开关
        passwordCycleTime: 0, // 密码修改周期
        accountSwitcher: 2, // 账户空闲时间开关
        accountIdleTime: 1 // 账户空闲时间
      },
      failSwitch: false,   // 失败次数开关
      passwordSwitch: false,      // 密码修改开关
      accountSwitch: false   // 账户空闲开关
    }
  },
  methods: {
    failTime(checked) {
      this.form.failureSwitcher = checked ? 1 : 2
    },
    passwordCycleTime(checked) {
      this.form.passwordSwitcher = checked ? 1 : 2
    },
    accountIdleTime(checked) {
      this.form.accountSwitcher = checked ? 1 : 2
    },
    async accountSubmit() {
      const res = await createLockRule(this.form)
      if (res.code === '200') {
        this.$message.success( res.msg, 10)
      }
    }
  },
  mounted() {
    getLockERule().then(res => {
      this.failSwitch = res.data.failureSwitcher === 1 ? true : false
      this.passwordSwitch = res.data.passwordSwitcher === 1 ? true : false
      this.accountSwitch = res.data.accountSwitcher === 1 ? true : false
      for (let item in this.form) {
        this.form[item] = res.data[item]
      }
      this.form.id = res.data.id
    })
  }
}
</script>
<style lang="scss" scoped>
.account-body {
  flex: 1;
  background-color: #fff;
  height: 100%;
  padding: 16px;
  border-radius: 3px;
  box-shadow: 0 0 2px 0 rgb(31 31 31 / 5%), 0 4px 6px 0 rgb(31 31 31 / 20%);
}
h3 {
  color: rgb(12, 16, 22);
  font-weight: bold;
}

.control {
  button {
    margin-right: 8px;
    width: 40px;
    height: 24px;
  }
  span {
    color: #42526e;
  }
}
.account-error-num {
  margin-left: 52px;
  p {
    margin: 0;
  }
}
.ant-select-selection {
  background-color: #f4f5f7;
}
</style>

```



* 注意知识点 lodash 里面 '_' 在引用时是全局的

![image-20220815141232373](实习总结\image\image-20220815141232373.png)





# day08

**登录页**

![image-20220816091820568](C:\Users\Admin\Desktop\笔记管理\实习总结\image\image-20220816091820568.png)



**login.vue**

```

```

支持账户强制修改页面

**RepeatPassword.vue**

```HTML
<!--
 * @Author: lyjie
 * @Date: 2022-08-17 09:12:23
 * @LastEditors: lyjie
 * @LastEditTime: 2022-08-17 10:47:15
 * @FilePath: \elabnote-front-main\src\views\login\components\RepeatPassword.vue
 * Copyright (c) 2022 by BMY, All Rights Reserved. 
-->
<template>
  <div class="login-box">
    <div class="login-middle">
      <p class="set-title">设置密码</p>
      <p class="set-tip">请修改密码再登录账号</p>
      <p class="set-password-tip">密码仅可由数字、英文字母或英文符号组成，且需包含此三种类型,长度不少于8个字符</p>
      <div class="login-form-wrapper">
        <a-form layout="vertical" :model="setForm" :rules="setRules" class="login-form" ref="setFormRef">
          <a-form-item class="login-items" field="oldPwd">
            <a-input
              v-model="setForm.oldPwd"
              class="login-inputs"
              size="large"
              ref="elPasswordOld"
              :type="passwordTypeOld"
              placeholder="请输入旧密码"
              autocomplete="off"
            >
              <template #suffix>
                <span class="show-pwd" @click="oldPwd">
                  <icon-eye-invisible v-if="passwordTypeOld === 'password'" />
                  <icon-eye v-else />
                </span>
              </template>
            </a-input>
          </a-form-item>

          <a-tooltip
            :popup-visible="capsTooltip"
            :content="capsTooltip == true ? '大写锁定已经打开' : ''"
            position="right"
          >
            <a-form-item class="login-items" field="password">
              <a-input
                v-model="setForm.password"
                class="login-inputs"
                size="large"
                ref="elPasswordSet"
                :type="passwordTypeSet"
                placeholder="请输入密码"
                autocomplete="off"
                @keyup="checkCapslock"
                @blur="capsTooltip = false"
                @input="sumbitFlight"
              >
                <template #suffix>
                  <span class="show-pwd" @click="setPwd">
                    <icon-eye-invisible v-if="passwordTypeSet === 'password'" />
                    <icon-eye v-else />
                  </span>
                </template>
              </a-input>
            </a-form-item>
          </a-tooltip>
          <a-form-item class="login-items" field="repeatPwd">
            <a-input
              v-model="setForm.repeatPwd"
              class="login-inputs"
              size="large"
              ref="elPasswordRepeat"
              :type="passwordTypeRepeat"
              placeholder="再次输入密码"
              autocomplete="off"
              @input="sumbitFlight"
            >
              <template #suffix>
                <span class="show-pwd" @click="repeatPwd">
                  <icon-eye-invisible v-if="passwordTypeRepeat === 'password'" />
                  <icon-eye v-else />
                </span>
              </template>
            </a-input>
          </a-form-item>
          <a-button
            type="primary"
            style="width: 100%; margin-top: 16px; height: 48px; font-weight: 500; font-size: 14px; border-radius: 3px"
            :disabled="defineFlag"
            @click="handleSetPwd"
            >确定
          </a-button>
        </a-form>
      </div>
    </div>
  </div>
</template>
<script setup lang="ts">
  import { reactive, ref } from 'vue'
  import { updateUserInfo } from '@/api/systemcenter/login'
  import Message from '@/components/Message'
  interface Props {
    visible: { flag: Boolean }
  }

  const props = defineProps<Props>()
  const capsTooltip = ref<boolean>(false)

  const passwordTypeSet = ref<'password' | 'text' | undefined>('password')
  const passwordTypeRepeat = ref<'password' | 'text' | undefined>('password')
  const passwordTypeOld = ref<'password' | 'text' | undefined>('password')

  const setForm = reactive({
    oldPwd: '',
    password: '',
    repeatPwd: ''
  })

  const elPasswordSet = ref<HTMLElement | null>(null)
  const elPasswordRepeat = ref<HTMLElement | null>(null)
  const elPasswordOld = ref<HTMLElement | null>(null)

  const setFormRef = ref()

  // 控制确定按钮可击
  const defineFlag = ref<boolean>(true)

  const setPwd = () => {
    if (passwordTypeSet.value === 'password') {
      passwordTypeSet.value = 'text'
    } else {
      passwordTypeSet.value = 'password'
    }
    elPasswordSet.value?.focus()
  }

  const repeatPwd = () => {
    if (passwordTypeRepeat.value === 'password') {
      passwordTypeRepeat.value = 'text'
    } else {
      passwordTypeRepeat.value = 'password'
    }
    elPasswordRepeat.value?.focus()
  }

  const oldPwd = () => {
    if (passwordTypeOld.value === 'password') {
      passwordTypeOld.value = 'text'
    } else {
      passwordTypeOld.value = 'password'
    }
    elPasswordOld.value?.focus()
  }

  const validatePwd = (value, callback) => {
    const regx = /^(?=.*\d)(?=.*[a-zA-Z])(?=.*[~!@#$%^&*])[\da-zA-Z~!@#$%^&*]{8,}$/
    if (regx.test(value)) {
      callback()
    } else {
      callback(new Error('格式不正确'))
    }
  }
  const validateRepeat = (value, callback) => {
    if (value === setForm.password) {
      callback()
    } else {
      callback(new Error('输入不一致'))
    }
  }

  const validateOld = (value, callback) => {
    if (value?.length >= 8) {
      callback()
    } else {
      callback(new Error('格式不正确'))
    }
  }

  const setRules = reactive({
    password: [
      {
        validator: validatePwd,
        trigger: 'blur'
      }
    ],
    repeatPwd: [
      {
        validator: validateRepeat,
        trigger: 'blur'
      }
    ],
    oldPwd: [
      {
        validator: validateOld,
        trigger: 'blur'
      }
    ]
  })
  const checkCapslock = (e) => {
    const { key } = e
    capsTooltip.value = key && key.length === 1 && key >= 'A' && key <= 'Z'
  }

  const sumbitFlight = () => {
    let isSuccess = false
    setFormRef.value.validate(async (e) => {
      if (e === undefined) isSuccess = true
      if (!isSuccess) {
        defineFlag.value = true
      } else {
        defineFlag.value = false
      }
    })
  }

  const handleSetPwd = async () => {
    let isSuccess = false
    setFormRef.value.validate(async (e) => {
      if (e === undefined) isSuccess = true
      if (!isSuccess) return

      // updateUserInfo()
      const passwordInfo = {
        newPassword: '',
        originalPassword: '',
        confirmPassword: ''
      }
      passwordInfo.newPassword = setForm.password
      passwordInfo.originalPassword = setForm.oldPwd
      passwordInfo.confirmPassword = setForm.repeatPwd
      const res = await updateUserInfo(passwordInfo)
      if (res.code === '200') {
        props.visible.flag = true
      } else {
        Message({
          type: 'error',
          content: res.message ?? '输入密码错误'
        })
      }
    })
  }
</script>
<style lang="scss" scoped>
  .login-box {
    margin-left: -200px;
    display: flex;
    flex-flow: column;
    padding: 0px 80px;
    box-sizing: border-box;
    width: 630px;
    /* height: 850px; */
    height: 83.5%;
    min-height: 645px;

    background: rgba(255, 255, 255, 0.7);
    box-shadow: 0px 0px 2px rgba(96, 123, 241, 0.28), 0px 2px 20px rgba(49, 80, 216, 0.07), inset 0px 2px 3px #ffffff;
    backdrop-filter: blur(20px);
    border-radius: 10px;

    /* animation: login_box_scale 0.5s 1; */

    @keyframes login_box_scale {
      from {
        transform: scale(0);
      }
      to {
        transform: scale(1);
      }
    }

    .login-header {
      text-align: center;
    }

    .login-middle {
      margin-top: 60px;
      .login-title {
        text-align: left;
        width: 192px;
        height: 68px;

        font-family: 'OPPOSans';
        font-style: normal;
        font-weight: 700;
        font-size: 24px;
        line-height: 68px;
        color: #172b4d;
      }
      .set-title {
        text-align: left;
        width: 192px;
        height: 31px;

        font-family: 'OPPOSans';
        font-style: normal;
        font-weight: 700;
        font-size: 24px;
        line-height: 68px;
        color: #172b4d;
      }
      .set-tip {
        width: 469px;
        height: 60px;

        font-family: 'OPPOSans';
        font-style: normal;
        font-weight: 400;
        font-size: 14px;
        line-height: 18px;
        color: #97a0af;
      }
      .set-password-tip {
        width: 469px;
        height: 36px;

        font-family: 'OPPOSans';
        font-style: normal;
        font-weight: 400;
        font-size: 14px;
        line-height: 18px;
        color: #42526e;
      }
      .login-form-wrapper {
        .login-items {
          text-align: left;
          font-family: 'OPPOSans';
          font-style: normal;
          font-weight: 400;
          font-size: 14px;
          /* labelCss */
          .ant-col.ant-form-item-label.ant-form-item-label-left label {
            color: #6b778c !important;
          }
          /* inputCss */
          .login-inputs.ant-input-affix-wrapper.ant-input {
            height: 100px !important;
          }
        }
        .show-pwd {
          cursor: pointer;
        }
      }
    }

    .login-bottom {
      flex: 1;
      display: flex;
      justify-content: center;
      .logo-slogo {
        align-self: flex-end;
        display: flex;
        justify-content: center;
        margin-bottom: 48px;
        span {
          font-weight: 400;
          font-size: 16px;
          letter-spacing: 8px;
          color: #708aff;
        }
      }
    }
  }
</style>

```

只要字段needModifyPwd === 1 那么跳转到强制修改页面



# day09



* 发现之前遗留问题，不知道是前端传的字段还是后端给的数据，在做账户安全时，账户冻结，传值有问题，报错

watch的两种方式，ref可以直接使用，但relative 需要用函数的形式触发返回

用vue3hook完成预留用户未操作超时后强制退出重新登录

hook代码 useTimeout.ts  (使用watch监听)

https://blog.csdn.net/yxzone/article/details/125395355

参考csdn

```js
/*
 * @Author: lyjie
 * @Date: 2022-08-17 17:30:00
 * @LastEditors: lyjie
 * @LastEditTime: 2022-08-18 17:23:08
 * @FilePath: \elabnote-front-main\src\hooks\useTimeout.ts
 * Copyright (c) 2022 by BMY, All Rights Reserved.
 */
// import { ref } from 'vue'
import Modal from '@/components/Modal'
import i18n from '@/locale'
import { localCache } from '@/util'
import { onMounted, watch } from 'vue'
import { useUserStore } from '@/store/modules/user'
import { useRoute } from 'vue-router'

export const PageTimeout = () => {
  const route = useRoute()
  const userStore = useUserStore()
  let timer: number
  const useTimeout = (time: number) => {
    window.clearInterval(timer)
    //   const timeOut = ref<number | undefined>()
    //   const lastTime = ref<number | undefined>()
    //   const currentTime = ref<number | undefined>()
    let timeOut: number
    let lastTime: number
    let currentTime: number
    lastTime = new Date().getTime()
    currentTime = new Date().getTime()

    switch (time) {
      case 1: {
        timeOut = 15 * 60 * 1000
        break
      }
      case 2: {
        timeOut = 30 * 60 * 1000
        break
      }
      case 3: {
        timeOut = 60 * 60 * 1000
        break
      }
      case 4: {
        timeOut = 120 * 60 * 1000
        break
      }
    }
    window.addEventListener('mouseover', () => {
      lastTime = new Date().getTime()
    })
    window.addEventListener('keydown', () => {
      lastTime = new Date().getTime()
    })
    const testTime = () => {
      currentTime = new Date().getTime()
      const x = currentTime
      const y = lastTime
      if (x - y > timeOut) {
        window.clearInterval(timer)
        if (route.name !== 'login') {
          Modal({
            type: 'error',
            maskClosable: false,
            titleAlign: 'start',
            title: i18n.global.t('service.resuest.warning'),
            simple: false,
            content: i18n.global.t('service.resuest.warningTipInfo'),
            onOk: () => {
              localCache.clearCookies()
              location.href = `${location.protocol}//${location.host}/`
            }
          })
        }
      }
    }
    timer = window.setInterval(testTime, 1000)
  }

  //监听事件所有
  onMounted(() => {
    watch(
      () => userStore.accountIdleTime,
      (accountIdleTime) => {
        accountIdleTime && useTimeout(userStore.accountIdleTime)
      },
      {
        immediate: true
      }
    )
  })
}

```

使用接口是老项目接口

使用ts 和store结合

type.ts   使用config

```js
export type Unit = {
  id: string
  unitAlias: null | string
  unitName: string
  unitType: number
  [key: string]: any
}

export type Config = {
  accountIdleTime: number
  [key: string]: any
}

export interface IUserInfo {
  permissionList: UserPermissions
  menuList: UserPermissions
  userInfo: { [key in string]: any }
  units: Array<Unit>
  config: Config
}

```

store.ts

```js
import { UserPermissions, IUserInfo, Unit, Config } from './types'

export const useUserStore = defineStore('main-user', {
  persist: true,
  state: (): IUserInfo => ({
    userInfo: {},
    permissionList: [],
    menuList: [],
    units: [],
    config: {} as Config
  }), 
  getters: {
    permissions(state): UserPermissions {
      return ([] as UserPermissions).concat(state.permissionList).concat(state.menuList)
    },

    quantityUnits(state): Array<Unit> {
      return state.units.filter((item) => item.unitType === MeasuringUnitEnum.QUANTITY)
    },

    volumeUnits(state): Array<Unit> {
      return state.units.filter((item) => item.unitType === MeasuringUnitEnum.VOLUME)
    },

    densityUnits(state): Array<Unit> {
      return state.units.filter((item) => item.unitType === MeasuringUnitEnum.DENSITY)
    },

    accountIdleTime(state): number {
      return state.config.accountIdleTime
    }
  },
  actions: {
    changePermissionInfo(userInfo: IUserInfo) {
      this.permissionList = userInfo.permissionList
      this.menuList = userInfo.menuList
      this.userInfo = userInfo.userInfo
    },

    changeUserInfo(userInfo) {
      this.userInfo = userInfo
    },

    async login({ loginName, passWord }: { loginName: string; passWord: string }) {
      // const [userInfo, permissionInfo] = await Promise.all([login({ loginName, passWord }), getScUserPermission()])
      const userInfo = await login({ loginName, passWord })
      const permissionInfo = await getScUserPermission()
      this.changePermissionInfo({ ...permissionInfo.data, userInfo: userInfo.data })

      // 兼容老系统 老系统依赖 localStorage 的 permissionInfo
      localCache.setCache('userInfo', userInfo.data)
      localCache.setCache('permissionInfo', permissionInfo.data)
      this.getInitSystemConfig()
      this.getMessageStatistics()
      this.getmeasuringUnit()
      this.getUserLockInfo()
    },

    /**
     * 改变单位
     */
    changeUnits(units: Array<Unit>) {
      this.units = units
    },

    /**
     * 兼容老系统
     * 获取用户配置参数
     */
    async getInitSystemConfig() {
      const { data } = await getInitSystemConfig()
      localCache.setCache('CUSTOM_PROPERTY', data)
    },

    async getMessageStatistics() {
      const { data } = await getMessageStatistics()
      const userInfo = { ...this.userInfo, unreadCount: data.unreadCount }
      this.changeUserInfo(userInfo)
    },

    async getmeasuringUnit() {
      const { data } = await getmeasuringUnit()
      this.changeUnits(data as Array<Unit>)
    },
    async getUserLockInfo() {
      const { data } = await getUserLockInfo()
      this.config = data
    }
  }
})
```

细节在stroe中登录方法中调用获取接口函数

# day10

修改一些bug，超时登出退出，判断store中有无值，在onMount书写代码调用逻辑

在退出的时候，清楚本地存储里面的东西

今日完成： 种类支持设置图标，找一下获取一下icon标签，找一下对应的变量，修改一下

今日修改最主要是登录页面第一次登录强制改写密码，思路，在store里面存入修改条件，我们是以token值用全局钩子进行判断页面，所以我们要把改选择条件加入判断token里面去，但记得提前清楚本地缓存和token值才能避免循环

主要页面逻辑代码

```js
  // 浏览器回退事件
  window.addEventListener('popstate', function () {
    location.reload()
  })
  const handleSetPwd = async () => {
    let isSuccess = false
    setFormRef.value.validate(async (e) => {
      if (e === undefined) isSuccess = true
      if (!isSuccess) return

      // updateUserInfo()
      const passwordInfo = {
        newPassword: '',
        originalPassword: '',
        confirmPassword: ''
      }
      passwordInfo.newPassword = setForm.password
      passwordInfo.originalPassword = setForm.oldPwd
      passwordInfo.confirmPassword = setForm.repeatPwd
      const res = await updatePassword(passwordInfo)
      if (res.code === '200') {
        props.visible.flag = true
        clearLocalStorage()
      } else {
        Message({
          type: 'error',
          content: res.message ?? '输入密码错误'
        })
      }
    })
  }
```

还有个判断没有判断

登录超时不能时时更新，





# day11

描写protocal

实物链接、产品链接、批次链接分别对应下面的下拉框，选择种类框架后才能选举，他是根据上面选择参数类型下面时时响应改变，是组件深层套用，因此有的信息在添加刷新和编辑用的都是同一个变量，困难对于删除，通过不断父子传参，深层传入，一个页面一个页面定义，加大条件来实现

未能解决回显



# day12

完成：解决回显，以及一些添加页面和编辑页面的时候数据缓存问题

困难未完成：实现下拉选择框搜索功能，需要使用组件方法未找到

```html
<template>
  <div style="padding: 8px;">
    <a-space style="min-height: 40px;" class="spance">
      <a-switch :checked="isOpen" @change="handleChangeChecked">
        <a-icon slot="checkedChildren" type="check" />
        <a-icon slot="unCheckedChildren" type="close" />
      </a-switch>
      <span>{{ isOpen ? '限制框架' : '不限制框架' }}</span>
      <a-select
        v-show="isOpen"
        allowClear
        show-search
        :filterOption="filterOption"
        style="width: 90px; font-size: 12px"
        placeholder="请选择"
        v-model="frameId"
        @deselect="clearProductionFram"
        @change="getProductionFrame"
        :disabled="handleFlag"
      >
        <!-- @change="getProductionFrame" -->
        <a-select-option
          :key="`${item.name}-${item.id}`"
          :value="item.id"
          v-for="item in frameList"
          :title="item.name"
        >
          {{ item.name }}
        </a-select-option>
      </a-select>
    </a-space>

    <div v-show="isOpen" class="areainput">
      <a-row>
        <a-col :span="12">
          <!-- v-model="productIdList" -->
          <a-select
            mode="multiple"
            :value="productIdList"
            placeholder="请选择注册字段"
            option-label-prop="label"
            :maxTagCount="2"
            maxTagPlaceholder="..."
            :maxTagTextLength="2"
            :disabled="handleFlag"
            @deselect="deleteProductInfo"
          >
            <a-select-option
              v-if="productList.length > 0 && productList !== undefined"
              value=""
              @click="changeProductAll"
            >
              <a-checkbox :checked="selectAllProduct"> </a-checkbox>
              <span style="margin-left: 10px;">全选</span>
            </a-select-option>

            <a-select-option
              :key="`${item.fieldName}-${item.id}`"
              :value="item.id"
              v-for="item in productList"
              :label="item.fieldName"
              @click="changeProductInfo(item)"
            >
              <a-checkbox :checked="item.selectInfo"> </a-checkbox>
              <span style="margin-left: 10px;">{{ item.fieldName }}</span>
            </a-select-option>
          </a-select>
        </a-col>

        <a-col :span="12" v-if="parameterType !== 50">
          <a-select
            mode="multiple"
            :value="batchIdList"
            placeholder="请选择批次字段"
            option-label-prop="label"
            :maxTagCount="1"
            maxTagPlaceholder="..."
            :disabled="handleFlag"
            @deselect="deleteBatchInfo"
          >
            <a-select-option
              v-if="batchList.length > 0 && batchList !== undefined"
              value=""
              @click="changeBatchAll"
            >
              <a-checkbox :checked="selectAllBatch"> </a-checkbox>
              <span style="margin-left: 10px;">全选</span>
            </a-select-option>

            <a-select-option
              :key="`${item.fieldName}-${item.id}`"
              :value="item.id"
              v-for="item in batchList"
              :label="item.fieldName"
              @click="changeBatchInfo(item)"
            >
              <a-checkbox :checked="item.selectInfo"> </a-checkbox>
              <span style="margin-left: 10px;">{{ item.fieldName }}</span>
            </a-select-option>
          </a-select>
        </a-col>

        <a-col :span="12">
          <a-select
            v-model="physicalId"
            placeholder="请选择默认容器元件"
            :disabled="handleFlag"
          >
            <!-- <a-select-option
              :key="`${item.name}-${item.id}`"
              :value="item.id"
              v-for="item in physicalList"
              :title="item.name"
            >
              {{ item.name }}
            </a-select-option> -->
            <a-select-opt-group>
              <span slot="label">盒</span>
              <a-select-option
                :key="`${item.name}-${item.id}`"
                :value="item.id"
                v-for="item in physicalObj.boxList"
                :title="item.name"
              >
                {{ item.name }}
              </a-select-option>
            </a-select-opt-group>
            <a-select-opt-group>
              <span slot="label">板</span>
              <a-select-option
                :key="`${item.name}-${item.id}`"
                :value="item.id"
                v-for="item in physicalObj.plateList"
                :title="item.name"
              >
                {{ item.name }}
              </a-select-option>
            </a-select-opt-group>
          </a-select>
        </a-col>
      </a-row>
    </div>
  </div>
</template>

<script>
// import { getFullProductFrameList } from '@/api/materialCenter'
import { filterOption } from '@/views/settings/module/comm/util'
import { FieldRefTypeEnum } from '@/common/global'
import {
  getFullProductFrameList,
  getProdctionFrameDetail,
  getBoxAndPlateFrame
} from '@/api/materialCenter'

export default {
  props: {
    defaultInputFence: {
      type: Array,
      default: () => []
    },
    parameterType: {
      type: Number
    },
    isNew: {
      type: Number
    },
    productFields: {
      type: Array,
      default: () => []
    },
    productBatchFields: {
      type: Array,
      default: () => []
    },
    stockSchema: {
      type: Object,
      default: () => {}
    },
    cellType: {
      type: Number
    },
    showModal: {
      type: Boolean,
      default: false
    }
  },

  data() {
    return {
      frameList: [],
      frameId:
        _.isArray(this.defaultInputFence) && this.defaultInputFence.length > 0
          ? this.defaultInputFence[0]?.referenceId
          : undefined,
      isOpen: false,

      // 获取循环字段
      productList: [],
      batchList: [],
      physicalObj: {
        boxList: [],
        plateList: []
      },

      // 获取选择字段
      productIdList: [],
      batchIdList: [],
      physicalId: undefined,
      // 全选设置
      selectAllProduct: false,
      selectAllBatch: false,
      handleFlag: false
    }
  },

  async created() {
    const { data } = await getFullProductFrameList({
      pageIndex: -1
    })
    this.frameList = data
  },

  methods: {
    filterOption,

    /**
     * 改变是否展示限制的状态
     */
    handleChangeChecked(status) {
      this.isOpen = status
      if (!status) {
        this.frameId = undefined
      }
    },

    /**
     * 数据初始化
     */
    initData(inputFence) {
      if (_.isArray(inputFence) && inputFence.length > 0) {
        this.isOpen = true
        this.frameId = inputFence[0]?.referenceId
      }
    },

    /**
     * 获取选择的框架
     */
    getSelectedFrame() {
      if (this.frameId) {
        return [
          {
            referenceId: this.frameId,
            referenceType: FieldRefTypeEnum.PRODUCT_FRAME
          }
        ]
      }
      return []
    },
    // 获取选择产品
    getProductField() {
      if (this.frameId) {
        return this.productIdList.map(item => {
          const fieldInfo = this.productList.find(it => {
            return it.id === item
          })
          return {
            fieldId: item,
            fieldName: fieldInfo.fieldName
          }
        })
      }
      return []
    },
    // 获取选择批次
    getBatchFields() {
      if (this.frameId) {
        return this.batchIdList.map(item => {
          const fieldInfo = this.batchList.find(it => {
            return it.id === item
          })
          return {
            fieldId: item,
            fieldName: fieldInfo.fieldName
          }
        })
      }
    },
    // 获取所选元组
    getStockSchema() {
      if (this.frameId) {
        console.log(
          this.physicalObj.boxList.find(item => {
            return this.physicalId === item.id
          })
        )
        const listInfo = this.physicalObj.boxList.find(item => {
          return this.physicalId === item.id
        })
        // console.log(this.physicalId)
        const flag = this.physicalObj.boxList.includes(listInfo)
        console.log(flag)
        let fieldInfo = {}
        if (flag) {
          fieldInfo = this.physicalObj.boxList.find(it => {
            return it.id === this.physicalId
          })
        } else {
          fieldInfo = this.physicalObj.plateList.find(it => {
            return it.id === this.physicalId
          })
        }
        return {
          schemaId: this.physicalId,
          schemaName: fieldInfo?.name
        }
      }
      return {}
    },
    // 获得产品框架信息
    async getProductionFrame() {
      if (this.frameId === undefined || this.frameId === '') {
        this.clearProductionFram()
      } else {
        // this.productIdList = []
        // this.batchIdList = []
        // this.physicalId = undefined
        // this.selectAllProduct = false
        let productArr = []
        let batchArr = []
        this.clearProductionFram()
        const frameNeed = (
          await getProdctionFrameDetail({
            id: this.frameId
          })
        ).data
        const boxAndPlate = await getBoxAndPlateFrame({})
        this.physicalObj.boxList = boxAndPlate.data.boxList
        this.physicalObj.plateList = boxAndPlate.data.plateList
        // this.physicalObj.plateList = await getBoxFrame({
        //   pageSize: -1,
        //   stockFrameId: '1'
        // })
        productArr = frameNeed.params
        batchArr = frameNeed.productBatchFields
        this.productList = productArr.map(item => {
          item.selectInfo = false
          return item
        })
        this.batchList = batchArr.map(item => {
          item.selectInfo = false
          return item
        })
      }
    },
    // 清除按钮取消信息
    clearProductionFram() {
      this.productList = []
      this.batchList = []
      this.physicalObj = {}
      this.physicalId = undefined
      this.productIdList = []
      this.batchIdList = []
    },
    // // 可控产品全选（完成）
    changeProductAll() {
      this.selectAllProduct = !this.selectAllProduct
      this.productList.map(item => {
        item.selectInfo = this.selectAllProduct
      })
      if (this.selectAllProduct) {
        this.productIdList = this.productList.map(item => {
          return item.id
        })
      } else {
        this.productIdList = []
      }
    },
    //判断是否产品点击单个全选
    isProductSelect() {
      const isFlag = this.productList.every(item => {
        return item.selectInfo === true
      })
      if (isFlag) {
        this.selectAllProduct = true
      } else {
        this.selectAllProduct = false
      }
    },

    // 可控单一产品选择
    changeProductInfo(item) {
      item.selectInfo = !item.selectInfo
      if (item.selectInfo) {
        this.productIdList.push(item.id)
      } else {
        const num = this.productIdList.findIndex(it => {
          return it === item.id
        })
        this.productIdList.splice(num, 1)
      }
      this.isProductSelect()
    },
    // 批次全选
    changeBatchAll() {
      this.selectAllBatch = !this.selectAllBatch
      this.batchList.map(item => {
        item.selectInfo = this.selectAllBatch
      })
      if (this.selectAllBatch) {
        this.batchIdList = this.batchList.map(item => {
          return item.id
        })
      } else {
        this.batchIdList = []
      }
    },
    //判断是否批次点击单个全选
    isBatchSelect() {
      const isFlag = this.batchList.every(item => {
        return item.selectInfo === true
      })
      if (isFlag) {
        this.selectAllBatch = true
      } else {
        this.selectAllBatch = false
      }
    },

    // 可控单一批次选择
    changeBatchInfo(item) {
      item.selectInfo = !item.selectInfo
      if (item.selectInfo) {
        this.batchIdList.push(item.id)
      } else {
        const num = this.batchIdList.findIndex(it => {
          return it === item.id
        })
        this.batchIdList.splice(num, 1)
      }
      this.isBatchSelect()
    },
    deleteProductInfo(value) {
      const productIdIndex = this.productIdList.findIndex(item => {
        return item === value
      })
      const productListIndex = this.productList.findIndex(item => {
        return item.id === value
      })

      this.productList[productListIndex].selectInfo = false
      this.productIdList.splice(productIdIndex, 1)
    },
    deleteBatchInfo(value) {
      const batchIdIndex = this.batchIdList.findIndex(item => {
        return item === value
      })
      const batchListIndex = this.batchList.findIndex(item => {
        return item.id === value
      })

      this.batchList[batchListIndex].selectInfo = false
      this.batchIdList.splice(batchIdIndex, 1)
    }
  },

  watch: {
    defaultInputFence: {
      async handler(newInputFence) {
        this.initData(newInputFence)
        // 回显
        if (
          this.isNew === 2 &&
          this.cellType === this.parameterType &&
          this.frameId !== undefined
        ) {
          this.handleFlag = true
          const frameNeed = await getProdctionFrameDetail({
            id: this.frameId
          })
          const boxAndPlate = await getBoxAndPlateFrame({})

          if (frameNeed.code === '200' && boxAndPlate.code === '200') {
            this.productList = frameNeed.data.params.map(item => {
              item.selectInfo = false
              return item
            })
            this.batchList = frameNeed.data.productBatchFields.map(item => {
              item.selectInfo = false
              return item
            })

            this.physicalObj.boxList = boxAndPlate.data.boxList
            this.physicalObj.plateList = boxAndPlate.data.plateList

            this.physicalId = this.stockSchema.schemaId
            this.productIdList = this.productFields?.map(item => {
              const checkedTrue = this.productList.find(it => {
                return item.fieldId === it.id
              })
              checkedTrue.selectInfo = true
              return item.fieldId
            })
            this.batchIdList = this.productBatchFields?.map(item => {
              const checkedTrue = this.batchList.find(it => {
                return item.fieldId === it.id
              })
              checkedTrue.selectInfo = true
              return item.fieldId
            })
            this.handleFlag = false
          }
        }
      },
      immediate: true
    },
    frameId: {
      handler() {
        if (this.frameId === undefined && this.frameId === '') {
          this.clearProductionFram()
        }
      },
      immediate: true
    },
    showModal() {
      if (this.isNew === 1) {
        this.isOpen = false
        this.frameId = undefined
        this.clearProductionFram()
      }
    }
  }
  // mounted() {
  //   // if (this.isNew !== 1) {
  //     this.getProductionFrame()
  //   // }
  // }
}
</script>

<style lang="scss" scoped>
.spance ::v-deep .ant-select-selection {
  border: none;
  box-shadow: none;
}
.areainput ::v-deep .ant-select-selection {
  margin-top: 10px;
  width: 200px;
  height: 30px;
  overflow: hidden;
}
</style>

```

# day13

发现Protocol参数新建和编辑产生typeErro找不到问题，当数组为空的时候许多对象和数组方法使用报错

![image-20220824145433366](实习总结\image\image-20220824145433366.png)

使用双问号？？运算符判断前面变量是否为数组如果不是给一个空数组来解决冲突问题，

在解决全选问题的时候会有缓存看地方和事件发生的地方清空选择



**注意：**如果Ante组件库是多选下拉框如果选择个数或长度超过下拉框长度承受值，再次点击便会有清空的效果，但只是视觉上的清空，本质

**预留bug**（bug是在新建的时候老板的模板改变可以预留的数据不在里面，那么就会出现数据不存在，或者脏数据）

**问题体现**

下面这个就是在列表中找不到对应的单项回显出来的之前的id值

![image-20220824162305668](实习总结\image\image-20220824162305668.png)

![image-20220824161038739](实习总结\image\image-20220824161038739.png)

**同样bug相同位置预留**

![image-20220824162038747](实习总结\image\image-20220824162038747.png)



预留问题：Protocol问题，当我想要直接点击编辑未等回显出来就点击确认那么这种清空会直接清空，之前的选择项，

修改： 如果想修改需要不断子传父一直传到最外层，监听他的变量，使得确认按钮可以使用



优化： a-select： 

 notFoundContent属性当下拉列表为控时显示的内容     string/slot

实现所选框搜索：{

```
  <!-- 
  optionFilterProp="key" 重新绑定值
  :filterOption="filterOption"  筛选可以通过的条件
  -->
```

}





# day14

项目进度(进入发布) 

今天改正计划时间与改正图标样式

1. 改正计划时间，使用uitil封装好的方法进行移入改正

2. 任务与项目模块，任务图标显示

3. 同样的问题，在任务和实验模块改变状态标签的图标样式


4. 新任务添加




添加判断账号密码过期的一个flag值，如果过期弹出一个模态框，用来进行操作



通过状态码 444  判断

通过后台传输过来的状态码来判断，输入账号密码有没有过期验证，444为过期判断，跳转到修改密码页面

在流程信息在抽屉里使用列表如图

![image-20220826000058153](实习总结\image\image-20220826000058153.png)

* 学习在深度监听一个父传子的数据和store里获得的数据时需要用，函数的方式生命监听变量返回值的形式

```js
<script setup lang="ts">
  import { watch, ref } from 'vue'
  import type { Node } from '@/api/material'
  import { getqueryProductAndBatchInfo } from '@/api/material/index'
  import { isNull, isUndefined } from 'lodash'
  //   import type SimpleFieldInfo from '@/components/SimpleFieldInfo/index.vue'
  const Props = defineProps<{
    nodeInfo: Node
  }>()
  const productFlag = ref<boolean>()
  const batchFlag = ref<boolean>()
  const getProductList = ref([])
  const getBatchList = ref([])
  watch(
    () => Props.nodeInfo,
    async () => {
      getProductList.value = []
      getBatchList.value = []
      const getList = await getqueryProductAndBatchInfo(Props.nodeInfo?.id, Props.nodeInfo?.type)
      if (
        isUndefined(getList.data.baseMaterialProduct?.productValues) ||
        isNull(getList.data.baseMaterialProduct?.productValues)
      ) {
        productFlag.value = false
        getProductList.value = []
      } else {
        productFlag.value = true
        getProductList.value = getList.data.baseMaterialProduct?.productValues
      }
      if (
        isUndefined(getList.data.buMaterialsProductBatch?.params) ||
        isNull(getList.data.buMaterialsProductBatch?.params)
      ) {
        batchFlag.value = false
        getBatchList.value = []
      } else {
        batchFlag.value = true
        getBatchList.value = getList.data.buMaterialsProductBatch?.params
      }
    },
    {
      immediate: true
    }
  )
</script>
```

**学习枚举与其他不同混合方法：**

枚举值不同，选择不同动态的组件

![image-20220826141106969](实习总结\image\image-20220826141106969.png)

![image-20220826205625306](实习总结\image\image-20220826205625306.png)



# day15

今日

如果要跳转新老页面使用土方法location.href

项目条件赛选，效期，余期，跳转，项目流程赛选是一般是全选，之后根据发送请求给后端，后端处理筛选条件返回给id根据id再去请求list表来获取表数据，这样有利于防护和做筛选需求





## js有用的新语法

```js
'jobtype' in nodeObj //标示在nodeObj里面是否存在jobtype属性
```



## 时间格式转化为TZ格式

npm i moment  ------------(处理时间)

```js
momentFormatTZ(time) {
      console.log(time)
      time = new Date(time + ' 00:00:00')   // time = '年-月-日 00：00：00'
      console.log(time)
      return time
        ? this.moment(Number(time)).format('YYYY-MM-DDTHH:mm:[00][Z]')
        : ''
    }
  }
```

![image-20220829100623508](实习总结\image\image-20220829100623508.png)



day17：

把vue2的东西搬入到vue3中去的项目要

**一、工作台**

**Array.flat([lenthg])数组降纬度**



## 在不点击失去特定的html元素触发方法

```js
 import { onClickOutside } from '@vueuse/core'
   onClickOutside(dateNeed, () => {
    showDateBtn.value = false
  })
  
  
<! -------------------------------加上绑定元素------------------------------------->
import { onClickOutside, useElementBounding } from '@vueuse/core'
```

## 开启项目环境

![image-20220906095328365](实习总结\image\image-20220906095328365.png)

把要开发或者上传的项目打开

![image-20220906095412328](实习总结\image\image-20220906095412328.png)





![image-20220906212814563](实习总结\image\image-20220906212814563.png)

## 路由冒号跳转接受不到跳转参数问题

遇见vue3-router跳转需要监听跳转冒号传参的事件时，可以使用监听路由

```js
 <router-view v-slot="{ Component }">
        <keep-alive>
          <component :is="Component" />
        </keep-alive>
      </router-view>
```

```js
<!--------------1---------------------->
<script setup lang="ts">
  import { ref, watch } from 'vue'
  import { useRoute, useRouter，onBeforeRouteUpdate } from 'vue-router'

  const [route, router] = [useRoute(), useRouter()]
  const routeType = ref<string | undefined>()
  routeType.value = route.params.type as string
  // 使用watch可以
  // watch(
  //   () => route,
  //   () => {
  //     console.log(route.params)
  //   },
  //   { immediate: true, deep: true }
  // )
</script>
<!---------------------2-------------->\
//可以使用路由更新钩子
  onBeforeRouteUpdate(() => {
    console.log(route.params)
  })
```

## 改服务器：dev.config.js

![image-20220907112944554](实习总结\image\image-20220907112944554.png)

## 简单列表+

```js
<BasicTable
    :loading="loading"
    :scroll="scroll"
    :pagination="false"
    :columns="columns"
    :data="tableData"
    :columnResizable="false"
    style="margin-top: 20px"
  >
    <template #col_status="{ item }">
      <!-- <a-tag :color="showStatus(item.record.statusId)?.color">
        {{ showStatus(item.record.statusId)?.label }}
      </a-tag> -->
      {{ showStatus(item.record.statusId)?.label }}
    </template>
    <!-- 库存编号 -->
    <!-- <template #col_stockNo="{ item }">
      <a-link> {{ item.record.entityCode }} </a-link>
    </template> -->
    <!-- 注册&批次信息 -->
    <!-- <template #col_productAndBatchInfo="{ item }">
          <a-tooltip :position="tooltipPosition">
            <template #content>
              <p class="tooltip-content-item" v-for="(str, index) in showProductAndBatchInfo(item.record)" :key="index">
                {{ str }}
              </p>
            </template>
            <a-tag>
              {{ item.record.batchName || item.record.productName }}
            </a-tag>
          </a-tooltip>
        </template> -->
    <!-- 入库样本类型 -->
    <template #col_sampleType="{ item }">
      <span>
        {{ item.record.sampleType ?? '' }}
      </span>
    </template>
    <!-- 存储容器 -->
    <!-- <template #col_locationPath="{ item }">
      <a-link> {{ item.record.locationPath }} </a-link>
    </template> -->
    <!-- 位置 -->
    <!-- <template #col_location="{ item }">
      <a-link> {{ item.record.location }} </a-link>
    </template> -->
    <!-- 入库时间 -->
    <template #col_time_confirmTime="{ item }">
      <span>
        {{ handleShowDynamicParam({ type: ParameterType.MOMENT, value: item.record.confirmTime }) }}
      </span>
    </template>
    <!-- 截止日期 -->
    <template #col_time_expirationDate="{ item }">
      <span>
        {{ handleShowDynamicParam({ type: ParameterType.MOMENT, value: item.record.expirationDate }) }}
      </span>
    </template>
  </BasicTable>
----------------------------comlus------------------
export const PRODUCT_COLUMNS: Array<TableColumnData> = [
  // {
  //   dataIndex: 'batchNo',
  //   title: 'ID',
  //   ellipsis: true,
  //   tooltip: true
  // },
  // {
  //   dataIndex: 'batchName',
  //   title: '批次名称',
  //   ellipsis: true,
  //   tooltip: true
  // },
  // {
  //   dataIndex: 'amount',
  //   title: '数量',
  //   ellipsis: true,
  //   tooltip: true
  // },
  // {
  //   dataIndex: 'customFields',
  //   title: '批次附加信息',
  //   slotName: 'batchExtra',
  //   ellipsis: true
  // }
  // {
  // {
  //   title: '序号',
  //   dataIndex: 'index',
  //   slotName: SERIAL_NUMBER,
  //   width: 80,
  //   customTitle: true,
  //   isShowFliter: false
  // },
  {
    title: '状态',
    dataIndex: 'statusId',
    width: 100,
    slotName: 'col_status'
  },
  {
    title: '系统库存编号',
    dataIndex: 'entityCode',
    width: 120,
    slotName: 'col_stockNo'
  },
  {
    title: '样本名称',
    dataIndex: 'prefix',
    width: 120
  },
  // {
  //   title: '注册&批次信息',
  //   dataIndex: 'productName',
  //   width: 130,
  //   slotName: 'col_productAndBatchInfo'
  // },
  {
    title: '入库样本类型',
    dataIndex: 'sampleType',
    width: 130,
    slotName: 'col_sampleType'
  },
  {
    title: '类型',
    dataIndex: 'productFrameName',
    width: 100
  },
  {
    title: '可使用量',
    dataIndex: 'capacity',
    width: 120
  },
  {
    title: '出库量',
    dataIndex: 'total',
    width: 80
  },
  {
    title: '量单位',
    dataIndex: 'unitName',
    width: 80
  },
  {
    title: '浓度',
    dataIndex: 'concentration',
    width: 80
  },
  {
    title: '浓度单位',
    dataIndex: 'concentrationUnit',
    width: 120
  },
  {
    title: '有效截止日期',
    dataIndex: 'expirationDate',
    slotName: 'col_time_expirationDate',
    width: 170
  },
  {
    title: '原存储容器',
    dataIndex: 'locationPath',
    width: 150,
    slotName: 'col_locationPath'
  },
  {
    title: '原位置',
    dataIndex: 'location',
    width: 80,
    slotName: 'col_location'
  },
  {
    title: '出库次数',
    dataIndex: 'outStockTimes',
    width: 120
  },
  {
    title: '返库次数',
    dataIndex: 'backStockTimes',
    width: 120
  },
  {
    title: '操作人',
    dataIndex: 'confirmMan',
    width: 100
  },
  {
    title: '操作时间',
    dataIndex: 'confirmTime',
    width: 170,
    slotName: 'col_time_confirmTime'
  }
]
```



## vue冒泡事件注意

* 在@事件.stop阻止冒泡事件中change.stop在原型上是没有的，是无用的

  解决方法:

```js
 <div @click.stop style="position: relative; width: 35px; height: 22px; align-self: center">
     <a-checkbox v-model="item.selectInfo" @change="getListInfoIds" />
 </div>
```

两个vue页面系统和成一个后的跳转

```js
location.href = `${location.protocol}//${location.host}/main/new-repertory/stock_location_case`
```



## async和await 注意事项

1. 其中用法和promise.then(（res）=> {}) 事项的方式一样，async在判断下面有无使用到await里面内容时才会进行阻塞判断，不然不会进行阻塞，还是共同异步

   ```js
     const handelSelected = async ({ value }, item) => {
       if (value !== item.status) {
         const getDataInfo = await updataTodoInto({
           id: item.id,
           status: value
         })
         if (getDataInfo.code == 200) {
           emit('updataList')
         }
       }
     }
   ```

   不加判断则永远会执行异步操作



bug注意事项： 消息框有个标签，

在1440分辨率上有系统样式问题







## 日历







## a-from 使用 repeatPassword.vue

```js
<template>
  <div class="login-box">
    <div class="login-middle">
      <p class="set-title">设置密码</p>
      <p class="set-tip">请修改密码再登录账号</p>
      <p class="set-password-tip">密码仅可由数字、英文字母或英文符号组成，且需包含此三种类型,长度不少于8个字符</p>
      <div class="login-form-wrapper">
        <a-form layout="vertical" :model="setForm" :rules="setRules" class="login-form" ref="setFormRef">
          <a-form-item class="login-items" field="oldPwd">
            <a-input
              v-model="setForm.oldPwd"
              class="login-inputs"
              size="large"
              ref="elPasswordOld"
              :type="passwordTypeOld"
              placeholder="请输入旧密码"
              autocomplete="off"
              @input="sumbitFlight"
            >
              <template #suffix>
                <span class="show-pwd" @click="oldPwd">
                  <icon-eye-invisible v-if="passwordTypeOld === 'password'" />
                  <icon-eye v-else />
                </span>
              </template>
            </a-input>
          </a-form-item>

          <a-tooltip
            :popup-visible="capsTooltip"
            :content="capsTooltip == true ? '大写锁定已经打开' : ''"
            position="right"
          >
            <a-form-item class="login-items" field="password">
              <a-input
                v-model="setForm.password"
                class="login-inputs"
                size="large"
                ref="elPasswordSet"
                :type="passwordTypeSet"
                placeholder="请输入密码"
                autocomplete="off"
                @keyup="checkCapslock"
                @blur="capsTooltip = false"
                @input="sumbitFlight"
              >
                <template #suffix>
                  <span class="show-pwd" @click="setPwd">
                    <icon-eye-invisible v-if="passwordTypeSet === 'password'" />
                    <icon-eye v-else />
                  </span>
                </template>
              </a-input>
            </a-form-item>
          </a-tooltip>
          <a-form-item class="login-items" field="repeatPwd">
            <a-input
              v-model="setForm.repeatPwd"
              class="login-inputs"
              size="large"
              ref="elPasswordRepeat"
              :type="passwordTypeRepeat"
              placeholder="再次输入密码"
              autocomplete="off"
              @input="sumbitFlight"
            >
              <template #suffix>
                <span class="show-pwd" @click="repeatPwd">
                  <icon-eye-invisible v-if="passwordTypeRepeat === 'password'" />
                  <icon-eye v-else />
                </span>
              </template>
            </a-input>
          </a-form-item>
          <a-button
            type="primary"
            style="width: 100%; margin-top: 16px; height: 48px; font-weight: 500; font-size: 14px; border-radius: 3px"
            :disabled="defineFlag"
            @click="handleSetPwd"
            >确定
          </a-button>
        </a-form>
      </div>
    </div>
  </div>
</template>
<script setup lang="ts">
  import { reactive, ref } from 'vue'
  import { updatePassword } from '@/api/systemcenter/login'
  import Message from '@/components/Message'
  // import { localCache } from '@/util'
  import { clearLocalStorage } from '@/util/cache/clearLocalStorage'
  interface Props {
    visible: { flag: Boolean }
  }

  const props = defineProps<Props>()
  const capsTooltip = ref<boolean>(false)

  const passwordTypeSet = ref<'password' | 'text' | undefined>('password')
  const passwordTypeRepeat = ref<'password' | 'text' | undefined>('password')
  const passwordTypeOld = ref<'password' | 'text' | undefined>('password')

  const setForm = reactive({
    oldPwd: '',
    password: '',
    repeatPwd: ''
  })

  const elPasswordSet = ref<HTMLElement | null>(null)
  const elPasswordRepeat = ref<HTMLElement | null>(null)
  const elPasswordOld = ref<HTMLElement | null>(null)

  const setFormRef = ref()

  // 控制确定按钮可击
  const defineFlag = ref<boolean>(true)

  const setPwd = () => {
    if (passwordTypeSet.value === 'password') {
      passwordTypeSet.value = 'text'
    } else {
      passwordTypeSet.value = 'password'
    }
    elPasswordSet.value?.focus()
  }

  const repeatPwd = () => {
    if (passwordTypeRepeat.value === 'password') {
      passwordTypeRepeat.value = 'text'
    } else {
      passwordTypeRepeat.value = 'password'
    }
    elPasswordRepeat.value?.focus()
  }

  const oldPwd = () => {
    if (passwordTypeOld.value === 'password') {
      passwordTypeOld.value = 'text'
    } else {
      passwordTypeOld.value = 'password'
    }
    elPasswordOld.value?.focus()
  }

  const validatePwd = (value, callback) => {
    // const regx = /^(?=.*\d)(?=.*[a-zA-Z])(?=.*[~!@#$%^&*])[\da-zA-Z~!@#$%^&*]{8,}$/
    const regx = /^(?=.*[a-zA-z])(?=.*\d)(?=.*[!@#$%^&*.])[a-zA-Z\d!@#$%^&*.]{8,16}$/
    if (regx.test(value)) {
      callback()
    } else {
      callback(new Error('格式不正确'))
    }
  }
  const validateRepeat = (value, callback) => {
    if (value === setForm.password) {
      callback()
    } else {
      callback(new Error('输入不一致'))
    }
  }

  const validateOld = (value, callback) => {
    if (value?.length >= 8) {
      callback()
    } else {
      callback(new Error('格式不正确'))
    }
  }

  const setRules = reactive({
    password: [
      {
        validator: validatePwd,
        trigger: 'blur'
      }
    ],
    repeatPwd: [
      {
        validator: validateRepeat,
        trigger: 'blur'
      }
    ],
    oldPwd: [
      {
        validator: validateOld,
        trigger: 'blur'
      }
    ]
  })
  const checkCapslock = (e) => {
    const { key } = e
    capsTooltip.value = key && key.length === 1 && key >= 'A' && key <= 'Z'
  }

  const sumbitFlight = () => {
    // let isSuccess = false
    // setFormRef.value.validate(async (e) => {
    //   if (e === undefined) isSuccess = true
    //   if (!isSuccess) {
    //     defineFlag.value = true
    //   } else {
    //     defineFlag.value = false
    //   }
    // })

    if (setForm.oldPwd !== '' && setForm.password !== '' && setForm.repeatPwd !== '') {
      defineFlag.value = false
    } else {
      defineFlag.value = true
    }
  }
  // 浏览器回退事件
  window.addEventListener('popstate', function () {
    location.reload()
  })
  const handleSetPwd = async () => {
    let isSuccess = false
    setFormRef.value.validate(async (e) => {
      if (e === undefined) isSuccess = true
      if (!isSuccess) return

      // updateUserInfo()
      const passwordInfo = {
        newPassword: '',
        originalPassword: '',
        confirmPassword: ''
      }
      passwordInfo.newPassword = setForm.password
      passwordInfo.originalPassword = setForm.oldPwd
      passwordInfo.confirmPassword = setForm.repeatPwd
      const res = await updatePassword(passwordInfo)
      if (res.code === '200') {
        props.visible.flag = true
        clearLocalStorage()
      } else {
        Message({
          type: 'error',
          content: res.message ?? '输入密码错误'
        })
      }
    })
  }
</script>
<style lang="scss" scoped>
/---------------样式删除自己修改
</style>

```



## 使用tsx、jsx把vue组件变成可以使用原生js的innerHtml添加的形式

定义：

```tsx
import { Button } from '@arco-design/web-vue'
import { createApp } from 'vue'
export const Test = (str: string) => {
  const Com = <Button>{str}</Button>
  const _instance = createApp(Com)
  const fg = document.createElement('root')
  _instance.mount(fg)
  return fg
}
```

在日历属性中添加

```js
 eventContent: (eventInfo) => {
      console.log(eventInfo)
      const fg = Test('斑马鱼')
      return { html: fg.outerHTML }
    }
```





日历接口先隐藏

## vue3 Fullcalendar日历表功能和组件使用

注意看一个开源组件看组件提供方法，和组件提供事件，和组件属性

Fullcalendar官网：https://juejin.cn/post/6968360033436467236

```vue
<template>
  <div style="width: 100%">
    <div class="header-btn">
      <div>
        <a-space>
          <a-button-group>
            <a-button @click="changeMouth" :type="colorList[0]"> 月 </a-button>
            <a-button @click="changeWeek" :type="colorList[1]"> 周 </a-button>
            <a-button @click="changeDay" :type="colorList[2]"> 日 </a-button>
          </a-button-group>
          <a-button @click="changeToday"> 今天 </a-button>
          <span @click="changePrev" class="icon-lr"><icon-left /></span>
          <span @click="changeNext" class="icon-lr"><icon-right /></span>
          <span class="date-time">{{ headerTilte }}</span>
        </a-space>
      </div>
      <!-- <NewRightBtn @click="clickBtn" /> -->
    </div>
    <!-- <span @click="handleClick">哈哈</span> -->
    <div class="tabs" :style="`width:100%`">
    <FullCalendar v-if="visible" :options="calendarOptions" ref="fullCalendar">
        <template #eventContent="{ event }">
          <a-trigger
            trigger="click"
            :unmount-on-close="false"
            position="right"
            :popup-visible="event.extendedProps.isOpen"
          >
            <div style="color: #42526e" class="event-content" @click.stop="openCard(event.id)">
              <a-avatar :style="{ backgroundColor: '#7BC616' }" :size="5" />
              <span class="content-span">{{ changeTime(event.start) }} {{ event.title }}</span>
            </div>
            <template #content>
              <div class="demo-basic">
                <CalendarCardEvent :event="event" @close-card="closeCard(event.id)" />
              </div>
            </template>
          </a-trigger>
        </template>
      </FullCalendar>
    </div>
  </div>
</template>
<script setup lang="ts">
  import { ref, reactive, onMounted, watch } from 'vue'
  import '@fullcalendar/core/vdom' // solve problem with Vite
  import FullCalendar, { EventApi } from '@fullcalendar/vue3' //DateSelectArg 添加select事件 EventClickArg 点击事件
  import dayGridPlugin from '@fullcalendar/daygrid'
  import timeGridPlugin from '@fullcalendar/timegrid'
  import interactionPlugin from '@fullcalendar/interaction'
  import zhCnLocale from '@fullcalendar/core/locales/zh-cn'
  // import { createEventId } from './util/event-utils'
  // import NewRightBtn from './components/newRightBtn.vue' //新建日程按钮
  import { Test } from './Test'
  const colorList = ref<Array<string | undefined>>(['primary', undefined, undefined])
  const visible = ref<boolean>(false)
  const calendarRightHeight = ref<number>(1000)
  const fullCalendar = ref<InstanceType<typeof FullCalendar>>()
  let instance = ref<any>()

  const Props = defineProps<{
    eventsList: any
  }>()
  const currentEvents = ref<EventApi[]>([]) // 只用于读取每一个单元格的事件内容
  const calendarOptions = reactive({
    plugins: [
      //安装的插件
      dayGridPlugin,
      timeGridPlugin,
      interactionPlugin // needed for dateClick
    ],
    // customButtons: {
    //   myCustomButton: {
    //     text: '新建日程!',
    //     click: function () {
    //       alert('clicked the custom button!')
    //     }
    //   }
    // },
    // headerToolbar: {
    //   //头部配置
    //   right: '',
    //   center: 'title',
    //   left: 'dayGridMonth,timeGridWeek,timeGridDay prev,next today'
    // },
    headerToolbar: null,
    initialView: 'dayGridMonth', //默认选择月份
    // initialEvents: INITIAL_EVENTS, // alternatively, use the `events` setting to fetch from a feed 未知 用于初始化时间
    editable: false, //可编辑表格 也是是否允许拖拽
    selectable: true, //是否允许用户单击或者拖拽日历中的天和时间隙。
    selectMirror: true,
    dayMaxEvents: true, // 限制事件数量
    weekends: true, //是否显示一周七天
    handleWindowResize: true, //随浏览器窗口变化
    // width: 1000,
    height: calendarRightHeight, //日期表格高度
    locale: zhCnLocale, //汉化文字,
    events: [
      //可以添加事件列表
      // {
      //   id: createEventId(),
      //   title: 'Timednt',
      //   start: '2022-09-15' + 'T12:00:00',
      //   end: '2022-09-15' + 'T12:30:00'
      //   // peple: '刘mis'
      // },
      // {
      //   id: createEventId(),
      //   title: 'Tim',
      //   start: '2022-09-15' + 'T12:00:00',
      //   end: '2022-09-15' + 'T12:30:00'
      //   // peple: '刘mis'
      // }
    ],

    // 事件
    // select: handleDateSelect, //选择单元格填入内容事件
    // eventClick: handleEventClick, // 单击信息事件
    eventsSet: handleEvents, // 点击任意数据发生变化时触发事件
    eventMouseEnter: handleEventMouseEnter, // 鼠标悬停单个事件上时触发
    eventContent: (eventInfo) => {
      // 改变事件的默认填入内容样式发 使用vue组件
      const fg = Test(eventInfo.event)
      return { html: fg.outerHTML }
    }
  })
  const headerTilte = ref<string>() //头部显示时间信息

  // 点击新建按钮事件
  // const emit = defineEmits(['clickButton'])

  // function write(title, calendarApi, selectInfo) {
  //   calendarApi.unselect() // clear date selection

  //   if (title) {
  //     calendarApi.addEvent({
  //       id: createEventId(), //事件id
  //       title, // 事件内容
  //       start: selectInfo.startStr, //开始时间
  //       end: selectInfo.endStr, //结束时间
  //       allDay: false //是否为全天
  //     })
  //   }
  // }
  // 选择填入事件内容
  // function handleDateSelect(selectInfo: DateSelectArg) {
  //   let title = prompt('Please enter a new title for your event')
  //   // let calendarApi = selectInfo.view.calendar
  //   let calendarApi = instance.value.view.calendar
  //   write(title, calendarApi, selectInfo)
  // }
  // 单击信息事件 删除

  //
  // function handleEventClick(clickInfo: EventClickArg) {
  //   calendarOptions.events[0].title = '1111'
  //   console.log(clickInfo.event) //可以自己添加属性
  //   if (confirm(`Are you sure you want to delete the event '${clickInfo.event.title}'`)) {
  //     clickInfo.event.remove()
  //   }
  // }

  // 暴漏出的添加事件
  // function addEventInfo(eventInfo: {
  //   id: string | number
  //   title: string
  //   start: string
  //   end: string
  //   players: string
  // }) {
  //   instance.value.addEvent({
  //     ...eventInfo,
  //     allDay: false //是否为全天
  //   })
  // }
  // 只用于读取每一个单元格的事件内容
  function handleEvents(event: EventApi[]) {
    changeDateTime()

    currentEvents.value = event
  }

  // 鼠标悬停单个事件上时触发(只能用来获取不能修改,里面的元素能修改)
  function handleEventMouseEnter() {
    // console.log(mouseEnterInfo)
  }

  // const handleClick = () => {
  //   calendarOptions.events.push({
  //     id: createEventId(),
  //     title: 'Timed event',
  //     start: '2022-09-12' + 'T12:00:00',
  //     end: '2022-09-15' + 'T12:30:00'
  //   })
  // }

  // 点击跳转月view
  const changeMouth = () => {
    instance.value?.changeView('dayGridMonth')
    colorList.value.forEach((item, index) => {
      if (index == 0) {
        colorList.value[index] = 'primary'
      } else {
        colorList.value[index] = undefined
      }
    })
    changeDateTime()
  }
  // 点击跳转周view
  const changeWeek = () => {
    instance.value?.changeView('timeGridWeek')
    colorList.value.forEach((item, index) => {
      if (index == 1) {
        colorList.value[index] = 'primary'
      } else {
        colorList.value[index] = undefined
      }
    })
    changeDateTime()
  }
  // 点击跳转每日
  const changeDay = () => {
    instance.value?.changeView('timeGridDay')
    colorList.value.forEach((item, index) => {
      if (index == 2) {
        colorList.value[index] = 'primary'
      } else {
        colorList.value[index] = undefined
      }
    })
    changeDateTime()
  }
  // 点击跳转上一页
  const changePrev = () => {
    instance.value?.prev()
  }
  // 跳转到下一页
  const changeNext = () => {
    instance.value?.next()
  }
  // 跳转到今天
  const changeToday = () => {
    instance.value?.today()
  }
  // 点击按钮触发日期改变事件
  const changeDateTime = () => {
    instance.value = fullCalendar.value?.getApi()
    const view = instance.value.view
    headerTilte.value = view.title
  }

  // 点击跳转指定时间
  const searchTime = (time: string) => {
    instance.value?.gotoDate(time)
  }
  watch(
    () => Props.eventsList,
    () => {
      const strArr = ['预约主题', '开始时间', '结束时间', '预约人']
      calendarOptions.events = Props.eventsList?.map((item) => {
        const paramsList = item?.params?.filter((it) => {
          return strArr.includes(it.paramName)
        })
        return {
          id: item.id,
          title: paramsList[0]?.paramValues?.join(''),
          start: paramsList[1]?.paramValues[0],
          end: paramsList[2]?.paramValues[0] + 'T23:59:59',
          players: paramsList[3]?.paramValues[0],
          allDay: false
        }
      })
    },
    {
      immediate: true,
      deep: true
    }
  )
  // 页面初始化页面
  onMounted(() => {
    setTimeout(() => {
      visible.value = true
    }, 200)
  })

  // 抛出跳转到固定时间事件
  defineExpose({
    searchTime
  })
  // 点击新建按钮触发
  // const clickBtn = () => {
  //   emit('clickButton')
  // }
  // const handleClick = () => {
  //   const instance = fullCalendar.value?.getApi()
  //   instance.changeView('timeGridWeek')
  //   const view = instance.view
  //   console.log(view.title)
  //   // const date = instance.getDate()
  //   // console.log(date.toISOString())
  // }

  // const renderEventContent = (eventInfo) => {
  //   console.log(eventInfo)
  //   return 'hello'
  // }
  // defineExpose({
  //   addEventInfo
  // })
</script>
<style lang="scss" scoped>
<!--------------------------------------自己发挥
</style>

```

## Fullcalendar日历与组件jsx报错”爆红”解决

因为Fullcalendar内部volod文件可能与其他组件库里面的东西有冲突，所以删除node_modules文件下所下载的依赖包**@Fullcalendar**.文件下所有文件下的文件名.d.ts定义类型文件，这样就解决爆红问题(其实只删除volom.d.ts):

注意：可能上述文件名不对，差不多类似v开头



## Fullcalendar日历组件eventContent插槽注意事项

 // 因为日历的组件事件插槽与日历并不是父子关系所以使用不了全局组件arco,需要一个一个引入

**重新引入Arco组件**

```
  import { IconClose } from '@arco-design/web-vue/es/icon'
  import {
    Descriptions as ADescriptions,
    DescriptionsItem as ADescriptionsItem,
    Avatar as AAvatar
  } from '@arco-design/web-vue'
  import { changeWeek } from '../calendar/const'
```

* 注意不能在任何调用vue日历组件里再调用异步方法，不然就会造成组件卡顿，需要有赋值操作要从父组件传值





## 下拉触底useInfiniteScroll（易览笔记）



## page改变之hy

producation

import.meta.env.MODE === 'development'  // 判断是否是生产环境

import.meta.env.MODE === 'hy'   // 判断环境是否为hy

### 打包(hy and 燃石) 

现在tag-0930 打包 feta-1028分支开发





## 取消上次的axios的请求(防止请求时间长的数据覆盖短的)

（vue） 已有申请变量 source

```js
import axios from 'axios'

data(){
return {
      CancelToken: axios.CancelToken,
      source: undefined
}
}

methods:{
 ...()=> {
     //阻止上次请求记录
 	if (this.source) {
         this.source.cancel()
       }
 	this.source = this.CancelToken.source()
    const cancelToken = this.source.token
	const { data } = await queryInstancesByParentIds(
            {
              jobIdList: [
                {
                  jobId: this.recordData?.id,
                  jobType: this.recordData?.jobType
                }
              ]
            },
            cancelToken
          )
}
}
```

```js
//接口方法
export function queryInstancesByParentIds(data,cancelToken) {
  return request({
    url: '/api/banmayu/instanceNode/queryInstancesByParentIds',
    method:'post',
    data,
    cancelToken
  })
}
```

cancelToken为上次提交的token值



## vue组件表格返回值注意

* vue组件表格中返回的item与对象值也是响应式的，无论vue2 或 vue3



## a-table递增的列表序号值

（{rowIndex} ）=> rowIndex + 1

```
  const columns = ref<TableColumnData[]>([
    {
      title: '序号',
      render: ({ rowIndex }) => rowIndex + 1,
      width: 80
    },
    {
      title: '扫码编号',
      dataIndex: 'scanNumber'
    },
    {
      title: '状态',
      dataIndex: 'dataStatus',
      width: 100,
      slotName: 'dataStatus'
    },
    {
      title: '扫码时间',
      dataIndex: 'scanTime',
      width: 180
    }
  ])
```

## vue深层组件渲染类的写法

**vue2:**

```html
<style>
    ::v-deep .className{}
</style>
```

**vue3:**

```html
<style>
    :deep(.className) {}
</style>
```



## 表单简单校验

```js
const setRules = ref({
    title: [
      {
        required: true,
        message: '未填写设备预约的主题',
        trigger: 'blur'
      }
    ],
    players: [
      {
        required: true,
        validator: validatePlayer,
        trigger: 'blur'
      }
    ],
    rangeValue: [
      {
        required: true,
        validator: validateRangeValue,
        trigger: 'change'
      }
    ]
  })
```

sdf





## React(hook)组件套用

**组件套用**

父组件

```js
  const refRescondBias = useRef(null);
 const approvalBiasOk = (reason) => {
    console.log(reason);
    masterProps.store.setGlobalState({ showAuditModalBias: false });
    refRescondBias.current?.openModal()
  }

 <!--------------------------------------------------------------------->
    <SecondaryPwdBias ref={refRescondBias} />

```



子组件

```js
import { useState, useImperativeHandle, forwardRef, Ref, useContext  } from 'react';

export const SecondaryPwdBias: React.FC<any> = forwardRef((props, ref: Ref<any>) => {
    const openModal = () => {
    setPwdVisible(true)
    // createApprove()
  }
  useImperativeHandle(ref,() => {
    return {
      openModal
    }
  })
  return (
      <SecondaryPwdModal
        visible={pwdVisible}
        successCallBack={secondaryPwdCallBack}
        onCancel={secondaryPwdCancel}
        signActionType={SignActionTypeEnum.START_APPROVE}
      />
  );
}
```

## Promise.finally()作用

```js
const updataBatchList = () => {
    batchInfo.value?.getBatchList().finally(() => {
      Message({
        content: '操作成功',
        type: 'success'
      })
    })
  }
```



### promise的抛出异常的接口处理继续执行

```js
  const pressEnter = async () => {
    if (inputValue.value && inputValue.value !== '') {
      let codeStatus: ApproveTemplateOpenEnum = ApproveTemplateOpenEnum.OPEN
      await specialCommit({
        stockActionCategory: ViewTableNumberEnum[props.currentNodeType],
        trackId: inputValue.value
      })
        .catch(() => {
          codeStatus = ApproveTemplateOpenEnum.CLOSED
        })
        .finally(() => {
          tableDate.value?.push({
            scanNumber: inputValue.value,
            dataStatus: codeStatus,
            scanTime: moment(new Date()).format('YYYY-MM-DD HH:mm:ss')
          })
          inputValue.value = undefined
        })
    } else {
      Message({
        content: '未填入扫码信息',
        duration: 2 * 1000,
        type: 'error'
      })
    }
```

finnal无论抛出什么异常浏览器报错都会继续执行，catch抛出异常会执行，

在抛出catch之后下面的代码都会执行，不会被阻断



## 使用淘宝镜像源(加注意)

pnpm install --registry=https://registry.npm.taobao.org

当install报错的时候很可能是因为文件有包被阻塞锁死，所以把node_module全部删了，再重新加载

一般后端再更新如增加一列数据的时候，如果id传入的是（-）负数那么默认为新增一列，如果是正数变为正常修改



## Pinia（使用）

使用可以把一个存储的数据变为响应式的

```js
const { loading, list, totalRecords } = storeToRefs(categoryStore)
```

* 想在文件中使用时，一般要在方法中使用，要直接在文件用引入可能就会报错，因为系统可能识别不到他在vue中的使用

## 使用缓存router-view

```html
      <router-view v-slot="{ Component }">
        <keep-alive>
          <component
            :is="Component"
            :allCount="allCount"
            :readCount="readCount"
            :unreadCount="unreadCount"
            @updateMessage="updateMessage"
          />
        </keep-alive>
      </router-view>
```

## Promise阻断运行同步代码

注意在一个接口使用catch时代码并不会被阻塞，所以下面代码还回执行，要手动执行Promise.reject('')

```js
     await createBatch(createBatchInfo).catch(() => {
        callback({ error: true })
        return Promise.reject('')
      })
```

## arco的unload本地上传

可以直接根据actionUrl属性发送请求

```js
  
<a-upload :action="actionUrl" :show-file-list="false" multiple @change="handleChangeUpload" v-if="visible">
            <template #upload-button>
              <a-button type="primary">
                <template #icon>
                  <icon-upload />
                </template>
                点击导入库位
              </a-button>
            </template>
 </a-upload> 


-------------------------------vue-------------------------------------------------
const actionUrl = computed(() => {
    return import.meta.env.VITE_BASE_URL_MATERIAL + `/api/banmayu/material/stock/structure/parseStockExcel`
  })

  // 改变导入文件时触发
  const handleChangeUpload = (files: Array<FileItem>) => {
    let tableList: any[] = []
    files?.forEach((item) => {
      tableList = tableList.concat(item.response?.data)
    })
    data.value = tableList
  }
```

## 下载调取接口导出文件为excel方法

```js
<!-----
fileName:文件名
relativePath:相对路径获得后缀 必传
----->
export const downloadFile = async (
  { fileName, relativePath }: { fileName?: string; relativePath: string },
  callback: (...args: any[]) => void = getFile,
  params?: any
) => {
  const _params = params ? params : { fileUrl: relativePath }
  const res = await callback(_params)
  const disposition = (res as any).headers['content-disposition'].split(';')
  const _fileName = disposition[1].split('=')[1]
  const contentType = getMIME(relativePath)
  const fileUrl = window.URL.createObjectURL(
    new Blob([(res as any).data as unknown as BlobPart], { type: contentType })
  )
  <!---------下面为主要对上面生成文件url下载代码---------------->
  const link = document.createElement('a')
  link.style.display = 'none'
  link.href = fileUrl
  link.setAttribute('download', decodeURIComponent(fileName ?? _fileName)) //文件名
  document.body.appendChild(link)
  link.click()
  window.URL.revokeObjectURL(link.href)
  document.body.removeChild(link)
}
```

```js
<!------------其中使用的方法---------------->
export const getMIME = (fileName: string) => {
  const fileExtension = fileName.includes('.') ? fileName.substring(fileName.lastIndexOf('.') + 1) : fileName
  if ('bmp' === fileExtension) {
    return 'image/bmp'
  }
  if ('gif' === fileExtension) {
    return 'image/gif'
  }
  if ('jpeg' === fileExtension || 'jpg' === fileExtension || 'png' === fileExtension) {
    return 'image/jpeg'
  }
  if ('html' === fileExtension) {
    return 'text/html'
  }
  if ('txt' === fileExtension) {
    return 'text/plain'
  }
  if ('vsd' === fileExtension) {
    return 'application/vnd.visio'
  }
  if ('ppt' === fileExtension || 'pptx' === fileExtension) {
    return 'application/vnd.ms-powerpoint'
  }
  if ('doc' === fileExtension || 'docx' === fileExtension) {
    return 'application/msword'
  }
  if ('xls' === fileExtension || 'xlsx' === fileExtension) {
    return 'application/x-xls'
  }
  if ('pdf' === fileExtension) {
    return 'application/pdf'
  }
  if ('zip' === fileExtension) {
    return 'application/x-zip-compressed'
  }
  if ('rar' === fileExtension) {
    return 'application/octet-stream'
  }
  if ('xml' === fileExtension) {
    return 'text/xml'
  }
  if ('mp3' === fileExtension || 'm4a' === fileExtension) {
    return 'audio/mpeg'
  }
  if ('mp4' === fileExtension) {
    return 'video/mpeg4'
  }
  return 'text/html'
}

```



## :deep()使用注意

在使用modal模态框的内部样式改变时，需要改变其挂载点的位置，要挂载在当前组件内html标签中，不然不生效



## 流程图

网址:[简介 | X6 (antv.vision)](https://x6.antv.vision/zh/docs/tutorial/about)

## 使用AndV X6

**引用文件**

```
import insertCss from 'insert-css'
import { Graph, Addon, Shape, Dom } from '@antv/x6'
import '@antv/x6-vue-shape'
import NodeInfo from './NodesInfo.vue'
```

**书写类FlowRelationGraph**  tsx文件

```tsx
// 流程图配置文件
import insertCss from 'insert-css'
import { Graph, Addon, Shape, Dom } from '@antv/x6'
import { DagreLayout } from '@antv/layout'
// import { ref } from 'vue'
import '@antv/x6-vue-shape'
import NodeInfo from './NodesInfo.vue'
import { isFunction } from 'lodash'
// 配置锚点
export const ports = {
  groups: {
    top: {
      position: 'top',
      attrs: {
        circle: {
          r: 4,
          magnet: true,
          stroke: 'black',
          strokeWidth: 1,
          fill: '#fff',
          style: {
            visibility: 'hidden'
          }
        }
      }
    },
    right: {
      position: 'right',
      attrs: {
        circle: {
          r: 4,
          magnet: true,
          stroke: 'black',
          strokeWidth: 1,
          fill: '#fff',
          style: {
            visibility: 'hidden'
          }
        }
      }
    },
    bottom: {
      position: 'bottom',
      attrs: {
        circle: {
          r: 4,
          magnet: true,
          stroke: 'black',
          strokeWidth: 1,
          fill: '#fff',
          style: {
            visibility: 'hidden'
          }
        }
      }
    },
    left: {
      position: 'left',
      attrs: {
        circle: {
          r: 4,
          magnet: true,
          stroke: 'black',
          strokeWidth: 1,
          fill: '#fff',
          style: {
            visibility: 'hidden'
          }
        }
      }
    }
  },
  items: [
    {
      group: 'top'
    },
    {
      group: 'right'
    },
    {
      group: 'bottom'
    },
    {
      group: 'left'
    }
  ]
}

export const TaskFlowchartCss = () => {
  insertCss(`
.node {
  padding:0 5px 0 10px;
}

.x6-edge-selected {
  outline: 2px dashed  #feb663;
}
`)
}
// #graph-container {
//   width: calc(100% - 180px) ;
//   height: 100%  ;
//   overflow: auto;
// }

// export const getTaskFlowChartNews = (donContainer: any) => {
//   const graph = ref()
//   const dnd = ref()

//   // 配置流程图信息
//   graph.value = new Graph({
//     container: document.getElementById('graph-container') as HTMLElement,
//     grid: true, // 是否未网格页面
//     //鼠标滚轮ctrl+放大页面
//     mousewheel: {
//       enabled: true,
//       zoomAtMousePosition: true,
//       modifiers: 'ctrl',
//       minScale: 0.5,
//       maxScale: 3
//     },
//     //连接线设置
//     connecting: {
//       router: {
//         name: 'normal',
//         args: {
//           padding: 1
//         }
//       },
//       connector: {
//         name: 'rounded',
//         args: {
//           radius: 8
//         }
//       },
//       anchor: 'center',
//       connectionPoint: 'anchor',
//       allowBlank: false,
//       snap: {
//         radius: 20
//       },
//       createEdge() {
//         return new Shape.Edge({
//           attrs: {
//             line: {
//               stroke: 'black',
//               strokeWidth: 2,
//               targetMarker: {
//                 name: 'block',
//                 width: 12,
//                 height: 8
//               }
//             }
//           },
//           zIndex: 0
//         })
//       },
//       validateConnection({ targetMagnet }) {
//         return !!targetMagnet
//       }
//     },
//     //连接锚点高亮
//     highlighting: {
//       magnetAdsorbed: {
//         name: 'stroke',
//         args: {
//           attrs: {
//             fill: '#fff',
//             stroke: '#31d0c6',
//             strokeWidth: 4
//           }
//         }
//       }
//     },
//     resizing: true, // 节点是否支持缩放调整
//     rotating: false, //节点是否支持旋转调整
//     //是否支持选择节点和范围选择
//     selecting: {
//       enabled: true,
//       rubberband: true,
//       showNodeSelectionBox: true
//     },
//     snapline: true, //辅助对齐线开启
//     keyboard: true, // 支持按钮点击事件
//     clipboard: true //支持复制和剪切
//   })
//   // 配置右侧自定义拖拽
//   dnd.value = new Addon.Dnd({
//     target: graph.value,
//     scaled: false,
//     animation: true,
//     dndContainer: donContainer as any,
//     validateNode(droppingNode, options) {
//       return droppingNode.shape === 'html'
//         ? new Promise<boolean>((resolve) => {
//             const { draggingNode, draggingGraph } = options
//             const view = draggingGraph.findView(draggingNode)!
//             const contentElem = view.findOne('foreignObject > body > div')
//             Dom.addClass(contentElem, 'validating')
//             setTimeout(() => {
//               Dom.removeClass(contentElem, 'validating')
//               resolve(true)
//             })
//           })
//         : true
//     }
//   })
//   // #region 初始化 stencil
//   // const stencil = new Addon.Stencil({
//   //   title: '流程图',
//   //   target: graph.value,
//   //   stencilGraphWidth: 300,
//   //   stencilGraphHeight: 180,
//   //   collapsable: false,
//   //   groups: [
//   //     {
//   //       title: 'protocol模板节点',
//   //       name: 'group1'
//   //     },
//   //     {
//   //       title: '任务模板节点',
//   //       name: 'group2',
//   //       graphHeight: 250,
//   //       layoutOptions: {
//   //         rowHeight: 70
//   //       },
//   //       collapsable: false
//   //     }
//   //   ],
//   //   layoutOptions: {
//   //     columns: 2,
//   //     columnWidth: 80,
//   //     rowHeight: 55
//   //   }
//   // })
//   // document.getElementById('stencil')!.appendChild(stencil.container)

//   // #region 快捷键与事件
//   // 支持按钮cope和剪切
//   graph.value.bindKey(['meta+c', 'ctrl+c'], () => {
//     const cells = graph.value.getSelectedCells()
//     if (cells.length) {
//       graph.value.copy(cells)
//     }
//     return false
//   })
//   graph.value.bindKey(['meta+x', 'ctrl+x'], () => {
//     const cells = graph.value.getSelectedCells()
//     if (cells.length) {
//       graph.value.cut(cells)
//     }
//     return false
//   })
//   graph.value.bindKey(['meta+v', 'ctrl+v'], () => {
//     if (!graph.value.isClipboardEmpty()) {
//       const cells = graph.value.paste({ offset: 32 })
//       graph.value.cleanSelection()
//       graph.value.select(cells)
//     }
//     return false
//   })
//   // select all
//   graph.value.bindKey(['meta+a', 'ctrl+a'], () => {
//     const nodes = graph.value.getNodes()
//     if (nodes) {
//       graph.value.select(nodes)
//     }
//   })
//   //delete
//   graph.value.bindKey('backspace', () => {
//     const cells = graph.value.getSelectedCells()
//     if (cells.length) {
//       graph.value.removeCells(cells)
//     }
//   })

//   // 控制连接桩显示/隐藏
//   const showPorts = (ports: NodeListOf<SVGElement>, show: boolean) => {
//     for (let i = 0, len = ports.length; i < len; i = i + 1) {
//       ports[i].style.visibility = show ? 'visible' : 'hidden'
//     }
//   }
//   graph.value.on('node:mouseenter', () => {
//     const container = document.getElementById('graph-container')!
//     const ports = container.querySelectorAll('.x6-port-body') as NodeListOf<SVGElement>
//     showPorts(ports, true)
//   })
//   graph.value.on('node:mouseleave', () => {
//     const container = document.getElementById('graph-container')!
//     const ports = container.querySelectorAll('.x6-port-body') as NodeListOf<SVGElement>
//     showPorts(ports, false)
//   })

//   // 使用方法可以添加节点和存入信息
//   // graph.value.fromJSON({
//   //   nodes: [
//   //     {
//   //       id: 'node1',
//   //       x: 40,
//   //       y: 40,
//   //       width: 200,
//   //       height: 60,
//   //       shape: 'html',
//   //       html: () => {
//   //         const wrap = document.createElement('div')
//   //         wrap.className = 'node'
//   //         wrap.style.width = '100%'
//   //         wrap.style.height = '100%'
//   //         wrap.style.display = 'flex'
//   //         wrap.style.alignItems = 'center'
//   //         wrap.style.borderLeft = '5px solid rgb(49, 208, 198)'
//   //         wrap.style.background = '#fff'
//   //         wrap.style.boxShadow = '0px 2px 8px rgba(107, 119, 140, 0.1)'
//   //         wrap.style.borderRadius = '2px'
//   //         wrap.innerText = '测试'
//   //         return wrap
//   //       },
//   //       ports: { ...ports },

//   //       data: {
//   //         xxx: 'xxx'
//   //       }
//   //     }
//   //   ]
//   // })
//   // console.log(graph.value.getNodes())

//   //点击node节点触发事件
//   // graph.value.on('node:click', () => {})
//   // #region 初始化图形

//   // //注册节点
//   // Graph.registerNode(
//   //   'custom-rect',
//   //   {
//   //     inherit: 'rect',
//   //     width: 66,
//   //     height: 36,
//   //     attrs: {
//   //       body: {},
//   //       text: {
//   //         fontSize: 12,
//   //         fill: '#262626'
//   //       }
//   //     },
//   //     ports: { ...ports }
//   //   },
//   //   true
//   // )
//   // const r1 = graph.value.createNode({
//   //   shape: 'custom-rect',
//   //   label: '开始'
//   // })
//   // stencil.load([r1], 'group1')
//   return {
//     graph: graph.value,
//     dnd: dnd.value
//   }
// }

export class FlowRelationGraph {
  static graph: Graph
  static dnd: any
  static nodes: any
  static edges: any
  static init(donContainer, graphContainer, asyncRemoveCells) {
    // 配置流程图信息
    this.graph = new Graph({
      // container: document.getElementById('graph-container') as HTMLElement,
      container: graphContainer,
      grid: true, // 是否未网格页面
      // scroller: true, //滚轮画布
      // autoResize: true,
      width: 4000,
      height: 4000,
      //鼠标滚轮ctrl+放大页面
      mousewheel: {
        enabled: true,
        zoomAtMousePosition: true,
        modifiers: 'ctrl',
        minScale: 0.5,
        maxScale: 3
      },
      //连接线设置
      connecting: {
        router: {
          name: 'normal',
          args: {
            padding: 1
          }
        },
        connector: {
          name: 'rounded',
          args: {
            radius: 8
          }
        },
        anchor: 'midSide',
        connectionPoint: 'anchor',
        allowBlank: false, //允许连接空白点
        allowMulti: false, //允许多节点连接
        allowLoop: false, //允许循环创建
        allowNode: false, //允许连接节点(非节点上的链接桩)
        allowEdge: false, //允许连接到另一个边
        snap: {
          //自动吸附
          radius: 20
        },
        createEdge() {
          return new Shape.Edge({
            attrs: {
              line: {
                stroke: 'black',
                strokeWidth: 2,
                targetMarker: {
                  name: 'classic',
                  width: 12,
                  height: 8
                }
              }
            },
            router: {
              name: 'manhattan'
            },
            zIndex: 0
          })
        },
        validateConnection({ targetMagnet }) {
          return !!targetMagnet
        }
      },
      //连接锚点高亮
      highlighting: {
        magnetAdsorbed: {
          name: 'stroke',
          args: {
            attrs: {
              fill: '#fff',
              stroke: '#31d0c6',
              strokeWidth: 4
            }
          }
        }
      },
      resizing: false, // 节点是否支持缩放调整
      rotating: false, //节点是否支持旋转调整
      //是否支持选择节点和范围选择
      selecting: {
        enabled: true,
        rubberband: true,
        showNodeSelectionBox: true
      },
      snapline: true, //辅助对齐线开启
      keyboard: true, // 支持按钮点击事件
      clipboard: true //支持复制和剪切
    })
    // 配置右侧自定义拖拽
    this.dnd = new Addon.Dnd({
      target: this.graph,
      scaled: false,
      animation: true,
      dndContainer: donContainer as any,
      validateNode: (droppingNode, options) => {
        const dragNodes =
          droppingNode.shape === 'html'
            ? new Promise<boolean>((resolve) => {
                const { draggingNode, draggingGraph } = options
                const view = draggingGraph.findView(draggingNode)!
                const contentElem = view.findOne('foreignObject > body > div')
                Dom.addClass(contentElem, 'validating')
                setTimeout(() => {
                  Dom.removeClass(contentElem, 'validating')
                  resolve(true)
                })
              })
            : true
        return dragNodes
      }
    })
    // #region 快捷键与事件
    // 支持按钮cope和剪切
    this.graph.bindKey(['meta+c', 'ctrl+c'], () => {
      const cells = this.graph.getSelectedCells()
      if (cells.length) {
        this.graph.copy(cells)
      }
      return false
    })
    this.graph.bindKey(['meta+x', 'ctrl+x'], () => {
      const cells = this.graph.getSelectedCells()
      if (cells.length) {
        this.graph.cut(cells)
      }
      return false
    })
    this.graph.bindKey(['meta+v', 'ctrl+v'], () => {
      if (!this.graph.isClipboardEmpty()) {
        const cells = this.graph.paste({ offset: 32 })
        this.graph.cleanSelection()
        this.graph.select(cells)
      }
      return false
    })
    // select all
    this.graph.bindKey(['meta+a', 'ctrl+a'], () => {
      const nodes = this.graph.getNodes()
      if (nodes) {
        this.graph.select(nodes)
      }
    })
    //delete
    this.graph.bindKey('del', () => {
      const cells = this.graph.getSelectedCells()
      if (cells.length) {
        if (isFunction(asyncRemoveCells)) {
          asyncRemoveCells(cells, () => {
            this.graph.removeCells(cells)
          })
        } else {
          this.graph.removeCells(cells)
        }
      }
    })
    const showPorts = (ports: NodeListOf<SVGElement>, show: boolean) => {
      for (let i = 0, len = ports.length; i < len; i = i + 1) {
        ports[i].style.visibility = show ? 'visible' : 'hidden'
      }
    }
    this.graph.on('node:mouseenter', () => {
      const container = document.getElementById('graph-container')!
      const ports = container.querySelectorAll('.x6-port-body') as NodeListOf<SVGElement>
      showPorts(ports, true)
    })
    this.graph.on('node:mouseleave', () => {
      const container = document.getElementById('graph-container')!
      const ports = container.querySelectorAll('.x6-port-body') as NodeListOf<SVGElement>
      showPorts(ports, false)
    })
  }
  // 拖拽功能
  static startDrag(e, data: any = {}) {
    const node = this.graph.createNode({
      shape: 'vue-shape',
      id: data.id,
      width: 231,
      height: 42,
      data: { ...data },
      component: {
        render: () => {
          return <NodeInfo data={data} />
        }
      },
      ports: { ...ports }
    })
    this.dnd.start(node, e)
  }
  //添加节点信息
  static addNodes(nodesData = []) {
    this.nodes = []
    nodesData.forEach((nodeDate: any) => {
      this.nodes.push({
        shape: 'vue-shape',
        id: nodeDate.nodeId,
        width: 231,
        height: 42,
        data: { ...nodeDate },
        component: {
          render: () => {
            return <NodeInfo data={nodeDate} />
          }
        },
        ports: { ...ports }
      })
    })
  }
  // 添加关系信息
  static addEdges(edgesDate = []) {
    this.edges = []
    edgesDate.forEach((edgeDate: any) => {
      this.edges.push({
        source: edgeDate?.source?.cell,
        target: edgeDate?.target?.cell
      })
    })
    const dagreLayout = new DagreLayout({
      type: 'dagre',
      rankdir: 'LR',
      align: 'UL',
      ranksep: 100,
      nodesep: 50,
      controlPoints: true
    })
    const model = dagreLayout.layout({ nodes: this.nodes, edges: this.edges })

    this.graph.fromJSON(model)
  }
  // 添加节点触发事件
}

```

注意 在vue3 中使用tsx来直接编辑AndV 使用组件 需要在配置文件中配置

```js
const path = require('path')
import { defineConfig, loadEnv } from 'vite'
import proxyInfo from './dev.config'
import { useEnv } from './build/index'
import vueI18n from '@intlify/vite-plugin-vue-i18n'
// import vue from '@vitejs/plugin-vue'
// import vueJsx from '@vitejs/plugin-vue-jsx'
import { createSvgIconsPlugin } from 'vite-plugin-svg-icons'
import veauryVitePlugins from 'veaury/vite/index.js'

// https://vitejs.dev/config/
export default ({ mode }) => {
  const env = useEnv({ ...process.env, ...loadEnv(mode, process.cwd()) })
  const isSourcemap = env.VITE_APP_SOURCEMAP || false
  const isUseI18nPlugin = env.VITE_USE_I18N_PLUGIN || false
  return defineConfig({
    resolve: {
      alias: [
        {
          // 'vue-i18n': 'vue-i18n/dist/vue-i18n.runtime.esm-bundler.js',
          find: '@',
          replacement: path.resolve(__dirname, './src')
        },
        <!--------------主要配置下下面两个------------->
        {
          find: '@antv/x6',
          replacement: '@antv/x6/dist/x6.js'
        },
        {
          find: '@antv/x6-vue-shape',
          replacement: '@antv/x6-vue-shape/lib'
        }
         <!--------end------->
      ],
      extensions: ['.mjs', '.js', 'jsx', '.ts', '.tsx', '.json']
    },
    plugins: [
      createSvgIconsPlugin({
        iconDirs: [path.resolve(process.cwd(), 'src/icons/svg')],
        symbolId: 'icon-[dir]-[name]'
      }),
      veauryVitePlugins({
        type: 'vue'
      }),
      isUseI18nPlugin
        ? vueI18n({
            include: path.resolve(__dirname, './src/**/*/locale/**')
          })
        : () => {}
    ],
    server: {
      port: 9008,
      open: true,
      proxy: proxyInfo
    },
    base: '/',
    build: {
      outDir: env.VITE_APP_DIR,
      sourcemap: isSourcemap,
      target: 'es2020'
    },
    optimizeDeps: {
      esbuildOptions: {
        target: 'es2020'
      }
    },
    css: {
      preprocessorOptions: {
        scss: {
          additionalData: `@import "@/assets/css/global.scss";`
        }
      }
    }
  })
}

```

vue3中onMouned用法规律(可以在重新渲染时复用)与后端交互事件 vue文件

```vue.js
<!--
 * @Author: lyjie
 * @Date: 2022-12-02 17:28:39
 * @LastEditors: lyjie
 * @LastEditTime: 2022-12-15 14:13:55
 * @FilePath: \elabnote-front-main\src\views\data-center\template-task\componets\GraphContainner.vue
 * Copyright (c) 2022 by BMY, All Rights Reserved.
-->
<template>
  <div style="display: flex; width: 100%; height: 100%">
    <div class="don-container">
      <DragToGraphContainer />
    </div>

    <div class="contain-body"><div id="graph-container" ref="graphContainer" class="graph-core"></div></div>
  </div>
</template>
<script setup lang="ts">
  import { ref, watch, onMounted, nextTick } from 'vue'
  import { TaskFlowchartCss, FlowRelationGraph } from './taskGraphhook'
  import DragToGraphContainer from './DragToGraphContainner.vue'
  import { TaskTemplateDatesInfo } from '@/store/modules/template/task-template/type'
  import {
    addTaskTemplateFlowEdge,
    removeTaskTemplateFlowCells,
    addTaskTemplateFlowNode
  } from '@/api/elabnoteWeb/template'
  TaskFlowchartCss()
  const donContainer = ref<HTMLDivElement>()
  const graphContainer = ref<HTMLDivElement>()
  const emit = defineEmits(['open-drawer', 'get-data'])

  const props = defineProps<{
    tableInfo: TaskTemplateDatesInfo | undefined
  }>()
  const version = ref<number>(0)
  // 得到流程图节点数据提供到外部
  const getPData = () => {
    const graphInfo: any = {
      nodes: [],
      edges: []
    }
    const getNodes = FlowRelationGraph.graph.getNodes()
    getNodes.forEach((element: any) => {
      const nodeInfo: any = {
        ...element.data,
        nodeRawData: JSON.stringify(element?.store?.previous.position)
      }
      props.tableInfo && (nodeInfo.nodeId = element.data.nodeId)
      graphInfo.nodes.push(nodeInfo)
    })
    const getEdges = FlowRelationGraph.graph.getEdges()
    getEdges.forEach((element: any) => {
      const edgeInfo: any = {
        source: { cell: filterDateId(element.source?.cell, getNodes) },
        target: { cell: filterDateId(element.target?.cell, getNodes) }
      }
      if (!props.tableInfo) {
        edgeInfo.source.cell = element.getSourceNode()?.getData().nodeId
        edgeInfo.target.cell = element.getTargetNode()?.getData().nodeId
      }
      graphInfo.edges?.push(edgeInfo)
    })
    return graphInfo
  }
  // 赛选新建时id数据
  const filterDateId = (id: string, data: any[] = []) => {
    const cell = data.find((item) => {
      return item.id == id
    }).data.nodeId
    return cell
  }

  // const 点击节点触发
  const cliclNodes = () => {
    FlowRelationGraph.graph.on('node:click', ({ node }) => {
      emit('open-drawer', node)
    })
  }
  // 点击失去选择节点焦点触发
  const clickUnNodes = () => {
    FlowRelationGraph.graph.on('cell:unselected', () => {
      emit('open-drawer', undefined)
    })
  }
  // 新建节点连接
  const addEdges = () => {
    // 添加节点触发事件
    props.tableInfo &&
      FlowRelationGraph.graph.on('edge:connected', async ({ isNew, edge }: { isNew: any; edge: any }) => {
        // const cells = FlowRelationGraph.graph.getSelectedCells()

        if (isNew) {
          // 对创建的变进行插入数据库等持久化操作
          const targetRequestParams = {
            source: {
              ...edge.source,
              cell: edge?.getSourceNode().getData().nodeId
            },
            target: {
              ...edge.target,
              cell: edge?.getTargetNode().getData().nodeId
            }
          }
          const { data } = await addTaskTemplateFlowEdge({
            id: props.tableInfo?.id,
            version: version.value,
            artifact: targetRequestParams
          }).catch(() => {
            FlowRelationGraph.graph.removeEdge(edge)
          })
          version.value = data.version
        }
      })
  }

  // 新建节点
  const addNodes = () => {
    props.tableInfo &&
      FlowRelationGraph.graph.on('node:added', ({ node }) => {
        // 必须异步处理 流程图功能决定
        setTimeout(async () => {
          const nodeInfo = node.getData()
          const { data } = await addTaskTemplateFlowNode({
            id: props.tableInfo?.id,
            version: version.value,
            artifact: node.data
          }).catch(() => {
            FlowRelationGraph.graph.removeNode(node)
          })
          version.value = data.version
          Object.keys(data.artifact).forEach((item) => {
            if (data.artifact[item]) {
              nodeInfo[item] = data.artifact[item]
            }
          })
          node.setData(nodeInfo)
        }, 0)
      })
  }
  // 删除元素 （回调）
  const asyncRemoveCells = async (cells: any, successCallback: any) => {
    if (props.tableInfo) {
      const [nodes, edges]: [any[], any[]] = [[], []]
      cells.forEach((cellItem: any) => {
        if (cellItem.isNode()) {
          nodes.push(cellItem?.getData()?.nodeId)
        } else {
          const [sourceNode, targetNode] = [cellItem.getSourceNode().getData(), cellItem.getTargetNode().getData()]
          edges.push({
            sourceId: sourceNode.nodeId,
            targetId: targetNode.nodeId
          })
        }
      })
      const { data } = await removeTaskTemplateFlowCells({
        id: props.tableInfo?.id,
        version: version.value,
        artifact: { nodes, edges }
      })
      successCallback()

      version.value = data.version
    } else {
      successCallback()
    }
  }
  // 得到版本

  const getVsersion = () => {
    return version.value
  }
  onMounted(() => {
    FlowRelationGraph.init(donContainer.value, graphContainer.value, (cells, successCallback) => {
      asyncRemoveCells(cells, successCallback)
    })
    addEdges()
    addNodes()
    cliclNodes()
    clickUnNodes()
  })

  watch(
    () => props.tableInfo,
    () => {
      nextTick(() => {
        if (props.tableInfo) {
          version.value = props.tableInfo?.version
          FlowRelationGraph.addNodes(props.tableInfo.graph?.nodes)
          FlowRelationGraph.addEdges(props.tableInfo.graph?.edges)
        }
      })
    },
    {
      immediate: true
    }
  )

  defineExpose({
    getPData,
    getVsersion
  })
</script>

```



## 封装一个根据时间判断用户名称是否需要再次输入的工具

```ts
interface ISetItemInLocalExtra {
  expireDateTime?: number | string
}

export const APPROVAL_SIGN = 'approvalElectricSign'
export const approvalElectricHook = () => {
  const getItemInLocalStorage = localStorage.getItem.bind(localStorage)
  const setItemInLocalStorage = localStorage.setItem.bind(localStorage)
  const removeItemInLocalStorage = localStorage.removeItem.bind(localStorage)
  const expireDateSuffix = '_expire'

  function getItemInLocal(key: string) {
    const currentDateTime = Date.now()
    const expireDateTimeKey = `${key}${expireDateSuffix}`
    const expireDateTime = getItemInLocalStorage(expireDateTimeKey) as unknown as number
    if (expireDateTime && currentDateTime > expireDateTime) {
      removeItemInLocalStorage(key)
      removeItemInLocalStorage(expireDateTimeKey)
    }
    return getItemInLocalStorage(key)
  }

  function setItemInLocal(key, value, extra?: ISetItemInLocalExtra) {
    setItemInLocalStorage(key, value)
    if (!extra) return
    const { expireDateTime } = extra
    if (expireDateTime) {
      const expireDateTimeKey = `${key}${expireDateSuffix}`
      setItemInLocalStorage(expireDateTimeKey, expireDateTime as string)
    }
  }

  return {
    getItemInLocal,
    setItemInLocal
  }
}

```

## Vue3的watchEffect(() => {})

* 根watch用途相似，有与computed相似，可以直接根据回调函数里面的响应式变量判断需要再执行一次回调函数



## ts变量后加感叹号！

表示一个变量永远不会为空





```
<!-- 切换按钮组 -->
    <div class="change-view">
      <a-button-group style="margin-bottom: 10px">
        <a-button
          :type="viewValue == ViewType.RECORDPAGE ? 'primary' : undefined"
          @click="changeView(ViewType.RECORDPAGE)"
        >
          <icon-book />
        </a-button>
        <a-button
          :type="viewValue == ViewType.FLOWCHARTPAGE ? 'primary' : undefined"
          @click="changeView(ViewType.FLOWCHARTPAGE)"
        >
          <icon-list />
        </a-button>
      </a-button-group>
    </div>
    
     v-if="viewValue == ViewType.RECORDPAGE"
     && viewValue == ViewType.RECORDPAGE"
     
      <TaskDetailsFlowchart v-bind="$attrs" v-if="viewValue == ViewType.FLOWCHARTPAGE" />
      
        import TaskDetailsFlowchart from './components/taskDetailsFlowchart/index.vue'



  enum ViewType {
    RECORDPAGE = 'recordPage',
    FLOWCHARTPAGE = 'flowchartPage'
  }
  const viewValue = ref<ViewType>(ViewType.RECORDPAGE)
  // 判断切换到的页面
  const changeView = (value) => {
    viewValue.value = value
  }

  .lab-note {
    position: relative;
    display: flex;
    height: 100%;
    .change-view {
      position: absolute;
      left: 10px;
      top: 10px;
    }
    .emptyList {
      width: 100vw !important;
    }
    .lab-note-left {
      width: 30%;
      border-right: 1px solid #e8e8e8;
      padding: 50px 8px 8px;
      :deep(.arco-empty) {
        margin-top: 200px;
      }
    }
    .lab-note-right {
      flex: 1;
    }
    .sheet-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
  }
```

## vue3拖拽组件(泳道图)

在看一个组件官方防伪看start下载量

```js
yarn add vuedraggable@next
```

[GitHub - SortableJS/vue.draggable.next: Vue 3 compatible drag-and-drop component based on Sortable.js](https://github.com/SortableJS/vue.draggable.next)

代码:（vue使用代码）

```vue
<template>
  <div class="board-task-labnote">
    <a-spin :loading="loading" style="height: 100%; width: 100%">
      <div class="board-task-labnote-main">
        <template v-if="statusShowList.length > 0">
          <div v-for="info in statusShowList" :key="info.id" class="board-task-labnote-main-item">
            <a-space>
              <a-tag :color="info.color">{{ info.title }}</a-tag>
            </a-space>
            <div style="flex: 1; overflow-y: auto; width: 100%">
              <Draggable
                style="height: 100%; padding: 0 8px"
                :targetTitle="info.title"
                :targetId="info.id"
                v-model="info.list"
                animation="300"
                ghost-class="ghost"
                group="site"
                handle=".handle"
                class="scroll"
                :scroll="true"
                :forceFallback="false"
                @start="handleDraggableStart"
                @add="handleDraggableAdd(info?.list)"
                :move="handleDraggableMove"
                item-key="id"
              >
                <template #item="{ element }">
                  <BulletinNode v-bind="$attrs" :element="element" />
                </template>
              </Draggable>
            </div>
          </div>
        </template>
      </div>
    </a-spin>
  </div>
</template>
<script setup lang="ts">
  //components
  import Draggable from 'vuedraggable'
  import BulletinNode from './components/BulletinNode.vue'
  //utils
  import { ref, watch } from 'vue'
  import { cloneDeep } from 'lodash'
  import { updateTaskStatus, updatelabNoteStatus, checkUpdateStatus, getTaskStatusInfo } from '@/api/elabnoteWeb'
  // type
  import { DefaultStatusInfoEnum } from './constant'
  import { TableData } from '@arco-design/web-vue'
  import { JobType } from '@/common/enum'

  const Props = defineProps<{
    tableList: TableData[]
    loading: boolean
    taskId: string
  }>()

  const Emit = defineEmits(['handle-save'])

  // 状态展示列
  const statusShowList = ref<any[]>(
    Object.values(DefaultStatusInfoEnum).map((item) => {
      return {
        ...item,
        list: []
      }
    })
  )

  // 移动info
  const targetId = ref<string>('') //获取移动到的类型
  const targetTitle = ref<string>('') // 获取移动到的title
  const sourceItem = ref<any[]>([]) // 获取移动到的node

  const originStatusShowList = ref<any[]>([])
  const handleDraggableStart = () => {
    originStatusShowList.value = cloneDeep(statusShowList.value)
  }

  const handleDraggableMove = (e) => {
    targetId.value = e.relatedContext.component.$attrs.targetId || ''
    targetTitle.value = e.relatedContext.component.$attrs.targetTitle
    sourceItem.value = e.draggedContext.element
  }

  // 修改更改后的状态值
  const changeInfoList = (infoList, nodeId, targeId) => {
    const nodeInfo = infoList.find((item) => {
      return item.id == nodeId
    })
    nodeInfo.status = targeId
    const statusShowInfo = statusShowList.value?.find((item) => {
      return item.id == targeId
    })
    nodeInfo.statusName = statusShowInfo.title
  }

  // 改变node状态
  const handleChangeStatus = async (sourceNode, targetInfo, infoList) => {
    if (sourceNode.approvalProcessCode) {
      handleRestoreData()
      const { data: isAllowUpdate } = await checkUpdateStatus({
        jobId: sourceNode.id,
        jobType: sourceNode.jobType,
        statusId: targetInfo.id
      })

      if (isAllowUpdate) {
        Emit('handle-save', {
          jobId: sourceNode.id,
          statusId: targetInfo.id,
          record: sourceNode
        })
        return
      }
    }
    // 直接改变
    if (sourceNode.jobType === JobType.TASK) {
      const params = {
        taskId: sourceNode.id,
        statusId: targetInfo.id
      }
      changeInfoList(infoList, sourceNode.id, targetInfo.id)
      await updateTaskStatus(params)
    } else if (sourceNode.jobType === JobType.LAB_NOTE) {
      const params = {
        labNoteId: sourceNode.id,
        statusId: targetInfo.id
      }
      changeInfoList(infoList, sourceNode.id, targetInfo.id)
      await updatelabNoteStatus(params)
    }
    // await labnoteTaskInfo[sourceNode.jobType].asyncUpdateStatus(params)
  }

  const handleDraggableAdd = async (infoList) => {
    await handleChangeStatus(
      sourceItem.value,
      {
        id: targetId.value,
        title: targetTitle.value
      },
      infoList
    ).catch(() => {
      handleRestoreData()
    })
  }

  // 更改状态失败返回原始数据
  const handleRestoreData = () => {
    statusShowList.value = cloneDeep(originStatusShowList.value)
  }

  watch(
    () => Props.tableList,
    async () => {
      if (Props.tableList) {
        const { data } = await getTaskStatusInfo({
          taskId: Props.taskId
        })

        const getTaskStatusInfoList =
          data?.projectStatusList?.map((item) => {
            return (
              DefaultStatusInfoEnum[item.statusId] ?? {
                title: item.statusName,
                color: 'gray',
                id: item.statusId
              }
            )
          }) ?? Object.values(DefaultStatusInfoEnum)

        statusShowList.value = getTaskStatusInfoList?.map((item) => {
          let getInfoList = Props.tableList.filter((it) => {
            return it.status == item.id
          })
          return {
            ...item,
            list: [...getInfoList]
          }
        })
        originStatusShowList.value = cloneDeep(statusShowList.value)
      }
    },
    { immediate: true }
  )
</script>
<style lang="scss" scoped>
  .board-task-labnote {
    height: 100%;

    .board-task-labnote-main {
      padding: 0 10px 10px 10px;
      display: flex;
      width: 100%;
      height: 100%;
      overflow-y: hidden;
      overflow-x: auto;
      // justify-content: space-between;

      .board-task-labnote-main-item {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        flex-shrink: 0;
        margin-right: 20px;
        margin-bottom: 10px;
        padding: 10px;
        width: 280px;
        height: 100%;
        background-color: #fcfdff;
        border: 1px solid #ebecf0;
        border-radius: 3px;
      }
    }
  }
  .handle {
    cursor: move;
  }
</style>

```



## 甘特图js

**granttChartHooks.ts 其中可能有tsx写的vue组件**

```tsx
import { gantt } from 'dhtmlx-gantt'
import { queryTaskListByProject, updateGanttDateTime, updateProgress } from '@/api/elabnoteWeb/project'
import moment from 'moment'
import { JobType } from '@/common/enum'
import Message from '@/components/Message/index'
import { isFunction } from 'lodash'
import { getIcon } from './getIcon'

export const iniDataWithColor = (status: string, startDate: string, endDate: string) => {
  let ini: any
  switch (status) {
    case '进行中':
      ini = { color: '#1890ff' }
      break
    case '已完成':
      ini = { color: '#7cb305' }
      break
    case '已取消':
      ini = { color: '#faad14' }
      break
    default:
      ini = { color: '#bfbfbf' }
      break
  }
  if (!startDate) {
    ini['start_date'] = new Date()
    ini['end_date'] = new Date()
  } else {
    const start_date = moment(startDate).format('YYYY-MM-DD')
    ini['start_date'] = new Date(start_date + ' 00:00:00')
    ini['plannedStartTime'] = start_date
  }

  if (!endDate) {
    ini['end_date'] = new Date()
  } else {
    ini['end_date'] = new Date(moment(endDate).format('YYYY-MM-DD') + ' 00:00:00')
    ini['plannedEndTime'] = moment(endDate).format('YYYY-MM-DD')
  }

  return ini
}

export class GanttChart {
  static grantt: any

  static initZoom() {
    this.grantt.ext.zoom.init({
      levels: [
        {
          name: 'Days',
          scale_height: 90,
          min_column_width: 30,
          scales: [
            { unit: 'year', step: 1, format: '%Y年' },
            { unit: 'month', step: 1, format: '%M' },
            { unit: 'day', step: 1, format: '%d日' }
          ]
        },
        {
          name: 'Months',
          scale_height: 60,
          min_column_width: 60,
          scales: [
            { unit: 'year', step: 1, format: '%Y年' },
            { unit: 'month', step: 1, format: '%M' }
          ]
        },
        {
          name: 'Years',
          scale_height: 30,
          min_column_width: 60,
          scales: [{ unit: 'year', step: 1, format: '%Y年' }]
        }
      ]
    })
  }
  //初始化甘特图
  static setInit(ganttRef, opemTimeModal) {
    this.grantt = gantt
    this.grantt.config.date_format = '%Y-%m-%d %H:%i:%s'
    this.grantt.config.readonly = false
    this.grantt.config.work_time = true
    this.grantt.config.min_duration = 24 * 60 * 60 * 1000

    this.grantt.config.columns = [
      { name: 'owner', label: '负责人', align: 'center', width: 80 },
      {
        name: 'status',
        label: '状态',
        align: 'center',
        width: 80,
        template: (task: any) => {
          return "<div style='background-color:" + task.color + ";color:#fff'>" + task.status + '</div>'
        }
      },
      { name: 'text', label: '任务名称', tree: true, align: 'left', width: 200 },
      { name: 'plannedStartTime', label: '计划开始时间', align: 'left', width: 120 },
      { name: 'plannedEndTime', label: '计划结束时间', align: 'left', width: 120 },
      { name: 'plannedDuration', label: '工作日', align: 'center', width: 40 }
      // { name: "duration", label: "自然日", align: "center", width: 40 },
    ]

    this.grantt.i18n.setLocale('cn')
    this.initZoom()

    gantt.templates.grid_folder = function (item) {
      const fg = getIcon(item)
      return fg.outerHTML
    }
    gantt.templates.grid_file = function (item) {
      const fg = getIcon(item)
      return fg.outerHTML
    }
    this.grantt.templates.timeline_cell_class = (item, date) => {
      if (date.getDay() == 0 || date.getDay() == 6) {
        return 'weekend'
      } else {
        return ''
      }
    }
    this.grantt.message({
      expire: 1
    })
    // 不展示甘特图连线功能
    this.grantt.config.show_links = false

    // 双击触发
    this.grantt.attachEvent(
      'onBeforeLightbox',
      (id) => {
        const taskInfo = this.grantt.getTask(id)
        isFunction(opemTimeModal) && opemTimeModal(taskInfo)
        return false
      },
      {}
    )

    // 在任务改变之前
    this.grantt.attachEvent(
      'onBeforeTaskChanged',
      (id) => {
        const taskInfo = this.grantt.getTask(id)
        if (taskInfo.status == '已取消' || taskInfo.status == '已完成') {
          // message.error(task.status + '任务，无法修改计划时间')
          Message({
            content: `${taskInfo.status}任务，无法修改计划时间`,
            duration: 2 * 1000,
            type: 'error'
          })
          return false
        }
        return true
      },
      {}
    )

    // // 平移拖拽事件
    // this.grantt.attachEvent('onBeforeRowDragEnd', async (id, mode) => {
    //   console.log(id)
    // })
    // 拖拽过后触发
    this.grantt.attachEvent('onAfterTaskDrag', async (id, mode) => {
      const taskInfo = this.grantt.getTask(id)
      if (mode == 'resize' || mode == 'move') {
        const req = {
          id: taskInfo.id,
          jobType: taskInfo.jobType,
          plannedStart: taskInfo.start_date,
          plannedEnd: taskInfo.end_date,
          version: taskInfo.version
        }
        const res = await updateGanttDateTime(req)

        taskInfo.version = res.data.version
        taskInfo.plannedDuration = res.data.plannedDuration
        const ini = iniDataWithColor(taskInfo.status, taskInfo.start_date, taskInfo.end_date)

        this.grantt.updateTask(id, { ...taskInfo, ...ini })
      }
      if (mode == 'progress') {
        const req = {
          id: taskInfo.id,
          jobType: taskInfo.jobType,
          progress: taskInfo.progress,
          version: taskInfo.version
        }
        const res = await updateProgress(req)

        taskInfo.version = res.data.version
        this.grantt.updateTask(id, { ...taskInfo })
      }
    })

    // 初始化数据函数触发
    this.grantt.init(ganttRef as any)
  }

  // 甘特图传入数据
  static getTasks = async (id: string) => {
    let res = { code: '', data: [] }

    const resProject = await queryTaskListByProject({
      condition: {
        parentJobId: id,
        parentJobType: 40,
        taskTemplateId: '',
        pageIndex: 1,
        pageSize: 30000,
        teamType: 3,
        notTemplate: 0
      },
      shown: 1
    })
    res = resProject

    const tasks: any[] = []
    res.data.forEach((data: any) => {
      let task
      const ini = iniDataWithColor(
        data.statusName,
        data.plannedStart ? data.plannedStart : data.plannedStartTime,
        data.plannedEnd ? data.plannedEnd : data.plannedEndTime
      )

      const iniTask = {
        id: data.id,
        text: data.taskName ? data.taskName : data.name,
        owner: data.taskLeaderName ? data.taskLeaderName : data.leaderName,
        version: data.version,
        progress: data.progress,
        jobType: data.jobType,
        status: data.statusName,
        plannedDuration: data.plannedDuration,
        ...ini
      }
      if (data.parentJobType === JobType.TASK) {
        task = {
          ...iniTask,
          parent: data.parentJobId
        }
      } else {
        task = {
          ...iniTask,
          open: true
        }
      }
      tasks.push(task)
    })
    this.grantt.clearAll()
    this.grantt.parse({ data: tasks })
  }
}

```



## React使用(注意)

* 使用在组件渲染里面{变量} 被渲染只能为基础总类，不能为对象
* 可以监听的是一个函数

```tsx
  const showTitle = useMemo(() => {
    console.log('23423')
    return 0
  }, [
    componentProps.editor.isActive('heading', { level: 1 }),
    componentProps.editor.isActive('heading', { level: 2 }),
    componentProps.editor.isActive('heading', { level: 3 }),
    componentProps.editor.isActive('heading', { level: 4 }),
    componentProps.editor.isActive('heading', { level: 5 })
  ])
  
  <!-----------------在重新执行函数的过成中普通let也会被重新渲染-------------------->
  import React from "react";
// Init
const App = () => {
  let columnWidth = 65;
  let iddd = 1;
  if (view === ViewMode.Year) {
    iddd = 3;
    columnWidth = 350;
  } else if (view === ViewMode.Month) {
    columnWidth = 300;
    iddd = 6;
  } else if (view === ViewMode.Week) {
    columnWidth = 250;
    iddd = 7;
  }
  return (
    <div className="Wrapper">
      <h3>
        Gantt With Unlimited Height{columnWidth} --- {iddd}
      </h3>
    </div>
  );
};

export default App;

```



* **注意在使用闭包在react对于hook函数时，可能在加载时不能被有效监听到，使用的hook函数监听需要多家一个有效条件，进行重新加载**，
* **原因是因为在使用hook函数时，会保留上次使用的[变量1，变量2] 的值，在传入函数时会自动保留**
* **react每一次响应式变化的时候都会引起函数重新执行，因此可能没有链式响应式的值被重新赋值后也会重新渲染**



## clone浅克隆deepClone深克隆



## 谷歌浏览器的打印优化

* 谷歌浏览器会自动做一层优化，会把没展开的数据开始做一层加载优化，当展开过后会把最后得到的数据展示出来，虽然是同步但优化过后相类似异步





## 富文本网址

https://tiptap.dev/examples/default



## 文件大小（KB-YB）转换函数

```ts
export const bytesToSize = (bytes: number, fixedCount = 2) => {
  if (bytes === 0) return '0 KB'
  const k = 1024
  const sizes = ['KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'] //'B',
  const i = Math.floor(Math.log(bytes) / Math.log(k))

  return (bytes / Math.pow(k, i)).toFixed(fixedCount) + ' ' + sizes[i]
}
```



## vue与react相互转化(veaury)

具体用法可去官网查询



```js
import { applyPureVueInReact } from 'veaury'
const Spin = applyPureVueInReact(SpinVue)  //转react
const Spin = applyPureReactInVue(SpinReact) //转vue

```

* 组件从vue的响应式变量转入到react组件中也具有响应式，因为由react内部刷新影响机制

实例甘特图引用

```vue
<template>
  <div class="bmy-grantt">
    <a-button @click="changeView">切换视图</a-button>
    <GanttVue
      :columns="[
        {
          name: 'name',
          label: '名称',
          isShowChildren: true
        }
      ]"
      v-if="isNeedFrefreshGantt"
      :columnWidth="columnWidth"
      :tasks="tasks"
      :viewMode="viewMode"
      :ganttHeight="700"
      :onExpanderClick="handleExpanderClick"
    />
  </div>
</template>
<script setup lang="ts">
  import { Task, ViewMode, Gantt } from 'bmy-gantt'
  import { applyPureReactInVue } from 'veaury'
  import { ref, watch } from 'vue'
  import 'bmy-gantt/dist/index.css'
  const loading = ref<boolean>(false)
  const GanttVue: typeof Gantt = applyPureReactInVue(Gantt)
  const isNeedFrefreshGantt = ref(false)
  const tasks = ref<Task[]>([])
  const columnWidth = ref<number>(65) //每行的值
  const viewMode = ref<ViewMode>(ViewMode.Day) //甘特图模式 年、月、日

  const changeView = () => {
    viewMode.value = ViewMode.Week
  }

</script>
```

### 

注意拓展： 因为vue与react编辑翻译器不一样，使用这种配置时如果想用react转化的vue组件，但其实内部还是react相应，有时候tsx数据文件从vue编译传入进去会失去react性质，要防止react_app文件包下这个包可以随便在哪新建，这里插件会自动从底层文件编译成react的tsx文件使用



## 切换tag页面取得历史信息(思想)

**切换tag页面时取得前面id的思想**

用即使触发的方式从传入值，用异步阻塞方法判断现有值与传入值是否一样

```vue
      <EditorVue
        :content="_content"
        :labnoteId="currentLabNoteInfo.detialData?.id"
        :memoId="memoId!"
        :updateContent="updateContent"
        :loading="memoLoading"
        :readonly="MemoReadonly"
        :onlyEditorReadonly="OnlyEditorReadonly"
        :approveSignatureSuccessCallback="approveSignatureSuccessCallback"
        :memoVersion="currentMemoInfo.data?.version!"
        :autoSaveMemo="(madeType, content) => autoSaveMemo((currentMemoInfo.data?.id as string), madeType, content)"
      >
      <!------用即使触发的方式从传入id值，用异步阻塞方法判断现有id值与传入id值是否一样-------->    
   /**
   * 内部触发保存
   */
 const autoSaveMemo = async (id: string, madeType: MemoMadeTypeEnum, content: string) => 	{
    getAutoSaveJson(id, madeType, content)
  }       
   // 自动保存加切换tagview处理节流
  const getAutoSaveJson = throttle(
    async (memoId: string, madeType, content) => {
      if (memoId && memoId === currentMemoInfo.data?.id) {
        const { data } = await saveLabMemo([
          {
            id: currentMemoInfo.data?.id,
            madeType: madeType,
            order: currentMemoInfo.data?.order,
            sourceType: currentMemoInfo.data?.sourceType as LabMemoSourceTypeEnum,
            type: currentMemoInfo.data?.type as MemoType,
            version: currentMemoInfo.data?.version,
            title: currentMemoInfo.data?.title,
            sourceId: currentLabNoteInfo.detialData?.id as string,
            content
          }
        ])
        memoId === currentMemoInfo.data?.id && handleFixMemoDetial({ version: data?.[0].version })
      }
    },
    60 * 1000,
    { trailing: true, leading: false }
  )

```

## import.meta.globEager获取静态文件

```js
export const getImageUrl = (url: string) => {
  // 获取assets静态资源
  const path = `../../assets/images/${url}`
  const modules = import.meta.globEager('../../assets/images/*')
  return modules[path].default

  // return new URL(url.replace('@', '../../../src'), import.meta.url).href
}

export const getPdfUrl = (url: string) => {
  // 获取assets静态资源
  const path = `../../assets/pdf/${url}`
  const modules = import.meta.globEager('../../assets/pdf/*')
  return modules[path].default

  // return new URL(url.replace('@', '../../../src'), import.meta.url).href
}
```

## 把文件上传为formData对象(上传图片)

axios传值的时候需要传入一个formData对象

```ts
export const uploadImageCommon = (data: any) => {
  return webRequest.post({
    url: `/fileTransfer/uploadCommon?referenceType=${data.referenceType}`,
    data: data.file,
    noCancel: true
  })
}   

const formData = new FormData()
   formData.append('file', file as any)
```

## （仪器预约）FullCalendar-vue升级使用

日历调取接口赋值event事件

日历中有许多类型样式可以设置，Month 、TimeGrid 、DayGrid、 ......

目前使用的是dayGridMonth、dayGridWeek

* 可以以任意切换

(官网插槽:[Slot Render Hooks](https://fullcalendar.io/docs/slot-render-hooks))

```vue
<template>
  <div class="inventory-wrapper">
    <div class="menu-wrapper">
      <div class="left-title">
        <div class="left-title-name" @click="() => router.go(-1)">
          <icon-left size="15" />{{ equipmentInfo?.equipmentName }}
        </div>
        <div class="title-attribute">
          <span>设备编号:</span>
          <span style="margin-left: 5px">{{ equipmentInfo?.equipmentCode }}</span>
          <span style="margin-left: 10px">设备型号:</span>
          <span style="margin-left: 5px">{{ equipmentInfo?.equipmentModel }}</span>
        </div>
      </div>
      <a-button type="outline" @click="jumpMyRecord">我的预约记录 <icon-right :size="15" /></a-button>
    </div>
    <div class="warpper-body">
      <CalendarWatch :setOptions="options" @uptate-list="handleGetEvents" :equipmentInfo="equipmentInfo" />
    </div>
  </div>
</template>
<script setup lang="ts">
  import CalendarWatch from './appointment-details/CalendarWatch.vue'
  import { useRouter, useRoute } from 'vue-router'
  import { ref, watch } from 'vue'
  import {
    getDetailEquipment,
    getEquipmentReservation,
    PostReservationType,
    EquipmentType
  } from '@/api/material/equipment'
  import { getChangeTime } from './appointment-details/hook'
  import { useUserStore } from '@/store'
  import moment from 'moment'
  import Modal from '@/components/Modal'
  const UserStore = useUserStore()
  const route = useRoute()
  const router = useRouter()

  const options = ref<any>([])

  const jumpMyRecord = () => {
    if (!UserStore.userInfo.id) {
      Modal({
        type: 'error',
        maskClosable: false,
        titleAlign: 'start',
        title: '警告',
        simple: false,
        content: '查看【我的预约记录】需要登录系统，点击确定前往登录',
        onOk: () => {
          router.push(`/login?redirect=${route.path}`)
        }
      })
      return false
    }
    router.push('/main/appointment/my-record')
  }

  const equipmentInfo = ref<EquipmentType>()

  const handleGetEvents = async (param) => {
    const { data } = await getEquipmentReservation(
      route.params.equipmentId as string,
      param as PostReservationType
    ).finally(() => {})
    const filterDatas = data.filter((item) => {
      return new Date(item.startTime).getTime() > new Date(moment().format('YYYY-MM-DD [00]:[00]:[00]')).getTime()
    })
    options.value = filterDatas.map((item) => {
      // 传入事件
      if (UserStore.userId === item.createMan) {
        return {
          id: item.id,
          start: getChangeTime(item.startTime, 'YYYY-MM-DD HH:mm:ss'),
          end: getChangeTime(item.endTime, 'YYYY-MM-DD HH:mm:ss'),
          type: 1,
          backgroundColor: '#F6F8FF',
          data: item
        }
      } else {
        return {
          id: item.id,
          start: getChangeTime(item.startTime, 'YYYY-MM-DD HH:mm:ss'),
          end: getChangeTime(item.endTime, 'YYYY-MM-DD HH:mm:ss'),
          type: 2,
          backgroundColor: '#b3bccaee',
          data: item
        }
      }
    })
    // 当前天之前被撤销
    options.value.push({
      start: param.startTime.format('YYYY-MM-DD'),
      end: moment().format('YYYY-MM-DD'),
      overlap: false,
      display: 'background',
      color: '#b3bccaee'
    })
    // 当前天之后30天后
    options.value.push({
      start: moment()
        .days(moment().days() + 31)
        .format('YYYY-MM-DD'),
      end: param.endTime.format('YYYY-MM-DD'),
      overlap: false,
      display: 'background',
      color: '#b3bccaee'
    })
  }

  watch(
    () => route.params,
    async () => {
      if (route.params.equipmentId) {
        const { data } = await getDetailEquipment(route.params.equipmentId as string)
        equipmentInfo.value = data
      }
    },
    {
      immediate: true
    }
  )
</script>
<style lang="scss" scoped>
  .inventory-wrapper {
    height: 100%;
    .menu-wrapper {
      padding: 0px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid $borderColor;
      .left-title {
        .left-title-name {
          font-size: 16px;
          font-weight: bold;
          color: $font1Color;
          line-height: 40px;
          cursor: pointer;
          &:hover {
            text-decoration: underline;
          }
        }
        .title-attribute {
          font-size: 12px;
          line-height: 20px;
          color: #b4bac5;
        }
      }
    }
    :deep(.arco-menu-item) {
      // font-weight: bold;
      font-family: 'fontFamily1';
      font-style: normal;
      font-size: 14px;
    }
    .warpper-body {
      width: 100%;
      padding: 20px;
      height: calc(100% - 65px);
    }
  }
</style>
```

CalendarWatch.vue

```vue
<template>
  <div ref="CalendarRef" class="card-modal">
    <div class="header-btn">
      <div>
        <a-space>
          <a-button-group>
            <a-button @click="changeMouth" :type="(colorList[0] as 'primary' | undefined)"> 月 </a-button>
            <a-button @click="changeWeek" :type="(colorList[1] as 'primary' | undefined)"> 周 </a-button>
            <!-- <a-button @click="changeDay" :type="(colorList[2] as 'primary' | undefined)"> 日 </a-button> -->
          </a-button-group>
          <a-button @click="changeToday"> 今天 </a-button>
          <span @click="changePrev" class="icon-lr"><icon-left /></span>
          <span @click="changeNext" class="icon-lr"><icon-right /></span>
          <span class="date-time">{{ headerTilte }}</span>
        </a-space>
      </div>
      <!-- 新建日程 -->
      <CreateEventInfo @open-new="handleOpenNewModal" />
    </div>

    <div class="tabs" style="width: 100%">
      <FullCalendar v-if="visible" :options="calendarOptions" ref="fullCalendar">
          <!-- <template #slotLabelContent="item"> //左侧时间插槽
             <span>{{ item }}</span>
            </template> -->

        <template #eventContent="{ event }">  //事件插槽
          <div v-if="event.id" :class="['event-content']" @click.stop="openCardModal(event)">
            <span :class="['content-span', event.extendedProps.type == 1 ? 'normal-color' : 'gray-color']"
              >{{ getChangeTime(event.start, 'YYYY-MM-DD HH:mm') }} ~
              {{ getChangeTime(event.end, 'YYYY-MM-DD HH:mm') }} 已预约使用</span
            >
          </div>
        </template>
      </FullCalendar>
    </div>
    <NewEventModal ref="NewEventModalRef" @uptate-list="getEvents" :events="setOptions" />
    <CalendarCardEventModal
      ref="CalendarCardEventModalRef"
      :CalendarRef="CalendarRef"
      @edit="
        (event) => {
          NewEventModalRef?.opemEditModal(event)
        }
      "
      @update-list="getEvents"
      :equipmentInfo="equipmentInfo"
    />
  </div>
</template>
<script setup lang="ts">
  import { ref, onMounted, nextTick, watch } from 'vue'
  import '@fullcalendar/core/vdom' // solve problem with Vite
  import FullCalendar, { EventApi } from '@fullcalendar/vue3' //EventClickArg,DateSelectArg
  import CreateEventInfo from './CreateEventInfo.vue'
  import NewEventModal from './NewEventModal.vue'
  import ExplainEventHeader from './ExplainEventHeader.vue'
  import CalendarCardEventModal from './CalendarCardEventModal.vue'
  import { CalendarWatchHook, getChangeTime } from './hook'
  import moment from 'moment'
  import { EquipmentType } from '@/api/material/equipment'
  import { useWindowSize } from '@vueuse/core'
  import Modal from '@/components/Modal'
  import { useRoute, useRouter } from 'vue-router'
  import { useUserStore } from '@/store'
  const emit = defineEmits(['uptate-list'])

  const { height, width } = useWindowSize()

  const props = defineProps<{
    setOptions: any[]
    equipmentInfo?: EquipmentType
  }>()

  const NewEventModalRef = ref()
  const CalendarCardEventModalRef = ref()
  const CalendarRef = ref()

  const colorList = ref<Array<string | undefined>>(['primary', undefined, undefined])

  const visible = ref<boolean>(false)
  const fullCalendar = ref<InstanceType<typeof FullCalendar>>()
  let instance = ref<any>()

  const headerTilte = ref<string>() //头部显示时间信息

  const router = useRouter()
  const route = useRoute()
  const UserStore = useUserStore()
  //打开新建模态框
  function handleOpenNewModal(start, end) {
    if (start && end) {
      // 判断是否是今天之前是新建
      if (new Date(start).getTime() < new Date(moment().format('YYYY-MM-DD [00]:[00]:[00]')).getTime()) return
      // 判断点击是否在当前30之后
      if (
        new Date(start).getTime() >=
        new Date(
          moment()
            .days(moment().days() + 31)
            .format('YYYY-MM-DD [00]:[00]:[00]')
        ).getTime()
      )
        return
      // 操作
      if (!UserStore.userInfo.id) {
        Modal({
          type: 'error',
          maskClosable: false,
          titleAlign: 'start',
          title: '警告',
          simple: false,
          content: '新建预约需要登录系统，点击确定前往登录',
          onOk: () => {
            router.push(`/login?redirect=${route.path}`)
          }
        })
        return
      }
      NewEventModalRef.value?.openModal({
        start,
        end
      })
    } else {
      NewEventModalRef.value?.openModal()
    }
  }

  // 点击按钮触发日期改变事件
  const changeDateTime = () => {
    instance.value = fullCalendar.value?.getApi()
    const view = instance.value.view
    headerTilte.value = view.title
  }
  const { calendarOptions } = CalendarWatchHook(changeDateTime, handleOpenNewModal)
  // 获取日期事件数据
  const getEvents = async () => {
    const { start, end } = instance.value.currentDataManager.state.dateProfile.currentRange
    const startTime = moment(start).month(moment(start).month() - 1)
    const endTime = moment(end).month(moment(end).month() + 1)
    const param = { startTime: startTime, endTime: endTime }
    emit('uptate-list', param)
  }

  // 点击跳转月view
  const changeMouth = () => {
    instance.value?.changeView('dayGridMonth')
    colorList.value.forEach((item, index) => {
      if (index == 0) {
        colorList.value[index] = 'primary'
      } else {
        colorList.value[index] = undefined
      }
    })
    changeDateTime()
    getEvents()
  }
  // 点击跳转周view
  const changeWeek = () => {
    instance.value?.changeView('timeGridWeek')
    colorList.value.forEach((item, index) => {
      if (index == 1) {
        colorList.value[index] = 'primary'
      } else {
        colorList.value[index] = undefined
      }
    })
    changeDateTime()
    getEvents()
  }
  // 点击跳转每日
  // const changeDay = () => {
  //   instance.value?.changeView('timeGridDay')
  //   colorList.value.forEach((item, index) => {
  //     if (index == 2) {
  //       colorList.value[index] = 'primary'
  //     } else {
  //       colorList.value[index] = undefined
  //     }
  //   })
  //   changeDateTime()
  //   getEvents()
  // }
  // 点击跳转上一页
  const changePrev = () => {
    instance.value?.prev()
    getEvents()
  }
  // 跳转到下一页
  const changeNext = () => {
    instance.value?.next()
    getEvents()
  }
  // 跳转到今天
  const changeToday = () => {
    instance.value?.today()
    getEvents()
  }

  // 打开事件卡片模态框
  const openCardModal = (event: EventApi) => {
    if (event.extendedProps.type == 1) {
      CalendarCardEventModalRef.value?.openModal(event)
    }
  }

  onMounted(() => {
    nextTick(() => {
      setTimeout(() => {
        visible.value = true
      }, 200)
    })
  })

  // 开始调用一次
  const stop = watch(
    () => instance.value,
    async () => {
      if (instance.value) {
        getEvents()
        stop?.()
      }
    },
    {}
  )

  watch(
    () => props.setOptions,
    () => {
      if (props.setOptions) {
        calendarOptions.events = props.setOptions
      }
    },
    {
      immediate: true
    }
  )

  watch(
    [height, width],
    () => {
      if (height.value) {
        // 调整日历列表宽高适应屏幕
        calendarOptions.contentHeight = height.value - 201
        setTimeout(() => {
          calendarOptions.contentHeight = height.value - 200
        }, 200)
      }
    },
    {
      immediate: true
    }
  )
</script>
<style lang="scss" scoped>
  .card-modal {
    :deep(.arco-modal-body) {
      padding: 0;
    }
    :deep(.arco-modal) {
      border-radius: 5px;
      overflow: hidden;
    }
  }
  .header-btn {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    .icon-lr {
      font-size: 14px;
      cursor: pointer;
      color: #42526e;
    }
    .icon-lr:hover {
      background-color: rgba(189, 184, 184, 0.514);
    }
    .date-time {
      font-size: 14px;
      font-weight: bold;
      color: #42526e;
    }
  }
  .demo-basic {
    width: 310px;
    background-color: var(--color-bg-popup);
    border-radius: 4px;
    box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.15);
    border-radius: 10px 10px 0px 0px;
  }
  // 月 事件区域
  :deep(.fc-daygrid-event) span {
    display: block;
    width: 98%;
    height: 98%;
    .event-content {
      width: 98%;
      height: 100%;
      display: flex;
      align-items: center;
      cursor: pointer;

      .content-span {
        margin-left: 5px;
        width: calc(100% - 10px);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
      }
    }
  }
  // 周/日 事件区域
  :deep(.fc-event-main) span {
    display: block;
    width: 98%;
    height: 98%;
    overflow: hidden;
    .event-content {
      height: 100%;
      display: flex;
      align-items: center;
      cursor: pointer;

      .content-span {
        margin-left: 5px;
        width: calc(100% - 10px);
      }
    }
  }
  // 修改日历头部高度
  :deep(.fc-col-header) {
    height: 35px !important;
  }
  .normal-color {
    color: #3358ff;
  }

  .gray-color {
    color: gray;
  }
  :deep(.fc-day-today) {
    background-color: #ddf5d9 !important;
  }
  // 修改日历组件单元格的高度
  :deep(.fc) {
    .fc-timegrid-slot {
      height: 4.13em;
    }
  }
</style>

```

hook.ts

```ts
import { reactive } from 'vue'
import { CalendarOptions, DateSelectArg } from '@fullcalendar/vue3' //EventClickArg,DateSelectArg
import dayGridPlugin from '@fullcalendar/daygrid'
import timeGridPlugin from '@fullcalendar/timegrid'
import interactionPlugin from '@fullcalendar/interaction'
import zhCnLocale from '@fullcalendar/core/locales/zh-cn'
import moment from 'moment'

/*
 * changeDateTime : () => void 外部日历传入变化事件
 */

//可以添加事件列表
// {
//   id: '12132',
//   start: '2023-03-22 13:00:00',
//   end: '2023-03-23 16:30:00',
//   allDay: false,
//   backgroundColor: '#F6F8FF',
//   type: 1
// },
// {
//   id: '12114',
//   start: '2023-03-11T10:00:00',
//   end: '2023-03-11T16:00:00',
//   display: 'background',
//   color: '#42526e',
//   type: 2
// },
// {
//   id: '56465',
//   start: '2023-03-24',
//   end: '2023-03-28',
//   overlap: false,
//   display: 'background',
//   color: '#42526e',
//   type: 2
// }

export const CalendarWatchHook = (changeDateTime: () => void, handleOpenNewModal: (start: any, end: any) => void) => {
  const calendarOptions = reactive<CalendarOptions>({
    plugins: [
      //安装的插件
      dayGridPlugin,
      timeGridPlugin,
      interactionPlugin // needed for dateClick
    ],
    scrollTimeReset: false, //在事件重新渲染时页面滚动条不会重置 默认为: true
    headerToolbar: false,
    initialView: 'dayGridMonth', //默认选择月份
    editable: false, //可编辑表格
    selectable: true, //是否允许用户单击或者拖拽日历中的天和时间隙。
    selectMirror: true,
    dayMaxEvents: true, // 限制事件数量
    weekends: true, //是否显示一周七天
    handleWindowResize: false, //随浏览器窗口变化
    // height: 1000, //日期表格高度
    locale: zhCnLocale, //汉化文字,
    events: [],
    // contentHeight: 55,
    // slotLabelInterval: { hours: 2 },//选择左侧时间间隔2小时为一组
    slotDuration: '01:00:00', //左侧时间单元格间隔时间
    // 事件
    select: handleDateSelect, //选择单元格填入内容事件
    // eventClick: handleEventClick, // 单击信息事件
    eventsSet: handleEvents // 点击任意数据发生变化时触发事件
    // eventMouseEnter: handleEventMouseEnter // 鼠标悬停单个事件上时触发
  })

  // 选择填入事件内容
  function handleDateSelect(selectInfo: DateSelectArg) {
    handleOpenNewModal(selectInfo.start, selectInfo.end)
  }

  // 只用于读取每一个单元格的事件内容
  async function handleEvents() {
    //event: EventApi[]
    changeDateTime()
  }
  return {
    calendarOptions
  }
}

// 改变时间格式
export const getChangeTime = (time: string | Date, format: string) => {
  time = new Date(time)
  return moment(time).format(format)
}

export const enum GETWEEK {
  SUNDAY = 0,
  MONDAY = 1,
  TUESDAY,
  WEDNESDAY,
  THURSDAT,
  FRIDAY,
  SATURDAY
}

// 星期
export const WEEKDAY = {
  [GETWEEK.MONDAY]: '周一',
  [GETWEEK.TUESDAY]: '周二',
  [GETWEEK.WEDNESDAY]: '周三',
  [GETWEEK.THURSDAT]: '周四',
  [GETWEEK.FRIDAY]: '周五',
  [GETWEEK.SATURDAY]: '周六',
  [GETWEEK.SUNDAY]: '周日'
}

// 得到时间转换为星期
export const changeWeek = (time: any) => {
  if (time) {
    const getTime = new Date(time)
    const timeUpOrDown = getTime.getHours() <= 12 ? '上午' : '下午'

    return getTime
      ? `${getTime.getMonth() + 1}月${getTime.getDate()}日 ${WEEKDAY[getTime.getDay()]} ${timeUpOrDown} ${moment(
          getTime
        ).format('HH:mm')}`
      : ''
  }
}

```

**注意事项：**如果要给日历添加事件且有异步赋值操作，需要在父组件异步传进去，形成子组件同步赋值，不然日历渲染会出问题



## 处理Promise返回参数解决思路问题（30万）

"思路网址他用的是feach不是ajax"

https://juejin.cn/post/7206297124940988472

```js
const loopAsync = (data, result) => {
    let _res = data.res
    if (typeof result?.then === 'function') {
      try {
        if (_res !== undefined) {
          console.log(_res)
          return _res
        } else {
          triggerError()
        }
      } catch (error) {
        return loopAsync(data, result)
      }
    }
  }
  const wrapperHandleDiffFieldType = (fn) => {
    let result = fn()
    const data: any = {}
    if (isFunction(result?.then)) {
      result.then((res) => {
        data.res = res
      })
      result = loopAsync(data, result)
    }
    console.log(result)
    return result
  }
```

## Vue单独处理模板中的使用Promise对象(Suspense)

父组件使用官网(Suspense)

```vue
<Suspense>
    <AsyncFieldTitle
         :fieldValue="item.approveFieldValueBo.fieldValue"
         :fieldType="item.approveFieldTemplateBo.fieldType"
         :isMultiple="systemYesNoEnumToBoolean(item.approveFieldTemplateBo.multipleValue)"
    />            
</Suspense>
```

vue使用Suspense里面必需要有await 异步处理，react使用Suspense不需要

```vue
<template>
  <span class="field-value">{{ title }}</span>
</template>
<script lang="ts" setup>
  import { ParameterType } from '@/common/enum'
  import { handleDiffFieldType } from '../utils'

  const Props = defineProps<{
    fieldValue: any
    fieldType: ParameterType
    isMultiple: boolean
  }>()

  const title = await handleDiffFieldType[Props.fieldType]?.(Props.fieldValue, Props.isMultiple)
</script>
```

## vue3的watch使用注意事项

* vue的watch方法监听的是响应式变量如果是响应式变量对应的实例.value的值，监听方法就会失效，注意这只对基本类型的变量生效

* 如果变量是对象或者数组本身属性就可以作为响应式变量处理，对应的实例值也是响应式的，因为响应式数据或者对象是proxy包裹在ref中

  ```vue
   watch(
      disabled,
      () => {
        if (visible.value && !disabled.value && tableListData.value) {
          rearrange(Direction.HORIZENTAL)
        }
      },
      {
        immediate: true
      }
    )
  ```

  

* 其中传入的Props需要() => 实例来监听

* 重要: 如果想要组件本身基本类型的响应式变量想要以实例value的形式，也需要加上() => 实例.value的形式进行监听



## 易览笔记ws(websocket)使用

轮子文件

```ts
import { storeToRefs } from 'pinia'
import { computed, ref } from 'vue'
import { useUserStore } from '../store'
import { Env } from '@/common/constant'
import { WebsocketNoteTypeEnum } from '@/common/enum'
import { throttle } from 'lodash'

const heartbeatValTimer = ref<NodeJS.Timer>()

export let ws: WebSocket

/**
 * 开始心跳
 */
const startHeartbeat = () => {
  heartbeatValTimer.value = setInterval(() => {
    const { userId } = storeToRefs(useUserStore())
    ws.send(
      JSON.stringify({
        bizType: WebsocketNoteTypeEnum.PING,
        message: Date.now().toString(),
        userId: userId.value
      })
    )
  }, 5 * 1000)
}

export function initialWebsocket() {
  const { userInfo } = storeToRefs(useUserStore())
  const _userId = computed(() => userInfo.value?.userId)

  const wsHost = Env.isDev
    ? `${import.meta.env.VITE_VUE_WS}/messagePush/api/websocket/${_userId.value}`
    : Env.isHy
    ? `ws://${window.location.host}/messagePush/websocket`
    : `ws://${window.location.host}/messagePush/api/websocket/${_userId.value}`

  ws = new WebSocket(wsHost)

  const reconnect = throttle(() => {
    try {
      ws = new WebSocket(wsHost)
    } catch (e) {}
  }, 5 * 1000)

  ws.onopen = () => {
    reconnect.cancel()
    startHeartbeat()
  }

  ws.onclose = () => {
    clearInterval(heartbeatValTimer.value)
    reconnect()
  }

  ws.onerror = () => {
    clearInterval(heartbeatValTimer.value)
    reconnect()
  }
}

```

使用ws接收消息

```ts
  import { ws } from '@/ws/websocket'
<!---------------------------------------------------------------->
  function handleRefreshTable() {
    ws.onmessage = (e) => {
      const data = JSON.parse(e.data)
      if (data.bizType === WebsocketNoteTypeEnum.REFRESH && data.content === WebsocketRefreshEnum.REFRESH_INVENTORY) {
        outInStockStore.searchTrigger()
        outInStockStore.coverStockStatusTotalNum()
      }
    }
  }
```

## arco解决表格编辑太挂载问题模态框被遮盖问题(fixed适应)

* 使用fixed飘起的弹框进行弹出到浏览器中被展示处理



## 属性选择器可以根据元素上的属性来条件筛选值(*)

方便使用的css选择器中属性选择器，根据元素本身如div上的属性键值对进行筛选

* 语法格式& : 属性名[类型=‘值value’]

* 可以使用在js与css当中十分定制化好用

  使用在css中:

```scss
  :deep(.arco-tree-node) {
      // font-weight: bold;
      &[type='1'] {
        background-color: red !important;
      }
      &[type='3'] {
        background-color: red !important;
      }
      &[type='4'] {
        background-color: red !important;
      }
      &[type='7'] {
        background-color: red !important;
      }
    }
```

使用在js中:

```js
document.querySelector(.arco-tree-node[type='1'])
```

选择的html元素:

```html
<div class="arco-tree-node arco-tree-node-selected" data-level="0" data-key="1" type="1"><!-- 缩进 --><span class="arco-tree-node-indent"></span><!-- switcher --><span class="arco-tree-node-switcher"><span class="arco-icon-hover arco-tree-node-icon-hover"><span class="arco-tree-node-switcher-icon"><svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" class="arco-icon arco-icon-caret-down" stroke-width="4" stroke-linecap="butt" stroke-linejoin="miter"><path d="M24.938 34.829a1.2 1.2 0 0 1-1.875 0L9.56 17.949c-.628-.785-.069-1.949.937-1.949h27.007c1.006 0 1.565 1.164.937 1.95L24.937 34.829Z" fill="currentColor" stroke="none"></path></svg></span></span></span><!-- checkbox --><!--v-if--><!-- 内容 --><span class="arco-tree-node-title" draggable="false"><!--v-if--><span class="arco-tree-node-title-text"><!-- 标题，treeTitle 优先级高于节点的 title -->待审批(236)<!--v-if--></span></span><!-- 额外 --><!--v-if--></div>
```

## delete 运算符

* 删除一个对象的属性

  ```js
     delete registerPermissionIdMapData.value[authedId]
  ```




## 解决一对多个路由回退问题

roter对应文件(使用冒号传参，开始props：路由传入组件用props接收)

```ts
export default {
  path: 'appointment',
  name: InstrumentMenusEnum.appointment,
  redirect: { name: InstrumentMenusEnum.mainDisplay },
  component: () => import('@/views/instrument-reservation/index.vue'),
  meta: {
    title: 'router.appointment',
    icon: 'orderinstru',
    isShowChildrenMenu: false,
    // isLayout: false,
    isVisitor: true,
    roles: [PermissionInfo.equipmentManagePage]
  },
  children: [
    {
      path: 'agenda',
      name: InstrumentMenusEnum.mainDisplay,
      component: () => import('@/views/instrument-reservation/components/mainDisplay.vue'),
      meta: {
        isVisitor: true
      }
    },
    {
      path: 'detail/:equipmentId',
      name: InstrumentMenusEnum.ADetail,
      component: () => import('@/views/instrument-reservation/components/AppointmentDetails.vue')
    },
    {
      path: 'my_record/:info',
      name: InstrumentMenusEnum.MyRecords,
      component: () => import('@/views/instrument-reservation/components/MyAppointmentRecord.vue'),
      props: true,
      redirect: { name: InstrumentMenusEnum.AppointmentRecord },
      children: [
        {
          path: 'appoint_record',
          name: InstrumentMenusEnum.AppointmentRecord,
          component: () => import('@/views/instrument-reservation/components/my-appointment-record/MyRecords.vue')
        },
        {
          path: 'measurement',
          name: InstrumentMenusEnum.EquipmentMeasurement,
          component: () => import('@/views/instrument-reservation/components/equipment-measurement/index.vue')
        },
  ]
}

```

接收组件

```vue
<template>
  <div class="inventory-wrapper">
    <div class="menu-wrapper">
      <div class="left-title">
        <div class="left-title-name" @click="() => router.push(info)"><icon-left size="15" /></div>
        <a-menu
          :style="{ flex: 1 }"
          mode="horizontal"
          :selected-keys="selectedKeys"
          @menuItemClick="handleMenuItemClick"
        >
          <template v-for="item in meuns" :key="item.key">
            <a-menu-item>{{ item.title }}</a-menu-item>
          </template>
        </a-menu>
      </div>
    </div>
    <div class="warpper-body">
      <!-- <MyRecord /> -->
      <router-view v-if="useCurrentRouterPath('my_record')" v-slot="{ Component }">
        <component :is="Component" />
      </router-view>
    </div>
  </div>
</template>
<script setup lang="ts">
  // import MyRecord from './my-appointment-record/MyRecords.vue'
  import { InstrumentMenusEnum } from '@/router/modules/instrument-reservation'
  import { useCurrentRouterPath } from '@/hooks'
  import { useRoute, useRouter } from 'vue-router'

  import { computed, reactive } from 'vue'

  defineProps<{
    info: string
  }>()

  const [route, router] = [useRoute(), useRouter()]
  const selectedKeys = computed(() => route.name)

  const meuns = reactive<{ title: string; key: string }[]>([
    {
      title: '预约记录',
      key: InstrumentMenusEnum.AppointmentRecord
    },
    {
      title: '设备计量',
      key: InstrumentMenusEnum.EquipmentMeasurement
    },
    {
      title: '验证确认',
      key: InstrumentMenusEnum.VerificationConfirmation
    },
    {
      title: '维修保养',
      key: InstrumentMenusEnum.Maintenance
    },
    {
      title: '设备借用',
      key: InstrumentMenusEnum.Borrow
    },
    {
      title: '已下架仪器',
      key: InstrumentMenusEnum.RemovedInstrument
    }
  ])

  const handleMenuItemClick = (name: string) => {
    router.push({ name })
  }
</script>

```

多个跳转组件

```ts
 const jumpMyRecord = () => {
    if (!UserStore.userInfo.id) {
    router.push({
      name: InstrumentMenusEnum.MyRecords,
      params: {
        info: route.fullPath
      }
    })
  }

 const jumpMyRecord = () => {
    if (!judgeLogin('查看【我的预约记录】需要登录系统，点击确定前往登录')) return
    router.push({
      name: InstrumentMenusEnum.MyRecords,
      params: {
        info: route.fullPath
      }
    })
  }
```

注意传值必须是params的方式才可以

可以随便加，组件props都能接收到

## 遇到的文件import变量问题

* 当在系统中vue文件中import引用同一份数据时，那么就会出现变量地址是同一个值的情况，

  A文件:

  ```js
    import { initConfirmDataB } from '../utils/cellConfirmWarehouseConfig'
  ```

  B文件

  ```js
    import { initConfirmDataB } from '../utils/cellConfirmWarehouseConfig'
  
  ```

  **那么这两个在同一份系统中引用的相同文件地址的变量，解释为什么可以使用类的原型**



## arco组件使用表单校验validate异步函数时组件往外暴露await处理*

父组件

```vue
<template>
  <a-modal :visible="visible" @cancel="handleCancel" :on-before-ok="handleOk" title-align="start" title="电签">
    <BaseSign :referenceId="referenceId" ref="BaseSignRef" v-if="visible" />
  </a-modal>
</template>

<script lang="ts" setup>
  import BaseSign from '../approval-center/components/BaseSign.vue'
  import { ref } from 'vue'

  type FN = (_: object) => Promise<void>

  defineProps<{
    referenceId: string
  }>()

  const visible = ref<boolean>()
  const successCallback = ref<FN>()
  const BaseSignRef = ref<InstanceType<typeof BaseSign>>()
  const handleOk = async (done) => {
    const extrasParams = await BaseSignRef.value?.validate()
    return await successCallback.value?.({ ...extrasParams })?.finally(() => done)
  }

  const handleCancel = () => {
    visible.value = false
  }

  const openModal = (_successCallback: FN) => {
    visible.value = true
    successCallback.value = _successCallback
  }

  defineExpose({
    openModal
  })
</script>
```

子组件

```vue
<template>
  <a-form ref="FormRef" :model="approvalConfirmInfo" layout="vertical" :rules="rules">
    <a-form-item label="用户" field="userCode">
      <a-input v-model="approvalConfirmInfo.userCode" placeholder="请输入用户名称" />
    </a-form-item>
    <a-form-item label="密码" field="secondaryPassword">
      <a-input v-model="approvalConfirmInfo.secondaryPassword" type="password" />
    </a-form-item>
    <a-form-item label="理由" field="reasonId">
      <a-select v-model="approvalConfirmInfo.reasonId" placeholder="请选择理由" allow-clear>
        <a-option v-for="item in reasonList" :key="item.id" :value="item.id">{{ item.title }}</a-option>
      </a-select>
    </a-form-item>
    <a-form-item label="备注" field="approveComment">
      <div style="height: 300px">
        <Editorsample
          :hide-save="true"
          ref="EditorSampleRef"
          :editorMode="EditorModelsEnum.ATTACHMENT_SIMPLE_MODE"
          :referenceId="referenceId"
          :referenceType="UploadFileRefTypeEnum.APPROVE"
        />
      </div>
    </a-form-item>
  </a-form>
</template>

<script setup lang="ts">
  import Editorsample from '@/views/task/sub-task/task-details/components/Editorsample.vue'
  import { EditorModelsEnum, UploadFileRefTypeEnum } from '@/common/enum'
  import { rules } from './utils/constant'
  import { useReason } from './hooks'
  import { reactive, ref } from 'vue'
  import { Form } from '@arco-design/web-vue'

  defineProps<{
    referenceId: string
  }>()

  const EditorSampleRef = ref<any>(null)
  const FormRef = ref<InstanceType<typeof Form>>()

  const getEditorContent = () => {
    let approveComment
    if (EditorSampleRef.value?.isEditorCotentNull()) {
      approveComment = ''
    } else {
      approveComment = JSON.stringify(EditorSampleRef.value?.getEditorForm())
    }
    return approveComment
  }

  const { reason, reasonId, reasonList, getReasonList } = useReason()

  type ApprovalConfirmInfo = {
    secondaryPassword: string
    approveComment: string
    userCode: string
    reasonId: string
    reason: string
  }

  const approvalConfirmInfo = reactive<ApprovalConfirmInfo>({
    secondaryPassword: '',
    approveComment: '',
    userCode: '',
    reasonId: reasonId.value!,
    reason: reason.value!
  })

  getReasonList()

  const _getData = () => {
    approvalConfirmInfo.approveComment = getEditorContent()
    return approvalConfirmInfo
  }

  defineExpose({
    validate: async (): Promise<ApprovalConfirmInfo> => {
      return new Promise((resolve, reject) => {
        FormRef.value?.validate((e) => {
          if (e) reject(e)
          resolve(_getData())
        })
      })
    }
  })
</script>

```

优雅:可以使用new Promise处理异步问题，使用await 来接收Promise的值，当promise里成功会被await捕获到，当失败便会阻塞下面的操作await不会执行

## 易兰笔记(vite.config.ts)

```ts
const path = require('path')
import { defineConfig, loadEnv } from 'vite'
import proxyInfo from './dev.config'
import { useEnv } from './build/index'
import vueI18n from '@intlify/vite-plugin-vue-i18n'
// import vue from '@vitejs/plugin-vue'
// import vueJsx from '@vitejs/plugin-vue-jsx'
import { createSvgIconsPlugin } from 'vite-plugin-svg-icons'
import veauryVitePlugins from 'veaury/vite/index.js'
import viteCompression from 'vite-plugin-compression'

// https://vitejs.dev/config/
export default ({ mode }) => {
  const env = useEnv({ ...process.env, ...loadEnv(mode, process.cwd()) })
  const isSourcemap = env.VITE_APP_SOURCEMAP || false
  const isUseI18nPlugin = env.VITE_USE_I18N_PLUGIN || false
  return defineConfig({
    resolve: {
      alias: [
        {
          // 'vue-i18n': 'vue-i18n/dist/vue-i18n.runtime.esm-bundler.js',
          find: '@',
          replacement: path.resolve(__dirname, './src')
        },
        {
          find: '@antv/x6',
          replacement: '@antv/x6/dist/x6.js'
        },
        {
          find: '@antv/x6-vue-shape',
          replacement: '@antv/x6-vue-shape/lib'
        }
      ],
      extensions: ['.mjs', '.js', 'jsx', '.ts', '.tsx', '.json']
    },
    plugins: [
      createSvgIconsPlugin({
        iconDirs: [path.resolve(process.cwd(), 'src/icons/svg')],
        symbolId: 'icon-[dir]-[name]'
      }),
      veauryVitePlugins({
        type: 'vue'
      }),
      isUseI18nPlugin
        ? vueI18n({
            include: path.resolve(__dirname, './src/**/*/locale/**')
          })
        : () => {},
      viteCompression()
    ],
    server: {
      port: 9008,
      open: true,
      proxy: proxyInfo
    },
    base: '/',
    build: {
      outDir: env.VITE_APP_DIR,
      sourcemap: isSourcemap,
      target: 'es2022'
    },
    optimizeDeps: {
      esbuildOptions: {
        target: 'es2022'
      }
    },
    css: {
      preprocessorOptions: {
        scss: {
          additionalData: `@import "@/assets/css/global.scss";`
        }
      }
    }
    // define: {
    //   'process.env': process.env
    // }
  })
}

```

./build/index

```ts
type Recordable<T = any> = Record<string, T>
/**
 * @description 将 vite 的原始环境变量转成正确的类型
 * @param env 原始的 vite 环境变量
 * @returns 转换成正确类型的 vite 环境变量
 */
export const useEnv = (env: Recordable): ImportMetaEnv => {
  const ret: any = {}

  for (const envKey of Object.keys(env)) {
    let envValue = env[envKey]

    // 转成正确的布尔类型
    envValue = envValue === 'true' ? true : envValue === 'false' ? false : envValue

    ret[envKey] = envValue
  }

  return ret
}

```

./dev.config

```ts
// 是否处于后端联调
let isDev = false
const BaseUrlEnum = {
  /**
   * 254
   */
  Env_254: () => `http://192.168.1.254:${isDev ? '' : '9999'}`,
  /**
   * 253
   */
  Env_253: () => `http://192.168.1.253:${isDev ? '' : '9999'}`,
  /**
   * 252
   */
  Env_252: () => `http://192.168.1.252:${isDev ? '' : '9999'}`,
  /**
   * 0.1
   */
  Env_01: () => `http://192.168.0.1:${isDev ? '' : '80'}`,
  Env_02: () => `http://192.168.0.2:${isDev ? '' : '80'}`,
  Env_03: () => `http://192.168.0.3:${isDev ? '' : '80'}`,
  Env_04: () => `http://192.168.0.4:${isDev ? '' : '80'}`,

  /**
   * net
   */
  Env_NET: () => 'http://www.elabnote.net',
  /**
   * 恒驭内网
   */
  Env_HY: () => 'http://172.16.0.73'
}

/**
 * _改变 URL
 * @param baseURLOrFN 传 URL 地址 或者 BaseUrlEnum规定的函数
 * @param isDEV true为是处于后端联调
 * @returns http地址
 */
const changeURL = (baseURLOrFN: string | Function) => {
  if (typeof baseURLOrFN === 'string') {
    isDev = true
    return baseURLOrFN.includes('http://') ? baseURLOrFN : `http://192.168.1.${baseURLOrFN}`
  }
  return baseURLOrFN?.()
}

const getTargetIp = ({ baseUrl = targetUrl, port }: { baseUrl?: string; port: number | string }) => {
  return baseUrl + (isDev ? `:${port}` : '')
}

/**
 * 改变 URL
 */
// 例子1： const targetUrl = changeURL(BaseUrlEnum.Env_254)
// 例子2： const targetUrl = changeURL('http://192.168.1.某个后端IP' | '某个后端IP'), 不需要带端口
//        - const targetUrl = changeURL('http://192.168.1.99')
//        - const targetUrl = changeURL('99')
// const targetUrl = changeURL('99')

//jbLocal
//const targetUrl = changeURL('http://192.168.1.24')

const targetUrl = changeURL(BaseUrlEnum.Env_02)

export default {
  '/systemcenter/api': {
    // target: 'http://192.168.0.102:10003', // HY
    target: getTargetIp({ port: 8098 }),
    changeOrigin: true,
    secure: false
  },
  '/elabnoteWeb/api': {
    // target: 'http://192.168.0.102:10001', // 代理地址，这里设置的地址会代替axios中设置的baseURL
    target: getTargetIp({ port: 8090 }),
    changeOrigin: true, // 如果接口跨域，需要进行这个参数配置
    secure: false
  },
  '/material/api': {
    // target: 'http://192.168.0.102:10002',
    target: getTargetIp({ port: 8081 }),
    changeOrigin: true, // 如果接口跨域，需要进行这个参数配置
    secure: false
  },
  '/process': {
    // target: `http://www.elabnote.net`
    target: getTargetIp({ port: 5001 })
  },
  '/browser': {
    target: getTargetIp({ port: 9999 })
  },
  // '/process': {
  //   target: `http://192.168.1.17:5001`
  // }
  '/hysw_test/rest': {
    target: 'http://172.16.0.86:8080'
  }
}

```

## .env全局文件与打包配置pagkage.json

.env.development文件

```env
# .env
VITE_APP_DIR=dist
VITE_BASE_URL_WEB='/elabnoteWeb'
VITE_BASE_URL_SYSTEM='/systemcenter'
VITE_BASE_URL_MATERIAL='/material'
VITE_VUE_URL='//localhost:9527'
VITE_BASE_TIME='t'
VITE_BASE_DOCUMENT_TITLE='易览笔记'
VITE_VUE_WS='ws://192.168.1.254:9999'
VITE_VUE_RSP='1'

```

.env.hy

```env
# .env.hy
VITE_APP_DIR=dist_hy
VITE_BASE_URL_WEB='/elabnoteWeb'
VITE_BASE_URL_SYSTEM='/systemcenter'
VITE_BASE_URL_MATERIAL='/material'
VITE_USE_I18N_PLUGIN=false
VITE_VUE_URL='//192.168.0.102:11001'
VITE_VUE_WS='ws://192.168.0.102'
VITE_BASE_TIME='t'
VITE_VUE_RSP='1'
```

.env.boao

```env
# .env.boao
VITE_APP_DIR=dist_boao
VITE_BASE_URL_WEB='/elabnoteWeb'
VITE_BASE_URL_SYSTEM='/systemcenter'
VITE_BASE_URL_MATERIAL='/material'
VITE_USE_I18N_PLUGIN=false
VITE_VUE_URL='//192.168.1.236/ovbmy'
VITE_VUE_WS='ws://192.168.1.236'
VITE_BASE_TIME='t'
VITE_BASE_DOCUMENT_TITLE='易览笔记'
VITE_VUE_RSP='1'

```

package.json配置打包环境文件

```json
{
  "name": "bmy-elabnote-client-main",
  "private": true,
  "version": "1.3.4",
  "scripts": {
    "dev": "vite --host",
    "build": "vue-tsc --noEmit && vite build",
    "build-f": "vite build",
    "build-staging": "vue-tsc --noEmit && vite build --mode staging",
    "build-254": "vite build --mode 254",
    "build-253": "vite build --mode 253",
    "build-252": "vite build --mode 252",
    "build-net": "vite build --mode net",
    "build-com": "vite build --mode com",
    "build-hy": "vite build --mode hy",
    "build-hyp": "vite build --mode hyp",
    "build-hyprd": "vite build --mode hyprd",
    "build-hydev": "vite build --mode hydev",
    "build-ranshi": "vite build --mode ranshi",
    "build-ranship": "vite build --mode ranship",
    "build-boao": "vite build --mode boao",
    "build-boaot": "vite build --mode boaot",
    "build-instrument": "vite build --mode instrument",
    "preview": "vite preview",
    "prepare": "husky install"
  },
  "dependencies": {
    "@antv/layout": "^0.3.1",
    "@antv/x6": "^1.34.2",
    "@antv/x6-vue-shape": "^1.5.2",
    "@arco-design/bmy-react": "^1.0.3",
    "@arco-design/web-react": "^2.42.1",
    "@fullcalendar/core": "^5.11.3",
    "@fullcalendar/daygrid": "^5.11.3",
    "@fullcalendar/interaction": "^5.11.3",
    "@fullcalendar/timegrid": "^5.11.3",
    "@fullcalendar/vue3": "^5.11.2",
    "@jspreadsheet/autowidth": "^2.2.1",
    "@jspreadsheet/validations": "^1.2.3",
    "@jspreadsheet/xls": "^1.6.1",
    "@tiptap/core": "2.0.0-beta.202",
    "@tiptap/extension-blockquote": "2.0.0-beta.202",
    "@tiptap/extension-bold": "2.0.0-beta.203",
    "@tiptap/extension-bullet-list": "2.0.0-beta.203",
    "@tiptap/extension-code-block": "2.0.0-beta.203",
    "@tiptap/extension-color": "2.0.0-beta.203",
    "@tiptap/extension-document": "2.0.0-beta.204",
    "@tiptap/extension-dropcursor": "2.0.0-beta.207",
    "@tiptap/extension-gapcursor": "2.0.0-beta.207",
    "@tiptap/extension-hard-break": "2.0.0-beta.207",
    "@tiptap/extension-heading": "2.0.0-beta.205",
    "@tiptap/extension-highlight": "2.0.0-beta.205",
    "@tiptap/extension-history": "2.0.0-beta.205",
    "@tiptap/extension-image": "2.0.0-beta.204",
    "@tiptap/extension-italic": "2.0.0-beta.205",
    "@tiptap/extension-link": "2.0.0-beta.205",
    "@tiptap/extension-list-item": "2.0.0-beta.203",
    "@tiptap/extension-ordered-list": "2.0.0-beta.205",
    "@tiptap/extension-paragraph": "2.0.0-beta.205",
    "@tiptap/extension-strike": "2.0.0-beta.205",
    "@tiptap/extension-subscript": "2.0.0-beta.209",
    "@tiptap/extension-superscript": "2.0.0-beta.209",
    "@tiptap/extension-table": "2.0.0-beta.207",
    "@tiptap/extension-table-cell": "2.0.0-beta.207",
    "@tiptap/extension-table-header": "2.0.0-beta.207",
    "@tiptap/extension-table-row": "2.0.0-beta.207",
    "@tiptap/extension-task-item": "2.0.0-beta.205",
    "@tiptap/extension-task-list": "2.0.0-beta.205",
    "@tiptap/extension-text": "2.0.0-beta.205",
    "@tiptap/extension-text-align": "2.0.0-beta.205",
    "@tiptap/extension-text-style": "2.0.0-beta.204",
    "@tiptap/extension-underline": "2.0.0-beta.205",
    "@tiptap/prosemirror-tables": "^1.1.3",
    "@tiptap/react": "2.0.0-beta.199",
    "@tiptap/starter-kit": "2.0.0-beta.199",
    "@tiptap/suggestion": "2.0.0-beta.207",
    "@types/react": "^1.0.0",
    "@vitejs/plugin-react": "^2.2.0",
    "@vitejs/plugin-vue-jsx": "^2.0.1",
    "@vueuse/core": "^9.3.0",
    "axios": "^1.1.2",
    "classnames": "^2.3.2",
    "crypto-js": "^4.1.1",
    "dagre": "^0.8.5",
    "decimal.js": "^10.4.3",
    "dhtmlx-gantt": "^7.1.13",
    "file-saver": "^2.0.5",
    "html2canvas": "^1.4.1",
    "insert-css": "^2.0.0",
    "jexcel": "^4.6.1",
    "jexcel-pro": "^7.9.4",
    "js-cookie": "^3.0.1",
    "js-export-excel": "^1.1.4",
    "jspdf": "^2.5.1",
    "jspreadsheet": "^9.1.13",
    "jspreadsheet-bmy": "^1.0.10",
    "jspreadsheet-ce": "^4.11.1",
    "jsuites": "^4.16.7",
    "jszip": "^3.10.1",
    "ketcher-core": "^2.6.4",
    "ketcher-react": "^2.6.4",
    "ketcher-standalone": "^2.6.4",
    "lemonadejs": "^2.8.2",
    "less": "^4.1.3",
    "less-loader": "^11.1.0",
    "lodash": "^4.17.21",
    "mitt": "^3.0.0",
    "moment": "^2.29.4",
    "pinia": "^2.0.23",
    "pinia-plugin-persistedstate": "^2.2.0",
    "print-js": "^1.6.0",
    "prosemirror-dropcursor": "^1.6.1",
    "prosemirror-gapcursor": "^1.3.1",
    "prosemirror-history": "^1.3.0",
    "prosemirror-model": "^1.18.3",
    "prosemirror-state": "^1.4.2",
    "prosemirror-view": "^1.29.1",
    "qiankun": "^2.8.1",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-file-viewer": "^1.2.1",
    "react-hovertable": "^0.3.0",
    "styled-components": "^5.3.6",
    "tippy.js": "^6.3.7",
    "veaury": "^2.3.9",
    "vue": "^3.2.40",
    "vue-clipboard3": "^2.0.0",
    "vue-i18n": "9.2.2",
    "vue-router": "^4.1.5",
    "vuedraggable": "^4.1.0"
  },
  "devDependencies": {
    "@arco-design/web-vue": "2.46.0",
    "@intlify/vite-plugin-vue-i18n": "^6.0.3",
    "@types/jszip": "^3.4.1",
    "@types/lodash": "^4.14.186",
    "@types/node": "^18.16.18",
    "@typescript-eslint/eslint-plugin": "^5.39.0",
    "@typescript-eslint/parser": "^5.39.0",
    "@vitejs/plugin-vue": "^3.1.2",
    "autoprefixer": "^10.4.12",
    "eslint": "^8.25.0",
    "eslint-config-prettier": "^8.5.0",
    "eslint-plugin-prettier": "^4.2.1",
    "eslint-plugin-vue": "^9.6.0",
    "husky": "^8.0.1",
    "lint-staged": "^13.0.3",
    "postcss": "^8.4.17",
    "prettier": "^2.7.1",
    "sass": "^1.55.0",
    "scss": "^0.2.4",
    "scss-loader": "^0.0.1",
    "tailwindcss": "^3.1.8",
    "typescript": "^4.8.4",
    "vite": "^3.1.6",
    "vite-plugin-compression": "^0.5.1",
    "vite-plugin-svg-icons": "^2.0.1",
    "vue-tsc": "^1.0.1"
  },
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged"
    }
  },
  "lint-staged": {
    "*.{js,vue,ts,jsx,tsx}": [
      "prettier --write",
      "eslint --fix"
    ],
    "*.{html,css,less,scss,md}": [
      "prettier --write"
    ]
  }
}

```

使用全局环境变量

constant.ts文件

```ts
export const Env = Object.freeze<IEnv>({
  isDev: import.meta.env.MODE == 'developments',
  isHy:
    import.meta.env.MODE == 'hy' ||
    import.meta.env.MODE == 'hyp' ||
    import.meta.env.MODE == 'hyprd' ||
    import.meta.env.MODE == 'hydev',
  isRanshi: import.meta.env.MODE == 'ranshi' || import.meta.env.MODE == 'ranship',
  isBoao: import.meta.env.MODE == 'development' || import.meta.env.MODE == 'boaot',
  isCom: import.meta.env.MODE == 'com',
  isTest254: import.meta.env.MODE == '254',
  isTest253: import.meta.env.MODE == '253' || import.meta.env.MODE == '252',
  isNet: import.meta.env.MODE == 'net',
  isInstrument: import.meta.env.MODE == 'instrument'
})

<!-----------------------------------使用全局配置的env------------------------------------>
  const actionUrl = computed(() => {
    return import.meta.env.VITE_BASE_URL_MATERIAL + TemplateTypeEnum.INPUTBATCHISSUE
  })
```



## TypeScript之Pick与Omit与keyof

```ts
export interface INoteMenuInjectionKey
  extends IUseMenuTreeInfoRes,
    Pick<IUseSearchInfoOptions, 'searchInfo' | 'handleChangeJobInSearchInfo' | 'resetSearchInfo'>,
    Omit<IUseNoteMenuBreadcrumbInfoOptions, 'currentCrumbs' | 'sliceCrumb'>,
    TUseAllProjectTagViewTriggerInfoRes {
  // //projectSelector
  // projectId: WritableComputedRef<string | undefined>
  // setProjectId: (newValue: string) => Promise<void>
  // projectSelectorListInfo: IProjectSelectorListInfo
  // refreshProjectSelectorList(): Promise<void>

  //crumbs common api
  changeCurrentCrumbByClick(index: number): Promise<void>
  //searchKeyword
  searchKeyword: WritableComputedRef<string>
  setSearchKeyword: (newValue: string) => void
}
```

* Pick表示生成类型取IUseSearchInfoOptions类型的与后面与类型的交集

* Omit表示生成类型IUseNoteMenuBreadcrumbInfoOptions类型中不属于后面并集列的属性

**provide与inject可以配合着使用Symbol()生成唯一关键词-------vue、react**

```ts
import { InjectionKey } from 'vue'
export interface INoteMenuInjectionKey{}

export const NoteMenuInjectionKey = Symbol() as InjectionKey<INoteMenuInjectionKey>
provide(NoteMenuInjectionKey,{})
inject(NoteMenuInjectionKey) as INoteMenuInjectionKey
```

获取对象类型type的key值字符串类型

```ts
Array<keyof TStockOperationTableRow>
  <!------------------------------------------------>
export type TStockOperationTableRow = {
  id: string
  tableId: string
  /**
   * 实物id
   */
  entityId?: string
  /**
   * 行执行状态
   */
  state?: StockOperationTableState
  /**
   * 操作类型
   */
  action?: StockOperationActionEnum
}
```

## nextTick与setTimeout前端实行loading

```ts
  watch(selectShowColumns, (newSelectShowColumns) => {
    basicLoading.value = true
    setTimeout(() => {
      const targetColumns = showCheckboxColumns.value.filter(
        (item) => newSelectShowColumns.includes(item?.dataIndex ?? '') || item.isShowFliter === false
      )
      const dataIndexs = showCheckboxColumns.value
        .filter((item) => newSelectShowColumns.includes(item?.dataIndex ?? ''))
        .map((item) => item.dataIndex!)

      Emits('update:columns', targetColumns)
      Emits('changeColumns', { columns: targetColumns, dataIndexs })
      basicLoading.value = false
    })
  })

```

猜测可能组件渲染与loading的变量同步进行，所以写在一起时浏览器会自动计算可能是最后一起的值

，当开启异步时就会先监听开始loading动画，

## .npmrc文件配置下载包npm

.npmrc文件

```js
registry=http://192.168.1.253:18081/repository/npm-private/
//192.168.1.253:18081/repository/npm-private/:_auth="emhhbmd5OmJteTEyMw=="

```

* 表示页面推送版本与包从哪里下载，公司下载是公司自己配的远端的整理包，代替了普通下载

在下载一个依赖包想对奇修改自己的版本

首先从远程仓库下载，然后修改提交push到远程仓库，顺便修改一下packge.json里面依赖的版本包的version版本一起提交

```js
{
  "name": "jspreadsheet-bmy",
  "title": "The Javascript Spreadsheet",
  "description": "Jspreadsheet is a lightweight, vanilla javascript plugin to create amazing web-based interactive tables and spreadsheets compatible with Excel, Google Spreadsheets and any other spreadsheet software.",
  "repository": {
    "type": "git",
    "url": "https://github.com/jspreadsheet/ce.git"
  },
  "author": {
    "name": "Contact <contact@spreadsheet.com>"
  },
  "keywords": [
    "spreadsheet",
    "tables",
    "table",
    "excel",
    "grid",
    "grid-editor",
    "data-table",
    "data-grid",
    "data-spreadsheet"
  ],
  "dependencies": {
    "jsuites": "^4.0.0"
  },
  "main": "dist/jexcel.js",
  "version": "1.0.22",
  "bugs": "https://github.com/jspreadsheet/ce/issues",
  "homepage": "https://github.com/jspreadsheet/ce",
  "download": "https://github.com/jspreadsheet/ce/archive/master.zip"
}

```

使用推送(发布)

```js
npm publish
```

可以发布到.npmrc配置的地址远端下，注意在引用修改包里版本要为修改后的版本再拉取

## 解释vite创建配置.env全局变量文件

`.env`文件是一个用于存储环境变量的文件。在开发和部署应用程序时，经常需要在不同的环境中配置不同的变量，例如 API 地址、数据库连接信息、密钥等。在许多应用程序中，`.env` 文件通常包含一个或多个键值对，用于存储环境变量。

Vite 中的环境变量**必须以 `VITE_` 前缀开头才能被识别**。例如，如果您在 `.env` 文件中定义了一个名为 `API_URL` 的变量，它将不会被 Vite 识别。您应该将其命名为 `VITE_API_URL`。

**创建`.env`相关文件**

```js
.env                # 所有情况下都会加载
.env.[mode]         # 只在指定模式下加载
```

.env文件

```
# .env
VITE_APP_DIR=dist
VITE_BASE_URL_WEB='/elabnoteWeb'
VITE_BASE_URL_SYSTEM='/systemcenter'
VITE_BASE_URL_MATERIAL='/material'
VITE_USE_I18N_PLUGIN=true
VITE_VUE_URL='//192.168.1.254:9000'
VITE_VUE_WS='ws://192.168.0.102'
VITE_BASE_TIME='d'
VITE_REACT_CHEMICAL='http://192.168.1.254:9001/#/chemicalEditor'
```

* 使用如: import.meta.env.VITE_VUE_WS

**`.env.development`文件**

标识开发配置文件

```js
# 只在开发环境加载
VITE_USER_NODE_ENV = development

# 打包时是否删除 console
VITE_DROP_CONSOLE = true

# 公共基础路径
VITE_PUBLIC_PATH = /

# 开发环境接口地址
VITE_API_URL = /api

# 开发环境跨域代理，可配置多个
VITE_PROXY = [["/api","https://mock.mengxuegu.com/mock/6453b964af3bc37f99a23916"]]
```

**`.env.production`文件**

标识生产配置文件

```js
# 只在生产环境加载
VITE_USER_NODE_ENV = production

# 公共基础路径
VITE_PUBLIC_PATH = /

# 是否启用 gzip 或 brotli 压缩打包，如果需要多个压缩规则，可以使用 “,” 分隔
# Optional: gzip | brotli | none
VITE_BUILD_COMPRESS = none

# 打包压缩后是否删除源文件
VITE_BUILD_COMPRESS_DELETE_ORIGIN_FILE = false

# 打包时是否删除 console
VITE_DROP_CONSOLE = true

# 是否启用图片压缩
VITE_USE_IMAGEMIN = true

# 线上环境接口地址
VITE_API_URL = "http://www.yanhongzhi.com"
```

**`.env.test`文件**

```js
# 测试环境
VITE_USER_NODE_ENV = test

# 公共基础路径
VITE_PUBLIC_PATH = /

# 是否启用 gzip 或 brotli 压缩打包，如果需要多个压缩规则，可以使用 “,” 分隔
# Optional: gzip | brotli | none
VITE_BUILD_COMPRESS = none

# 打包压缩后是否删除源文件
VITE_BUILD_COMPRESS_DELETE_ORIGIN_FILE = false

# 打包时是否删除 console
VITE_DROP_CONSOLE = true

# 测试环境接口地址
VITE_API_URL = "http://www.yanhongzhi.com"
```

**切换环境**

不是配置了不同环境的文件吗？怎么确定当前是什么环境？很简单，答案就在`package.json`文件中

```js
"scripts": {
    "dev": "vite",
    "build": "vue-tsc && vite build",
    //....
}
```

默认的`npm run dev`和`npm run build`就分别对应`development`开发环境和`production`生成环境。

当然，我们也可以自己进行设置,比如:

```js
"scripts": {
    "dev": "vite",
    "build": "vue-tsc && vite build",
    "build:dev": "vue-tsc && vite build --mode development",
    "build:test": "vue-tsc && vite build --mode test",
    //....
}
```

## @vueuse/core的使用

* 获取单个元素的高度宽度

```js
 import { useElementSize } from '@vueuse/core'

  const { height } = useElementSize(WrapperRef)
  const warpSheetHeight = computed(() => `${height.value - 100}px`)

```

* 在不点击失去特定的html元素触发方法

```js
 import { onClickOutside } from '@vueuse/core'
   onClickOutside(dateNeed, () => {
    showDateBtn.value = false
  })
  
  
<! -------------------------------加上绑定元素------------------------------------->
import { onClickOutside, useElementBounding } from '@vueuse/core'
```

## 解决upload上传组件可能遇到被卸载没有用

解决可以给组件一个class类，使用选择器操作dom直接调取dom中所在的方法

```vue
   <a-upload
      v-show="false"
      :class="['task-hearder-action-import']"
      :action="actionUrl"
      :auto-upload="false"
      ref="uploadRef"
      @change="onChangeFile"
      :show-file-list="false"
    >
      <template #upload-button>
        <span>导入</span>
      </template>
    </a-upload>
<!--------------script-------------->
  /**
   * 文件导入开始
   */
  const importFile = () => {
    const targetElement = 	  document.querySelector('.task-hearder-action-import  input[type=file]') as HTMLInputElement
    targetElement?.click()
  }
```

这样可以主动调取方法可以解决很多同样的问题

## 主动上传文件upload

file.ts

```ts
/**
 * 上传文件
 */
interface UploadComm {
  referenceId: string
  referenceType: UploadFileRefTypeEnum
  clientId?: string
  file: FormData
}

export const uploadCommon = (data: UploadComm) => {
  return webRequest.post({
    url: `/fileTransfer/uploadCommon?referenceId=${data.referenceId}&referenceType=${data.referenceType}&clientId=${data.clientId}`,
    data: data.file, //file ---  new FormData()
    noCancel: true,
    timeout: 1000 * 60 * 60
  })
}
export const uploadImageCommon = (data: any) => {
  return webRequest.post({
    url: `/fileTransfer/uploadCommon?referenceType=${data.referenceType}`,
    data: data.file,
    noCancel: true,
    timeout: 1000 * 60 * 60
  })
}
```

## tsconfig.json配置全局引用

```javascript
{
  "compilerOptions": {
    "target": "esnext",
    "useDefineForClassFields": true,
    "module": "esnext",
    "moduleResolution": "node",
    "strict": true,
    "jsx": "preserve",
    "sourceMap": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "esModuleInterop": true,
    "lib": ["esnext", "dom"],
    "skipLibCheck": true,
    "noImplicitAny": false,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@public/*": ["./public/*"]
    }
  },
  "include": [
    "src/**/*.ts",
    "src/**/*.d.ts",
    "src/**/*.tsx",
    "src/**/*.vue",
    "build/*.ts",
    "dev.config.ts",
    "vite.config.ts"
  ],
  "references": [{ "path": "./tsconfig.node.json" }]
}

```

## *使用createVNode，render挂载组件到某一个dom元素上面(类似底层重要思想)

* **vue底层也是这么类似实现**

template

```vue
<div ref="Test"></div>
```

script

<script setup lang="tsx" />

```tsx
  import { Checkbox } from '@arco-design/web-vue'

  // 创建全选功能
  const [checkedAll, setCheckedAll] = useState<boolean>(false)
  //半选状态
  const [indeterminate, setIndeterminate] = useState<boolean>(false)

  // 点击全选
  function handleChangeAll(isCheckAll) {
    const sheetData = BasicSheetRef.value?.getData() ?? []
    for (let rowIndex = 0; rowIndex < sheetData.length; rowIndex++) {
      BasicSheetRef.value?.setData?.(
        {
          colIndex: 0,
          rowIndex,
          isTriggerChangeEidtorCallback: false
        },
        singleValueToArray(isCheckAll)
      )
      setCheckedAll(isCheckAll)
      setIndeterminate(false)
    }
  }
<!-----------------主要挂载逻辑-------------------->
  const MyCheckbox = () => (
    <Checkbox
      model-value={checkedAll.value}
      indeterminate={indeterminate.value}
      onChange={handleChangeAll}
      disabled={Props.readonly}
    />
  )
  onMounted(() => {
    const vnode = createVNode(MyCheckbox)
    render(vnode, Test.value)
  })
```

* 因为模板原因不需要写.value,会自动帮我们翻译.value的环境,监听变量,但在tsx里面不行,他需要用到传值的时候需要用到.value,可以在tsx中改变值的时候,依然具有响应式;
* 相当于我们手动给元素附加一个响应式的组件节点(**重要**),这样内部依然可以被监听实现**(vue类似底层渲染也是插入的)**,
* 当然猜测自然传入到组件中也会被props解析.value形式;
* 猜测原生的.value形似不是单纯的存储变量,**会对里面进行对象响应式监听**,所以直接向组件里传入值,依然会享有模板响应式功能
* 相当于在模板中添加,不过没有模板自动解析.value
* 难以理解的理念，当使用这个方法全为挂载组件时，依然可以想正常挂载在vue组件下的组件使用store，以及其他功能，这个理解理解未vue同时挂载也是在dom元素下，这个节点依然是挂载在dom元素下

## vue中CreateApp给任意dom元素添加vue组件

```tsx
import { createApp } from 'vue'  
const RootCpn = (
    <ComplexLocationSelector
      dataSource={parsedDatas}
      onUpdateValue={updateValue}
      hideTabs={hideTabs}
      showShipmentOption={showShipmentOption}
    />
  )
    const _instance = createApp(RootCpn)
  _instance.mount(element)
  return { fg: element, instance: _instance }
```

综上所述如果需要响应式变量,可以执行响应式添加改变,是否支持ref函数创建的.value的响应式有待自己考察

* 想当于自己添加一个createApp用来新增一个vue
* 可以用在使用原生js搭建的组件里用vue时,使用

## 前端生成excel文件方法

```ts
import ExportJsonExcel from 'js-export-excel'
/**
 * 导出为 Excel 的工具函数
 * @param _data 数据源,是一个二维数组,第一个元素为表头,剩余元素为表体
 * @param option 额外的配置项,目前只需要提供文件名即可
 * @returns
 */
export function exportExcelFunc(_data: Array<[]>, option: { [key in string]: any }) {
  let targetHeader: [] = []
  const sheetData: [] = []

  let { fileName } = option
  //过滤掉excel不支持的特殊字符 \ / ? * [ ]
  fileName = fileName?.replace(/[\\\/?*\[\]]/g, '') ?? ''

  if (Array.isArray(_data) && _data.length > 0) {
    const [firstArr] = _data.splice(0, 1)
    targetHeader = firstArr
  }
  _data.forEach((items) => {
    if (Array.isArray(items)) {
      const targetRowInfo = {}
      items.forEach((innerItem, index) => {
        targetRowInfo[targetHeader[index]] = innerItem
      })
      sheetData.push(targetRowInfo as unknown as never)
    }
  })

  const datas = [
    {
      sheetData,
      sheetName: 'sheet1',
      sheetHeader: targetHeader,
      sheetFilter: targetHeader
    }
  ]

  const toExcel = new ExportJsonExcel({
    fileName,
    datas
  })
  //   调用保存方法
  toExcel.saveExcel()
}


```

## iframe标签广播室传播

```vue
<template>
  <iframe id="targetIframe" :src="targetUrl" width="100%" height="400px"></iframe>
</template>

<script setup lang="ts">
  import { SequenceData } from '@/react_app/editor/extensions/custom-nucleic-acid-and-protein-editor'
  import { onMounted, onUnmounted, ref, watch } from 'vue'
  import { targetOrigin, targetUrl } from './util'

  const Props = defineProps<{
    sequenceData: SequenceData
  }>()
  const Emit = defineEmits<{
    (e: 'change', value: any): void
  }>()

  const sequenceData = ref<SequenceData>(Props.sequenceData)

  const receiveChildMessage = (e) => {
    if (e.data?.type !== 'bmy') return
    //console.log('父页面接收子页面的数据', e.data, e)
    sequenceData.value = e.data.sequenceData
  }

  onMounted(() => {
    const targetIframe = document.getElementById('targetIframe') as HTMLIFrameElement

    targetIframe.onload = () => {
      //console.log('父页面向子页面发送数据', Props.sequenceData)
      targetIframe.contentWindow?.postMessage(
        JSON.stringify({ type: 'bmy', sequenceData: Props.sequenceData }),
        targetOrigin.value
      )
    }

    // postMessage 接收
    window.addEventListener('message', receiveChildMessage, false)
  })

  onUnmounted(() => {
    window.removeEventListener('message', receiveChildMessage, false)
  })

  watch(
    sequenceData,
    () => {
      Emit('change', {
        sequenceData: sequenceData.value
      })
    },
    {
      deep: true
    }
  )
</script>

<style scoped lang="scss"></style>

```



## fetch方法发起请求

```js
export const getTargetUrl = () => {
  // eslint-disable-next-line no-restricted-globals
  if (location.hostname === "www.elabnote.net") {
    return "http://www.elabnote.net:5000";
  } else {
    // return "http://192.168.1.22:5000";
    return "http://192.168.1.15:5003";
  }
};

const fetchApi = async ({ url, method, bodyData }) => {
  const res = await (
    await fetch(getTargetUrl() + url, {
      method,
      mode: "cors",
      body: JSON.stringify(bodyData)
    })
  ).json();

  return res;
};

<!-----------------------------实例-------------------------------->
export const fetchPrimersSave = async ({ memoid, data }) => {
  return await fetchApi({
    url: "/sequence/primer/design_save",
    method: "post",
    bodyData: {
      memoid,
      data
    }
  });

};
```

## 给固定的路由页面动态添加子路由

/router文件

```ts
/*
 * @Author: zhangy
 * @Date: 2022-06-15 21:04:26
 * @LastEditors: zhangy
 * @LastEditTime: 2023-04-28 16:35:26
 * @FilePath: \elabnote-front-main\src\router\index.ts
 * Copyright (c) 2022 by BMY, All Rights Reserved.
 */
import { createRouter, createWebHistory, NavigationGuardNext, RouteLocationNormalized } from 'vue-router'
import { usePermission } from '@/hooks'
// import Layout from '@/layout/index.vue'
import Login from './modules/login'
import ResetPassword from './modules/reset-password'
import appRoutes from './modules'
import Cookie from 'js-cookie'
import { clearLocalStorage } from '@/util/cache/clearLocalStorage'

const router = createRouter({
  history: createWebHistory(),
  routes: [
    {
      path: '/',
      redirect: 'login'
    },
    Login,
    ResetPassword,
    {
      name: 'main',
      path: '/main',
      redirect: { name: '_workspace' },
      component: () => import('@/layout/index.vue'),
      children: appRoutes
    },
    {
      path: '/:pathMatch(.*)*',
      name: 'notFound',
      component: () => import('@/views/not-found/index.vue')
    }
  ],
  scrollBehavior() {
    return { top: 0 }
  }
})

const handleMainRoute = ({
  to,
  from,
  next
}: {
  to: RouteLocationNormalized
  from: RouteLocationNormalized
  next: NavigationGuardNext
}) => {
  const hashPath = to.hash
  if (hashPath.includes('#/data-record/record/export') || to.meta.isVisitor === true) {
    return next()
  }
  const tk = Cookie.get('tk')
  const { oldAccRouter, isAllow } = usePermission()
  if (!tk || !isAllow) {
    clearLocalStorage()
    return next(`/login?redirect=${to.path}`)
  } else if (oldAccRouter(to)) {
    return next()
  } else {
    return next({ name: from.name! })
  }
}

const handleLogin = ({ from, next }) => {
  const tk = Cookie.get('tk')
  if (!tk) {
    return next()
  } else {
    return from.name ? next({ name: from.name }) : next({ name: '_workspace' })
  }
}

// 导航守卫
router.beforeEach((to, from, next) => {
  if (to.name === 'notFound') {
    return next()
  } else if (to.path.includes('main')) {
    return handleMainRoute({ to, from, next })
  } else if (to.name === 'login') {
    return handleLogin({ from, next })
  } else {
    return next()
  }
})

export default router

```

store/index.ts

```ts
 //router拿到的是实例
import router from '@/router'
/**
     * 得到采购页面路由
     */
    async getPurchasingRoute() {
      const summaryRoutes: any[] = []
      const { data } = await getProcurementApproveTemplates()
      data.forEach((item) => {
        const DynamicRoute = {
          path: `${item.groupId}`,
          name: `${item.groupId}`,
          component: () => import('@/views/purchasing-management/index.vue'),
          meta: {
            title: `${item.groupName}`
          }
        }
		//第一步 选择一个父级路由名称添加路由
        router.addRoute('purchasingManagement', DynamicRoute)
        const userStore = useUserStore()
        //第二步 给路由添加到这个父级路由下的子集下
        const mainRoute = router.getRoutes().find((el) => el.name === 'purchasingManagement')
        mainRoute?.children.push(DynamicRoute)
        userStore.changeIsRouterUpdate()

        summaryRoutes.push({
          path: `${item.groupId}`,
          name: `${item.groupId}`,
          component: () => import('@/views/purchasing-management/index.vue'),
          meta: {
            title: `${item.groupName}`
          }
        })
      })
      this.purchasingChildrenRoute = summaryRoutes
    },
```

使用完整路由

menu/index.vue

```vue
<template>
  <!-- {{ selectedKeys }} -->
  <a-menu
    class="menu-root"
    :auto-open="false"
    :auto-open-selected="true"
    :level-indent="34"
    :style="{ width: '100%', height: '100%' }"
    :selected-keys="selectedKeys"
  >
    <div class="logo" style="display: flex; flex-direction: column; justify-content: center">
      <a-space :size="32">
        <img :src="getImageUrl('logonote.png')" style="width: 40px" />
        <Transition>
          <span v-if="!innerCollapsed" style="font-weight: 700; font-size: 20px; color: #fff">易览笔记</span>
        </Transition>
      </a-space>
    </div>
    <MenuItem :menus="menus" class="menu-item" />
  </a-menu>
</template>

<script setup lang="ts">
  import { ref, watch } from 'vue'
  import { RouteRecordNormalized, useRouter, useRoute } from 'vue-router'
  import MenuItem from './MenuItem.vue'
  import { getImageUrl } from '@/util'
  import { useUserStore } from '@/store'
  import { storeToRefs } from 'pinia'

  const props = withDefaults(defineProps<{ collapsed: boolean }>(), {
    collapsed: false
  })
  const { isRouterUpdate } = storeToRefs(useUserStore())
  const innerCollapsed = ref<boolean>(props.collapsed)
  const router = useRouter()
  const route = useRoute()

  const getRoutes = () => router.getRoutes().find((el) => el.name === 'main') as RouteRecordNormalized
  const menus = ref<RouteRecordNormalized>()

  const getMenus = () => {
    const menuRoutes = [] as any
    getRoutes().children.forEach((routeItem) => {
      if (routeItem.name !== 'registrationAndBatchInfoQuery' && routeItem.name !== 'inventory')
        menuRoutes.push(routeItem)
    })
    return menuRoutes
  }

  const selectedKeys = ref([`${route.path}${route.hash}`.replace('/main/', '')])

  watch(
    () => route.fullPath,
    () => {
      selectedKeys.value = route.matched.map((matchdItem) =>
        `${String(matchdItem.name)}${route.hash}`.replace('/main/', '')
      )
      // console.log('selectedKeys.value', route, selectedKeys.value)
    },
    {
      immediate: true
    }
  )

  watch(
    isRouterUpdate,
    () => {
      menus.value = getMenus()
    },
    {
      immediate: true
    }
  )

  watch(
    () => props.collapsed,
    (newCollapsed) => {
      if (!newCollapsed) {
        setTimeout(() => {
          innerCollapsed.value = newCollapsed
        }, 100)
      } else {
        innerCollapsed.value = newCollapsed
      }
    }
  )
</script>

```

roter.ts

```ts
import { localCache } from '@/util'

export enum PurchasingManagementEnum {
  /**
   * 采购管理
   */
  PURCHASING_MANAFEMENT = 'purchasingManagement'
}

export default {
  path: 'purchaing_management',
  name: PurchasingManagementEnum.PURCHASING_MANAFEMENT,
  component: () => import('@/views/purchasing-management/mainRoute.vue'),
  meta: {
    title: 'router.sgManagement',
    icon: 'main_purchase'
  },
  children:
    localCache.getCache('purchasingChildrenRoute')?.map((item) => {
      return {
        ...item,
        component: () => import('@/views/purchasing-management/index.vue')
      }
    }) ?? []
}

```

配合着登录与本地缓存与接口设计，实现动态添加某一个父级路由的子集i路由，支持刷新操作

## 使用defineComponent()的TSX也可以实现vue双向绑定v-model

EntityParam.tsx(以前富文本中的一个插件文件)

```tsx
import { Space, Modal, InputNumber } from '@arco-design/web-vue'
import { createApp, defineComponent, nextTick, ref } from 'vue'
import {
  ReferenceEntityItemUsageTypeEnum,
  ReferenceEntityItemSourceEnum,
  ReferenceEntityItemUsageStatusEnum
} from '@/common/enum'
import SelectedEntity from './SelectedEntity.vue'
const _datas = ref<Array<Entity>>([])
const _referenceEntityId = ref<string>()
export const EntityModal = defineComponent({
  props: {
    isLimit: {
      type: Boolean
    },
    customParams: {
      type: Object
    },
    disabled: {
      type: Boolean
    }
  },
  emits: ['handleOk'],
  setup(Props, { emit, expose }) {
    const visible = ref<boolean>(true)
    expose({
      openModal(data?: Entity[]) {
        if (data) {
          _datas.value = data
        }
        visible.value = true
        nextTick(() => {
          SelectedEntityRef.value!.setSelected(_datas.value)
        })
      }
    })
    const handleOk = () => {
      handleCancel()
      emit('handleOk', _datas.value)
    }

    const handleCancel = () => {
      visible.value = false
    }
    const SelectedEntityRef = ref<InstanceType<typeof SelectedEntity>>()
    return () => (
      <div id="jspreadsheet-entity-modal">
        <Modal
          draggable
          popupContainer={document.getElementById('jspreadsheet-entity-modal')!}
          bodyStyle={{ minHeight: '300px' }}
          title={'选择实物'}
          titleAlign={'start'}
          visible={visible.value}
          onOk={handleOk}
          onCancel={handleCancel}
          unmountOnClose>
          {/* @ts-ignore */}
          <SelectedEntity
            ref={SelectedEntityRef}
            referenceId={_referenceEntityId.value}
            customParams={Props.customParams}
            isLimit={Props.isLimit}
            v-model={[_datas.value, 'datas']}
          />
          <Space direction={'vertical'} style={{ width: '100%', marginTop: '10px' }}>
            {Array.isArray(_datas.value) &&
              _datas.value?.map((item) => (
                <InputNumber
                  disabled={Props.disabled ?? false}
                  v-model={[item.usageCapacity]}
                  hide-button
                  v-slots={{
                    prepend: () => <span>🧪 {item.referenceEntityName}</span>,
                    append: () => <span>{item.unitName}</span>
                  }}
                />
              ))}
          </Space>
        </Modal>
      </div>
    )
  }
})

export const InnerEntityParam = (Props) => {
  const { callback, datas, customParams, isLimit } = Props
  const list = ref<Array<Entity>>(datas)
  const handleClick = (values) => {
    list.value = values
    callback(values)
  }
  const EntityModalRef = ref<InstanceType<typeof EntityModal>>()
  return (
    <>
      <EntityModal ref={EntityModalRef} onHandleOk={handleClick} customParams={customParams} isLimit={isLimit} />
      <Cell datas={_datas.value} />
    </>
  )
}

export const EntityParam = (
  element: HTMLElement,
  callback: (...args) => void,
  datas: Array<Entity>,
  extras: Array<{ referenceEntityId: string; [key: string]: any }>,
  options: { customParams: object; isLimit: boolean }
) => {
  _datas.value = datas
  _referenceEntityId.value = extras?.[0]?.referenceId

  const Com = (
    <InnerEntityParam callback={callback} datas={datas} customParams={options.customParams} isLimit={options.isLimit} />
  )

  const _instance = createApp(Com)
  _instance.mount(element)
  return { fg: element, instance: _instance }
}

export const changeDatas = (datas: Array<Entity>) => {
  _datas.value = datas
}

export const Cell = (Props: { datas: Array<Entity> }) => {
  const { datas } = Props
  return (
    <Space direction={'vertical'}>
      {Array.isArray(datas) &&
        datas?.map((i) => (
          <Space>
            <span>🧪 {i.referenceEntityName}</span>
            <span>{i.usageCapacity}</span>
            <span>{i.unitName}</span>
          </Space>
        ))}
    </Space>
  )
}
export const ShowCell = (datas: Array<Entity>) => {
  return <Cell datas={datas} />
}
```

SelectedEntity.vue

```vue
<template>
  <div ref="DivRef" style="width: 100%; height: 100%">
    <Space>
      <Select style="width: 80px" v-model="actionType" @change="changeActionType" :options="typeOptions" />
      <Select
        style="width: 390px"
        :multiple="false"
        allow-clear
        @change="handleChange"
        v-model="selectedRowKeys"
        :options="options"
        :virtual-list-props="{
          height: 200
        }"
        :field-names="{
          label: 'productName',
          value: 'id'
        }"
        :loading="loading"
      >
        <template #option="{ data }">
          <Space>
            <Tag>{{ data.productName }}</Tag>
            <Tag v-if="actionType === MaterialTypeEnum.ENTITY">{{ `剩余量: ${data.capacity}${data.unitName}` }}</Tag>
            <!-- <Tag>{{ data.locationPath }}</Tag>
            <Tag>{{ data.location }}</Tag> -->
          </Space>
        </template>
        <template #label="{ data }">
          <Space>
            <Tag>{{ data.productName }}</Tag>
            <Tag v-if="actionType === MaterialTypeEnum.ENTITY">{{ `剩余量: ${data.capacity}${data.unitName}` }}</Tag>
            <!-- <Tag>{{ data.locationPath }}</Tag>
            <Tag>{{ data.location }}</Tag> -->
          </Space>
        </template>
      </Select>
    </Space>
  </div>
</template>
<script setup lang="ts">
  import { Select, Space, Tag } from '@arco-design/web-vue'
  import { getAssignedProjectSampleList, queryInventoryGoods } from '@/api/material'
  import { computed, reactive, ref } from 'vue'
  import type { Entity } from './EntityParam'
  import { MaterialTypeEnum } from '@/common/enum'
  import { useState } from '@/hooks'
  import { searchProductInfoList, searchBatchInfoList } from '@/api/material'
  import { arrayToSingleValue } from '@/util'

  const Props = withDefaults(
    defineProps<{
      datas: Array<Entity>
      referenceId?: string
      customParams?: object
      isLimit?: boolean
    }>(),
    {
      isLimit: false
    }
  )

  const Emits = defineEmits<{
    (e: 'update:datas', datas: Entity | undefined): void
  }>()

  defineExpose({
    setSelected: (_selectedRows: Entity) => {
      console.log(_selectedRows)

      selectedRows.value = _selectedRows
      selectedRowKeys.value = _selectedRows[0]?.referenceEntityId
    }
  })

  const DivRef = ref<HTMLElement>()

  /**
   * @todo
   */
  const initParams = computed(() => {
    return {
      ...(Props.customParams
        ? Props.customParams
        : { pageNum: 1, pageSize: 10000, filter: { statusIds: ['2'], goodsId: Props?.referenceId } })
    }
  })

  const list = ref<Array<InventoryGood>>([])

  const selectedRowKeys = ref<string>(
    Array.isArray(Props.datas) && Props.datas.length ? Props.datas[0]?.referenceEntityId : ''
  )
  const selectedRows = ref<Entity | undefined>(Props.datas?.length ? Props.datas[0] : undefined)

  const typeOptions = reactive([
    { label: '产品', value: MaterialTypeEnum.PRODUCT },
    { label: '批次', value: MaterialTypeEnum.PRODUCT_BATCH },
    { label: '实物', value: MaterialTypeEnum.ENTITY }
  ])

  const OptionTypes = [MaterialTypeEnum.PRODUCT, MaterialTypeEnum.PRODUCT_BATCH, MaterialTypeEnum.ENTITY] as const
  const actionType = ref<Extract<MaterialTypeEnum, typeof OptionTypes[number]>>(
    (arrayToSingleValue(Props.datas)?.referenceSource as any) ?? MaterialTypeEnum.ENTITY
  )

  const productList = ref<Array<any>>([])
  const batchList = ref<Array<any>>([])

  const options = computed(() => {
    if (actionType.value === MaterialTypeEnum.PRODUCT) {
      return productList.value
    }
    if (actionType.value === MaterialTypeEnum.PRODUCT_BATCH) {
      return batchList.value
    }
    return list.value
  })

  const changeActionType = () => {
    selectedRows.value = undefined
    selectedRowKeys.value = ''
    Emits('update:datas', selectedRows.value)
  }

  /**
   * 改变选择框
   */
  const handleChange = (value: string | any) => {
    const target = options.value.find((item) => item.id === value)
    if (target) {
      selectedRows.value = {
        referenceEntityId: target.id,
        usageCapacity: target.capacity,
        referenceEntityName: target.productName,
        referenceSource: actionType.value,
        // usageType: ReferenceEntityItemUsageTypeEnum.PART,
        unitName: target.unitName as string
      } as any
    }
    Emits('update:datas', selectedRows.value)
  }

  const [loading, setLoading] = useState<boolean>(false)
  const targetApi = computed(() => (Props.isLimit ? getAssignedProjectSampleList : queryInventoryGoods))

  const _queryInventoryGoods = async () => {
    const { data } = await targetApi.value?.(initParams.value)
    list.value = data
  }

  const _searchProductInfoList = async () => {
    // setLoading(true)
    const { data } = await searchProductInfoList({ pageNum: 1, pageSize: 10000, filter: {} } as any)
    productList.value = data
  }

  const _searchBatchInfoList = async () => {
    const { data } = await searchBatchInfoList({ pageNum: 1, pageSize: 10000, filter: {} } as any)
    batchList.value = data
  }

  const getData = async () => {
    setLoading(true)
    await Promise.all([_queryInventoryGoods(), _searchProductInfoList(), _searchBatchInfoList()]).finally(() => {
      setLoading(false)
    })
  }

  getData()
</script>

<style scoped lang="scss"></style>

```

## 相互监听emit与on(App.vue)

用provide与inject与mitt代码库实现App.vue下的各个组件通信事件

mitts.ts

```ts
import { InjectionKey } from 'vue'
import { Emitter } from 'mitt'

export type IGlobalEventBusInjectionKey = {
  REFRESH_NOTE_MENU: undefined
  REFRESH_NOTE_CHILDREN_TABLE: undefined
  REFRESH_STORAGE_MANAGEMENT: undefined
}

export type TGlobalEventBusInjectionKey = Emitter<IGlobalEventBusInjectionKey>

export const GlobalEventBusInjectionKey = Symbol() as InjectionKey<TGlobalEventBusInjectionKey>

```

App.vue

```vue
<script setup lang="ts">  
import { GlobalEventBusInjectionKey, IGlobalEventBusInjectionKey } from './mitts'
import mitt from 'mitt'
import { provide} from 'vue'

 const GlobalEventBus = mitt<IGlobalEventBusInjectionKey>()
provide(GlobalEventBusInjectionKey, GlobalEventBus)
</script>


```

使用.vue

```js
 import {  inject } from 'vue'
 import { GlobalEventBusInjectionKey, TGlobalEventBusInjectionKey } from '@/mitts'
 const GlobalEventBus = inject(GlobalEventBusInjectionKey) as TGlobalEventBusInjectionKey
 
   /**
   * 刷新
   */
  const refreshData = () => {
    GlobalEventBus.emit('REFRESH_STORAGE_MANAGEMENT')
  }
  
  //此时另一个vue文件里面接收
   GlobalEventBus.on('REFRESH_STORAGE_MANAGEMENT', async () => {
    await refreshStorageManageTree()
  })
 
```

## input输入框的合成事件

**输入框需要限制出现的字符，比如只能是数字。**

```tsx
export const useMultiDecimalKeyup = () => {
  const DecimalRef = ref<InstanceType<typeof InputTag> | null>(null)
  const lock = ref<boolean>(false)

  const handleCompositionstart = () => {
    lock.value = true
  }

  const handleCompositionend = () => {
    lock.value = false
  }

  const element = ref<HTMLInputElement | null>(null)

  onMounted(() => {
    const unwatch = watch(
      () => DecimalRef.value,
      (newRef) => {
        if (newRef) {
          element.value = newRef.$el.querySelector('.arco-input-tag-input')
          element.value?.addEventListener('compositionstart', handleCompositionstart)
          element.value?.addEventListener('compositionend', handleCompositionend)
          unwatch()
        }
      },
      {
        immediate: true
      }
    )
  })

  onUnmounted(() => {
    element.value?.removeEventListener('compositionstart', handleCompositionstart)
    element.value?.removeEventListener('compositionend', handleCompositionend)
    element.value = null
  })

  return {
    DecimalRef,
    keyupNative: (e) => {
      setTimeout(() => {
        if (!lock.value) {
          e.target.value = e.target.value.replace(/^\D*(\d*(?:\.\d*)?).*$/g, '$1')
        }
      })
    }
  }
}
```

## icon图标可以用svg配置vite+vue3

vite.config.ts

```ts
import { createSvgIconsPlugin } from 'vite-plugin-svg-icons' 

plugins: [
      createSvgIconsPlugin({
        iconDirs: [path.resolve(process.cwd(), 'src/icons/svg')],
        symbolId: 'icon-[dir]-[name]'
      }),
      veauryVitePlugins({
        type: 'vue'
      })
    ],
```

SvgIcon.vue

```vue
<template>
  <svg
    :class="['svg-icon', $attrs.class]"
    :style="{
      width: width ? width + 'px' : iconSize + 'px',
      height: height ? height + 'px' : iconSize + 'px'
    }"
    aria-hidden="true"
  >
    <use :xlink:href="'#icon-' + iconName" :fill="color" />
  </svg>
</template>

<script setup lang="ts">
  const {
    iconName,
    color = '',
    iconSize = 24,
    height = 0,
    width = 0
  } = defineProps<{ iconName: string; color?: string; iconSize?: number | string; height?: number; width?: number }>()
</script>

<style scope>
  .svg-icon {
    fill: currentColor;
    vertical-align: middle;
    overflow: hidden;
  }
</style>

```

可以自定义配置icon图标

## 易兰笔记中发起请求axios配置

request/index.ts  ------配置发起请求类

```ts
import axios, { AxiosRequestConfig, AxiosResponse } from 'axios'
import Modal from '@/components/Modal'
import i18n from '@/locale'
import Message from '@/components/Message'
import type { AxiosInstance } from 'axios'
import type { BMYRequestInterceptors, BMYRequestConfig, CancelRequestSource } from './type'
// import { localCache } from '@/util'
import { ExitOutSystem } from '@/util/out-stystem'
import { INFO_DELAYED_CODE } from '@/common/constant'

const INFO_DELAYED = '您的信息已过时，请刷新界面后操作'

class Request {
  instance: AxiosInstance
  interceptors?: BMYRequestInterceptors

  /**
   * 存放取消方法的集合
   * 在创建请求后将取消请求方法 push 到该集合中
   * 封装一个方法，可以取消请求，传入 url: string|string[]
   * 在请求之前判断同一URL是否存在，如果存在就取消请求
   */
  cancelRequestSourceList: CancelRequestSource[] = []

  /**
   * 请求之前需要将url push到该集合中
   * 请求完毕后将url从集合中删除
   * 添加在发送请求之前完成，删除在响应之后删除
   */
  requestUrlList: string[] = []

  constructor(config: BMYRequestConfig) {
    // 创建 axios 实例
    this.instance = axios.create(config)

    // 保存基本信息
    this.interceptors = config.interceptors

    // 全局请求拦截
    this.instance.interceptors.request.use(
      (res: AxiosRequestConfig) => {
        return res
      },
      (err: any) => err
    )

    // 拦截器
    this.instance.interceptors.request.use(
      this.interceptors?.requestInterceptor,
      this.interceptors?.requestInterceptorCatch
    )
    this.instance.interceptors.response.use(
      this.interceptors?.responseInterceptor,
      this.interceptors?.responseInterceptorCatch
    )

    // 全局响应拦截器保证最后执行
    this.instance.interceptors.response.use(
      // 因为我们接口的数据都在res.data下，所以我们直接返回res.data
      (res: AxiosResponse) => {
        // 444 状态码用于用户密码重置
        if (
          res?.data?.code == 200 ||
          (res as any)?.response?.status == 444 ||
          (res.status == 200 && res?.data?.code === undefined)
        ) {
          //res.status == 200 && res?.data === undefined 这个判断条件为了兼容下载接口，下载接口没有res.data，无法做错误判断
          if (res?.headers?.['content-disposition']) return res
          return (res as any)?.response?.status == 444 ? (res as any)?.response?.data : res.data
        } else if ((res as any).code === 'ERR_CANCELED') {
          return Promise.reject('ERR_CANCELED')
        } else if ((res as any)?.response?.data?.status === 401) {
          ExitOutSystem()
          Modal({
            closable: false,
            type: 'error',
            titleAlign: 'start',
            title: i18n.global.t('service.resuest.warning'),
            simple: false,
            content: i18n.global.t('service.resuest.warningTipInfo'),
            maskClosable: false,
            onOk: () => {
              location.href = `${location.protocol}//${location.host}/`
            }
          })
          return Promise.reject('需要重新登录')
        } else {
          let msg = (res as any)?.data?.message || (res as any)?.response?.data?.message
          if (res.config.responseType == 'blob') {
            const data = (res as any)?.response?.data
            if (data) {
              const fileReader = new FileReader()
              fileReader.readAsText(data)
              fileReader.onload = function (result) {
                const jsondata = JSON.parse(result.target.result)
                msg = jsondata?.message
                Message({
                  content: msg,
                  duration: 2 * 1000,
                  type: 'warning'
                })
              }
            }
          } else {
            const { noShowDelayedMsg } = res.config as BMYRequestConfig
            if (msg === INFO_DELAYED && noShowDelayedMsg) {
              return Promise.reject({
                code: INFO_DELAYED_CODE,
                msg: msg
              })
            }
            Message({
              content: msg,
              duration: 2 * 1000,
              type: 'warning'
            })
          }
          return Promise.reject('错误')
        }
      },
      (err: any) => {
        return err
      }
    )
  }

  // index.ts
  /**
   * @description: 获取指定 url 在 cancelRequestSourceList 中的索引
   * @param {string} url
   * @returns {number} 索引位置
   */
  private getSourceIndex(url: string): number {
    return this.cancelRequestSourceList?.findIndex((item: CancelRequestSource) => {
      return Object.keys(item)[0] === url
    }) as number
  }

  /**
   * @description: 删除 requestUrlList 和 cancelRequestSourceList
   * @param {string} url
   * @returns {*}
   */
  private delUrl(url: string) {
    const urlIndex = this.requestUrlList?.findIndex((u) => u === url)
    const sourceIndex = this.getSourceIndex(url)
    // 删除url和cancel方法
    urlIndex !== -1 && this.requestUrlList?.splice(urlIndex as number, 1)
    sourceIndex !== -1 && this.cancelRequestSourceList?.splice(sourceIndex as number, 1)
  }

  // 取消全部请求
  cancelAllRequest() {
    this.cancelRequestSourceList?.forEach((source) => {
      const key = Object.keys(source)[0]
      source[key]()
    })
  }

  // 取消请求
  cancelRequest(url: string[] | string) {
    if (typeof url === 'string') {
      // 取消单个请求
      const sourceIndex = this.getSourceIndex(url)
      sourceIndex >= 0 && this.cancelRequestSourceList?.[sourceIndex][url]()
    } else {
      // 存在多个需要取消请求的地址
      url.forEach((u) => {
        const sourceIndex = this.getSourceIndex(u)
        sourceIndex >= 0 && this.cancelRequestSourceList?.[sourceIndex][u]()
      })
    }
  }

  request<T>(config: BMYRequestConfig): Promise<T> {
    return new Promise((resolve, reject) => {
      // 如果我们为单个请求设置拦截器，这里使用单个请求的拦截器
      if (config.interceptors?.requestInterceptor) {
        config = config.interceptors.requestInterceptor(config)
      }
      const { url, noCancel } = config
      if (url) {
        // 取消多余的请求
        !noCancel && this.cancelRequest(url)
        this.requestUrlList?.push(url)
        config.cancelToken = new axios.CancelToken((c) => {
          this.cancelRequestSourceList?.push({
            [url]: () => {
              // console.log(c, c())
              c()
              return Promise.reject(url)
            }
          })
        })
      }
      this.instance
        .request<any, T>(config)
        .then((res) => {
          // 如果我们为单个响应设置拦截器，这里使用单个响应的拦截器
          if (config.interceptors?.responseInterceptor) {
            res = config.interceptors.responseInterceptor<T>(res)
          }

          resolve(res)
        })
        .catch((err: any) => {
          reject(err)
          // return err
        })
        .finally(() => {
          url && this.delUrl(url)
        })
    })
  }

  get<T = any>(config: BMYRequestConfig): Promise<T> {
    return this.request<T>({ ...config, method: 'GET' })
  }

  post<T = any>(config: BMYRequestConfig): Promise<T> {
    return this.request<T>({ ...config, method: 'POST' })
  }

  delete<T = any>(config: BMYRequestConfig): Promise<T> {
    return this.request<T>({ ...config, method: 'DELETE' })
  }

  put<T = any>(config: BMYRequestConfig): Promise<T> {
    return this.request<T>({ ...config, method: 'PUT' })
  }
}

export default Request

```

service/index ------ 生成实例

```ts
import Request from './request'
import { localCache } from '@/util'
import type { BMYRequestInterceptors } from './request/type'
import { hyswTestRequestUrl } from '@/assets/js/hyUrl'

const interceptors: BMYRequestInterceptors = {
  requestInterceptor: (config) => {
    const token = localCache.getCache('token')
    if (token) {
      config!.headers!.Authorization = `Bearer ${token}`
    }
    return config
  },
  requestInterceptorCatch: (err) => {
    return err
  },
  responseInterceptor: (res) => {
    return res
  },
  responseInterceptorCatch: (err) => {
    return err
  }
}

const baseConfig = {
  timeout: 1000 * 60 * 5,
  interceptors
}

export const sysRequest = new Request({
  ...baseConfig,
  baseURL: '/systemcenter/api/banmayu'
})

export const webRequest = new Request({
  ...baseConfig,
  baseURL: '/elabnoteWeb/api/banmayu'
})

export const materialRequest = new Request({
  ...baseConfig,
  baseURL: '/material/api/banmayu'
})

export const processRequest = new Request({
  ...baseConfig,
  baseURL: '/process'
})

export const baseRequest = new Request({
  ...baseConfig,
  baseURL: ''
})

// 暂时未使用后端包裹
export const hyswTestRequest = new Request({
  ...baseConfig,
  baseURL: `${hyswTestRequestUrl}/hysw_test/rest`
})

type CancelRequest = {
  url: string[] | string
  request: InstanceType<typeof Request>
}
// 取消请求
export const cancelRequest = ({ url, request }: CancelRequest) => {
  return request.cancelRequest(url)
}
// 取消全部请求
export const cancelAllRequest = (request: InstanceType<typeof Request>) => {
  return request.cancelAllRequest()
}

```

使用

```ts
import { webRequest } from '@/service'

/**
 * 下载文件
 * @param data
 * @returns
 */
export const getFile = (params: { fileUrl: string }) => {
  return webRequest.get({
    url: '/fileTransfer/download',
    params,
    responseType: 'blob',
    noCancel: true
  })
}
```

## 打包到后台多加路由字段处理

 在做新项目百问百搭时候因为后端服务器端口以及被占用了，所以首页不能直接放我们的新页面，所以后端会多加一个路由faqvue,如:

http://192.168.0.4/faqvue

这时候我们就也要在打包的时候多在vite.config.ts里面publicDir属性里面做操作，目的为打包后服务器能找到我们现在的静态资源

vite.config.ts

```ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import vueJsx from '@vitejs/plugin-vue-jsx'

// https://vitejs.dev/config/
export default defineConfig({
  resolve: {
    alias: {
      '@': '/src'
    },
    extensions: ['.mjs', '.js', 'jsx', '.ts', '.tsx', '.json']
  },
  publicDir: 'faqvue',
  plugins: [vue(), vueJsx()],
  server: {
    port: 9011,
    open: true,
    proxy: {
      '/faq/api': {
        target: `http://192.168.0.4`,
        changeOrigin: true,
        secure: false
      }
    }
  }
})
```

## 打包项目到二级目录下

调整vite.config.ts添加base

这样打包到线上防止丢失文件

```ts

export default defineConfig({
  base: 'faqvue',
  }
})

```

配置router路由

创建路由路由要多带一个参数

```ts
import { createRouter, createWebHistory } from 'vue-router'
import Login from './modules/login'
import appRoutes from './modules'
// import Cookie from 'js-cookie'

const router = createRouter({
  history: createWebHistory('/faqvue'),
  routes: [
    {
      path: '/',
      redirect: 'main' //百问百答主页面
    },
    Login,
    {
      name: 'main',
      path: '/main',
      redirect: { name: 'interlocution' },
      component: () => import('@/layout/index.vue'),
      children: appRoutes
    },
    {
      path: '/:pathMatch(.*)*',
      name: 'notFound',
      component: () => import('@/views/not-found/index.vue')
    }
  ],
  scrollBehavior() {
    return { top: 0 }
  }
})

export default router

```

如果有刷新页面白屏或者报错问题，就可用先用hash模式创建解决



## 懒加载引用文件(defineAsyncComponent)

utils.ts

```ts

/**
 * 动态组件
 */
export const ComponentInfo = Object.freeze({
  [ParameterType.OPTIONAL]: defineAsyncComponent(() => import('../components/SimpleSelect.vue')),
  [ParameterType.MULTI_OPTIONAL]: defineAsyncComponent(() => import('../components/SimpleSelect.vue'))
})

```

懒加载引用文件，可以进行组件化modules模式

## Object中的属性与undefined关系

Object中的获取虽然有默认值，但他跟udefined其实有一点区别，

```js
{}
与
{
    key: undefiend
}
```

1. 虽然二者key值被引用时都默认取值为undefiend,但两者长度并不一样，其实内容值概念也有些差别，对象方法取值得出来的结果也不一样
2. 如果想让真正的数组里删除某一个属性值不能直接赋值为undefined，需要使用delete关键字删除
3. 如果是普通的用法为取值的时候二者没有任何区别
4. 两者传入后端的时候结构化的值并没有不同，项josn.stringfy()时，也没有不同

## 使用onClickOutside碰到选择项问题

 import { onClickOutside } from '@vueuse/core'

问题描述



这是一个可能无法避免的当编辑表格单元格内出现展示与编辑两种状态，这时候会引用onClickOutSide这个vue钩子，当为组件可能为有另外浮动框时，比如下拉选择，就会出现，点击选择编辑状态消失，这时候，需要改变挂载点，挂载结束会出现新问题，比如，浮动窗会消失因为样式问题，且移动部位不确定，所以以下就写了一个钩子改变

解决钩子

注意组件样式调整也同样重要

```ts
export interface IPositonByElementWH {
  width?: number
  height?: number
  elementHeight?: number
  ElementRef: Ref<HTMLElement | undefined>
  elementType?: ElementType
}

export const usePositionByElementWH = (params: IPositonByElementWH) => {
  const { width, height, elementHeight, ElementRef } = constructorParams(params)
  const { width: w, height: h } = useWindowSize()
  const positionInfo = useDynamicPopPosition(ElementRef)

  const computedPosition = computed(() => {
    const wfix = w.value - positionInfo.l
    const left = w.value - positionInfo.l > width ? positionInfo.l : positionInfo.l - width + wfix
    const top = h.value - positionInfo.t > height ? positionInfo.t : positionInfo.t - (height + elementHeight)
    return { top: `${top}px`, left: `${left}px` }
  })

  return {
    computedPosition
  }
}

```

使用use ， Comselect.vue

```vue
<template>
  <SwitchEditModeCom :edit-ref="EditRef!" :disabled="disabled" v-model:isChange="isChange" ref="SwitchEditModeComRef">
    <!--:allow-create="allowCreate" -->
    <template #default="{ isEditMode }">
      <div ref="EditRef" v-if="isEditMode" class="edit-space">
        <a-space :style="{ width: '100%' }">
          <a-select
            placeholder="请选择..."
            v-model="_defaultValue"
            :multiple="isMultiple"
            :disabled="disabled"
            @change="handleChange"
            allow-clear
            size="mini"
            :popup-container="EditRef"
            :style="{ minWidth: '80px' }"
          >
            <a-option v-for="option in columnInfo.options" :key="option" :value="option">{{ option }}</a-option>
          </a-select>
          <icon-check class="pointer" :style="{ color: '#3358FF' }" @click.stop="checkOk" />
        </a-space>
      </div>
      <div v-else>
        <a-space v-if="isMultiple">
          <div v-if="isEmpty(defaultValue)"></div>
          <div v-else>
            <a-tag v-for="(value, index) in defaultValue" :key="index" size="small">{{ value ?? '' }}</a-tag>
          </div>
        </a-space>
        <div v-else>{{ defaultValue?.[0] ?? '' }}</div>
      </div>
    </template>
  </SwitchEditModeCom>
</template>

<script setup lang="ts">
  import { ref, watch } from 'vue'
  import { ColmunsInfoData, ColumnsItemData } from '../utils'
  import SwitchEditModeCom from '@/views/sg-management/sg-summary/component/DynamicComShow/components/SwitchEditModeCom.vue'
  import { isEmpty } from 'lodash'
  import { usePositionByElementWH } from '@/hooks'
  // import { systemYesNoEnumToBoolean } from '@/util'
  const Props = defineProps<{
    defaultValue: string[]
    isMultiple?: boolean
    disabled: boolean
    cellInfo: ColumnsItemData
    columnInfo: ColmunsInfoData
  }>()
  const SwitchEditModeComRef = ref<InstanceType<typeof SwitchEditModeCom>>()
  const _defaultValue = ref<any>()
  const EditRef = ref<HTMLElement>()

  const isChange = ref<boolean>(false)

  const Emit = defineEmits<{
    (e: 'changeValue', values: any[]): void
  }>()

  const { computedPosition } = usePositionByElementWH({
    ElementRef: EditRef,
    width: 156,
    height: 200,
    elementHeight: 35
  })

  const checkOk = () => {
    // 给复杂数据内部数据变成string
    Emit('changeValue', _defaultValue.value)
    SwitchEditModeComRef.value?.setEditMode(false)
  }

  const handleChange = (e) => {
    isChange.value = true
    let newVal
    if (e) {
      newVal = Array.isArray(e) ? e : [e]
    } else {
      newVal = []
    }
    // Emit('changeValue', newVal)
    _defaultValue.value = newVal
  }

  watch(
    EditRef,
    () => {
      if (EditRef.value) {
        if (Props.isMultiple) {
          _defaultValue.value = Props.defaultValue
        } else {
          const [val] = Props.defaultValue
          _defaultValue.value = val
        }
      }
    },
    {
      immediate: true
    }
  )
</script>

<style scoped lang="scss">
  .edit-space {
    width: 100%;
    :deep(.arco-space-item):nth-child(1) {
      width: calc(100% - 30px);
    }
    :deep(.arco-trigger-popup) {
      position: fixed;
      top: v-bind('computedPosition.top') !important;
      left: v-bind('computedPosition.left') !important;
      transform: translateY(30px);
    }
  }
</style>

```



SwitchEditModeCom.vue(公共组件)

```vue
<template>
  <div ref="EditRootRef">
    <slot name="isMultiple"> </slot>
    <slot v-bind="{ isEditMode }"></slot>
  </div>
</template>

<script setup lang="ts">
  import { onClickOutside } from '@vueuse/core'
  import { nextTick, onMounted, ref, computed } from 'vue'

  const Props = withDefaults(
    defineProps<{
      editRef: HTMLElement
      disabled: boolean
      isChange?: boolean
    }>(),
    { disabled: false }
  )

  const EditRef = computed(() => {
    return Props.editRef
  })

  const Emits = defineEmits<{
    (e: 'update:isChange', isChange: boolean): void
  }>()

  const isEditMode = ref<boolean>(false)
  const EditRootRef = ref<HTMLElement>()
  onMounted(() => {
    const tableTd = EditRootRef.value?.closest('.arco-table-td')
    tableTd?.addEventListener('click', (e) => {
      e.stopPropagation()
      if (Props.disabled) return
      isEditMode.value = true
      nextTick(() => {
        if (EditRef.value?.focus) {
          EditRef.value?.focus()
        }
      })
    })
  })

  onClickOutside(EditRef, () => {
    setTimeout(() => {
      if (Props.isChange !== undefined) {
        if (Props.isChange) {
          Emits('update:isChange', false)
        } else {
          isEditMode.value = false
        }
      } else {
        isEditMode.value = false
      }
    })
  })

  defineExpose({
    setEditMode: (value) => {
      isEditMode.value = value
    }
  })
</script>

<style scoped lang="scss"></style>

```

## 使用默认父组件特性传给子组件根元素

因为vue底层原因，他会不停的把父组件上的默认属性传递给子组件内部的根据元素上，而且会一层一层往下传，切不止是style与class样式属性，各种属性都会传

那么当我们可以通过设置子组件内部接收props方式，去截取父组件这种行为，因为vue是这么设计的，通过props去截取可能对子组件根据造成的透传问题，比如title属性

## vite-vue3中图片绝对地址引用

因为静态地址用img使用变量引用@标识符，不是src上可以识别的属性标示，代表他不可以被编辑，所有需要使用一些特殊手段来获取

url: 图片文件名称

index.ts

```ts
export const getImageUrl = (url: string) => {
  // 获取assets静态资源
  const path = `../../assets/images/${url}`
  const modules = import.meta.glob('../../assets/images/*', { eager: true, import: 'default' })
  return modules[path]

  // return new URL(url.replace('@', '../../../src'), import.meta.url).href
}

export const getPdfUrl = (url: string) => {
  // 获取assets静态资源
  const path = `../../assets/pdf/${url}`
  const modules = import.meta.glob('../../assets/pdf/*', { eager: true, import: 'default' })
  return modules[path]

  // return new URL(url.replace('@', '../../../src'), import.meta.url).href
}

```

## axios理解delete、get、post、update

* 一般get传参是不能进行data参数传值，他作为暴露的最简单形式的传参，只能对于param与冒号传参两种形式
* 像delete与post、update可以进行data的json格式传参，此属于保密传参，但其中也可以进行param与冒号传参两种形式
* 其中param传参就是问好传参，只能传最基本上属性的格式

```ts

/**
 * 设置编辑指标data
 */
export function editInficator(ids: string[]) {
  return webRequest.post({
    url: '/indicator/update',
    data: ids
  })
}
/**
 * 设置指标解绑param
 */
export function unlinklInficator(ids: string[]) {
  return webRequest.delete({
    url: '/indicator/indicator/unlink',
    params: ids
  })
}

```

## flex布局之约束弹性flex: 1

弹性布局flex为1的时候可能会出现，无法限制死高度大小限制，解决办法也有很多种，不设置flex： 1,写死高度；

但好用的办法是把高度另外写死为0成为约束弹性
